"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(a,b,c,d,f){var g=a;g.iteration=1,g.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],g.documents=[],g.finished=!1,g.text="",g.sentences=[],g.highlight=[],g.units=[],g.init=function(){g.getSesInfo()},g.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(h){g.iteration=h.iteration,g.myUid=h.uid,g.sesName=h.name,g.sesId=h.id,g.sesDescr=h.descr,g.sesSTime=null==h.stime?null:new Date(h.stime),g.getDocuments(),b({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(j){j.finished&&(g.finished=!0)})})},g.selectDocument=function(h){g.selectedDocument==h||(g.selectedDocument=h,g.text=g.documents[h].content,g.text=g.text.replace(/.[ ]+\n/,".\n"),g.sentences=g.text.match(/[^.!?\n]+[.!?\n]+/g)||[],g.highlight=Array.from(g.sentences.length,function(){return!1}))},g.countHightlight=function(){return g.highlight.reduce(function(h,j){return j?h+1:h},0)},g.getDocuments=function(){b({method:"post",url:"get-semantic-documents"}).success(function(h){g.documents=h,0<g.documents.length&&(g.selectDocument(0),g.getUnits())})},g.getUnits=function(){b({method:"post",url:"get-semantic-units"}).success(function(h){g.units=h})},g.getHgSents=function(){return g.highlight.map(function(h,j){return{st:j,b:h}}).filter(function(h){return h.b}).map(function(h){return h.st})},g.addSemUnit=function(h){var j={comment:h.comment,sentences:g.getHgSents(),docid:h.docid};b({method:"post",url:"add-semantic-unit",data:j}).success(function(){g.getUnits()})},g.addEmptyUnit=function(){g.units.push({comment:"",sentences:g.getHgSents(),status:"unsaved",docid:g.documents[g.selectedDocument].id})},g.finishState=function(){if(!g.finished){if(g.units.length-1<g.documents.length)return void f.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!g.areAllUnitsSync())return void f.error("Hay unidades sem\xE1nticas que no han sido enviadas");var h=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(h){var j={status:g.iteration+2};b({url:"record-finish",method:"post",data:j}).success(function(){g.hasFinished=!0,g.finished=!0,console.log("FINISH")})}}},g.areAllUnitsSync=function(){for(var j,h=0;h<g.units.length;h++)if(j=g.units[h],"unsaved"==j.status||"dirty"==j.status)return!1;return!0},g.init()}]);
