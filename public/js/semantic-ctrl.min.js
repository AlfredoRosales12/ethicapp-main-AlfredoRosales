"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(a,f,b,c,h){var j=a;j.iteration=0,j.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:6,name:"Evaluaci\xF3n de Pares"},{i:7,name:"Finalizada"}],j.documents=[],j.finished=!1,j.text="",j.sentences=[],j.highlight=[],j.disabledSents=[],j.originalTexts=[],j.originalSentences=[],j.sent={},j.writingReport=!1,j.followLeader=!1,j.leader=!1,j.writingReport=!1,j.views={},j.units=[],j.unitsIter1=[],j.unitsIter3=[],j.shared={},j.teamNames={},j.editing=-1,j.hgDocs={},j.misc={},j.init=function(){c.on("stateChange",function(a){console.log("SOCKET.IO",a),a.ses==j.sesId&&window.location.reload()}),c.on("updateTeam",function(a){j.teamId==a.tmid&&(!j.leader&&j.getUnits(),j.getTeamInfo())}),j.getSesInfo(),j.getUserInfo()},j.getSesInfo=function(){f({url:"get-ses-info",method:"post"}).success(function(a){j.iteration=a.iteration,j.myUid=a.uid,0<j.iteration&&2==j.myUid&&(j.iteration=1),j.sesName=a.name,j.sesId=a.id,a.descr&&(j.sesDescr=4>j.iteration?a.descr.split("\n")[0]||a.descr:a.descr.split("\n")[1]||a.descr),j.sesSTime=null==a.stime?null:new Date(a.stime),j.getDocuments(),3==j.iteration&&j.getTeamInfo(),3<=j.iteration&&j.getSimpleTeamInfo(),4==j.iteration&&(j.writingReport=!0),5<=j.iteration&&(j.finished=!0),6==j.iteration&&window.location.replace("rubrica"),f({url:"get-finished",method:"post",data:{status:j.iteration+2}}).success(function(a){a.finished&&(j.finished=!0)})})},j.getUserInfo=function(){f.post("get-my-name").success(function(a){j.myName=a.name,j.myRole=a.role})},j.selectDocument=function(a){j.selectedDocument==a||(j.selectedDocument=a,j.text=j.originalTexts[a],j.sentences=j.originalSentences[a])},j.countHighlight=function(){//console.log(self.highlight);
return null!=j.highlight&&j.highlight.reduce(function(b,c){return b.concat(c)},[]).reduce(function(c,a){return a?c+1:c},0)},j.getDocuments=function(){f({method:"post",url:"get-semantic-documents"}).success(function(a){j.documents=a,0<j.documents.length&&(j.processDocuments(),j.selectDocument(0),j.getUnits())})},j.processDocuments=function(){j.highlight=[],j.disabledSents=[],j.originalTexts=[],j.originalSentences=[];for(var a,b=0;b<j.documents.length;b++)a=j.documents[b].content,j.originalTexts.push(a.replace(/.[ ]+\n/,".\n")),j.originalSentences.push(j.originalTexts[b].match(/[^.!?\n]+[.!?\n]+/g)||[]),j.highlight.push(Array.from({length:j.originalSentences[b].length},function(){return!1})),j.disabledSents.push(Array.from({length:j.originalSentences[b].length},function(){return!1}));console.log(j.originalSentences)},j.clearDisabledSents=function(){if(j.disabledSents)for(var a=0;a<j.disabledSents.length;a++)for(var b=0;b<j.disabledSents[a].length;b++)j.disabledSents[a][b]=!1},j.processUnits=function(){j.clearDisabledSents();for(var b=0;b<j.units.length;b++)for(var c=0;c<j.units[b].sentences.length;c++){var g=j.units[b].docs[c],f=j.units[b].sentences[c];j.disabledSents[g][f]=!0}console.table(j.disabledSents)},j.getUnits=function(){var a=3==j.iteration?"get-team-sync-units":"get-semantic-units";f({method:"post",url:a,data:{iteration:j.iteration}}).success(function(a){j.units=a,j.processUnits()}),1<j.iteration&&f({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(a){j.unitsIter1=a}),3<j.iteration&&f({method:"post",url:"get-team-sync-units",data:{iteration:3}}).success(function(a){j.unitsIter3=a})},j.getHgSents=function(){return j.highlight.map(function(b){return b.map(function(c,a){return[c,a]}).filter(function(a){return a[0]}).map(function(a){return a[1]})}).reduce(function(c,a){return c.concat(a)},[])},j.getHgDocs=function(){return j.highlight.map(function(c,b){return c.map(function(c,a){return[c,a]}).filter(function(a){return a[0]}).map(function(){return b})}).reduce(function(c,a){return c.concat(a)},[])},j.addSemUnit=function(d){if(3!=j.iteration||j.leader){if(d.edit&&j.toggleEdit(-1,d),3==j.iteration&&(null==d.comment||0==d.comment.length))return void h.error("Debe ingresar un comentario.");var a=3==j.iteration?"add-sync-semantic-unit":"add-semantic-unit";null!=d.id&&(a="update-semantic-unit");var e={id:d.id,comment:d.comment,sentences:d.sentences,docs:d.docs,iteration:j.iteration,uidoriginal:j.originalLeader};console.log(e),f({method:"post",url:a,data:e}).success(function(a){d.dirty=!1,null==d.id&&(d.id=a.id),j.sent[d.id]=!0,3==j.iteration&&j.updateSignal()})}},j.updateSignal=function(){f({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},j.takeControl=function(){f({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),j.updateSignal()})},j.addEmptyUnit=function(){if(-1!=j.editing)return void h.error("Debe terminar de editar la unidad actual para editar otra.");j.units.push({id:null,comment:"",sentences:j.getHgSents(),status:"unsaved",docs:j.getHgDocs()});//console.log(self.units);
var a=j.units.length-1;j.toggleEdit(a,j.units[a])},j.finishState=function(){if(!j.finished){if(3>=j.iteration){if(0==j.units.length)return void h.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!j.areAllUnitsSync())return void h.error("Hay unidades sem\xE1nticas que no han sido enviadas")}4==j.iteration&&j.shared.sendReport();var b=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(b){var a={status:j.iteration+2};f({url:"record-finish",method:"post",data:a}).success(function(){j.hasFinished=!0,j.finished=!0,console.log("FINISH"),3==j.iteration&&j.updateSignal()})}}},j.areAllUnitsSync=function(){return j.units.every(function(a){return!a.dirty})},j.toggleEdit=function(c,a){return 3!=j.iteration||j.leader?-1==j.editing||a.edit?a.edit&&0==j.countHighlight()?void h.error("Debe seleccionar al menos una unidad sem\xE1ntica"):void(a.edit?(a.sentences=j.getHgSents(),a.docs=j.getHgDocs(),j.fillUnitDisabled(a,!0),a.edit=!1,j.editing=-1,j.unselectAllHighlights()):(a.edit=!0,j.editing=c,j.fillHighlightByUnit(a),j.fillUnitDisabled(a,!1),a.dirty=!0)):void h.error("Debe terminar de editar la unidad actual para editar otra."):void 0},j.fillUnitDisabled=function(a,b){for(var c=0;c<a.sentences.length;c++){var g=a.docs[c],e=a.sentences[c];j.disabledSents[g][e]=b}},j.startView=function(a){j.unitsIter1&&j.unitsIter1.forEach(function(a){a.viewing=!1}),j.unitsIter3&&j.unitsIter3.forEach(function(a){a.viewing=!1}),a.viewing=!0;for(var b=j.selectedDocument,c=1;c<=j.documents.length&&(j.views={},a.sentences.filter(function(b,c){return a.docs[c]==j.selectedDocument}).forEach(function(a){j.views[a]=!0}),angular.equals(j.views,{}));c++)j.selectDocument((b+c)%j.documents.length)},j.stopView=function(a){// console.log("Stop viewing: ", unit.id);
a.viewing=!1,j.views={}},j.fillHighlightByUnit=function(c){j.unselectAllHighlights(),j.hgDocs={};for(var a,d=!0,e=0;e<c.sentences.length;e++){a=c.docs[e],j.hgDocs[a]=!0,d&&(j.selectDocument(a),d=!1);var f=c.sentences[e];j.highlight[a][f]=!0}// console.log(self.highlight);
},j.unselectAllHighlights=function(){j.hgDocs={};for(var a=0;a<j.highlight.length;a++)for(var b=0;b<j.highlight[a].length;b++)j.highlight[a][b]=!1},j.getTeamInfo=function(){f({url:"get-team-leader",method:"post"}).success(function(a){j.teamId=a.id,j.originalLeader=a.original_leader,a.leader==j.myUid?(j.leader=!0,j.followLeader=!1):(j.leader=!1,j.followLeader=!0)}),f({url:"get-team",method:"post"}).success(function(a){j.teamstr=a.map(function(a){return a.name+(a.finished?" \u2713":"")}).join(", ")})},j.getSimpleTeamInfo=function(){f({url:"get-team",method:"post"}).success(function(a){j.teamNames={},a.forEach(function(a){j.teamNames[a.id]=a.name})})},j.deleteUnit=function(c,d){if(d.edit)return void h.error("No puede eliminar una unidad que est\xE1 siendo editada");if(null!=d.id){var e={id:d.id};f({url:"delete-semantic-unit",method:"post",data:e}).success(function(){console.log("Idea deleted"),3==j.iteration&&j.updateSignal()})}for(var b=0;b<d.docs.length;b++){var k=d.docs[b],g=d.sentences[b];j.disabledSents[k][g]=!1}j.units.splice(c,1)},j.init()}]),app.controller("ReportController",["$scope","$http",function(a,e){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var a={content:c.content};e({url:"send-report",method:"post",data:a}).success(function(a){"ok"==a.status&&(c.lastSent=new Date,c.misc.reportDirty=!1)})},c.shared.sendReport=c.sendReport,c.getReport=function(){e({url:"get-my-report",method:"post"}).success(function(a){"ok"==a.status&&(c.content=a.content,c.idReport=a.id)})},c.getReport()}]);var indexById=function(a,c){return a.findIndex(function(a){return a.id==c})};
