"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(a,b,c,d,f){var g=a;g.iteration=1,g.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],g.documents=[],g.finished=!1,g.text="",g.sentences=[],g.highlight=[],g.units=[],g.editing=-1,g.init=function(){g.getSesInfo()},g.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(h){g.iteration=h.iteration,g.myUid=h.uid,g.sesName=h.name,g.sesId=h.id,g.sesDescr=h.descr,g.sesSTime=null==h.stime?null:new Date(h.stime),g.getDocuments(),b({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(j){j.finished&&(g.finished=!0)})})},g.selectDocument=function(h){g.selectedDocument==h||(g.selectedDocument=h,g.text=g.documents[h].content,g.text=g.text.replace(/.[ ]+\n/,".\n"),g.sentences=g.text.match(/[^.!?\n]+[.!?\n]+/g)||[],g.highlight=Array.from({length:g.sentences.length},function(){return!1}))},g.countHightlight=function(){return g.highlight.reduce(function(h,j){return j?h+1:h},0)},g.getDocuments=function(){b({method:"post",url:"get-semantic-documents"}).success(function(h){g.documents=h,0<g.documents.length&&(g.selectDocument(0),g.getUnits())})},g.getUnits=function(){b({method:"post",url:"get-semantic-units"}).success(function(h){g.units=h})},g.getHgSents=function(){return g.highlight.map(function(h,j){return{st:j,b:h}}).filter(function(h){return h.b}).map(function(h){return h.st})},g.addSemUnit=function(h){h.edit&&g.toggleEdit(-1,h);var j="add-semantic-unit";null!=h.id&&(j="update-semantic-unit");var k={id:h.id,comment:h.comment,sentences:h.sentences,docid:h.docid};b({method:"post",url:j,data:k}).success(function(){h.dirty=!1})},g.addEmptyUnit=function(){if(-1!=g.editing)return void f.error("Debe terminar de editar la unidad actual para editar otra.");g.units.push({id:null,comment:"",sentences:g.getHgSents(),status:"unsaved",docid:g.documents[g.selectedDocument].id});var h=g.units.length-1;g.toggleEdit(h,g.unit[h])},g.finishState=function(){if(!g.finished){if(g.units.length-1<g.documents.length)return void f.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!g.areAllUnitsSync())return void f.error("Hay unidades sem\xE1nticas que no han sido enviadas");var h=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(h){var j={status:g.iteration+2};b({url:"record-finish",method:"post",data:j}).success(function(){g.hasFinished=!0,g.finished=!0,console.log("FINISH")})}}},g.areAllUnitsSync=function(){for(var j,h=0;h<g.units.length;h++)if(j=g.units[h],"unsaved"==j.status||"dirty"==j.status)return!1;return!0},g.toggleEdit=function(h,j){return-1==g.editing||j.edit?void(j.edit?(j.sentences=g.getHgSents(),j.edit=!1,g.editing=-1,g.highlight=Array.from({length:g.sentences.length},function(){return!1})):(g.selectDocument(indexById(g.documents,j.docid)),j.edit=!0,g.editing=h,g.highlight=Array.from({length:g.sentences.length},function(k,l){return j.sentences.includes(l)}),j.dirty=!0)):void f.error("Debe terminar de editar la unidad actual para editar otra.")},g.init()}]);var indexById=function(a,b){return a.findIndex(function(c){return c.id==b})};
