"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(a,b,c,d,e){var f=a;f.iteration=0,f.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:6,name:"Evaluaci\xF3n de Pares"},{i:7,name:"Finalizada"}],f.documents=[],f.finished=!1,f.text="",f.sentences=[],f.highlight=[],f.disabledSents=[],f.originalTexts=[],f.originalSentences=[],f.sent={},f.writingReport=!1,f.followLeader=!1,f.leader=!1,f.writingReport=!1,f.views={},f.units=[],f.unitsIter1=[],f.unitsIter3=[],f.shared={},f.teamNames={},f.editing=-1,f.hgDocs={},f.misc={},f.init=function(){d.on("stateChange",function(a){console.log("SOCKET.IO",a),a.ses==f.sesId&&window.location.reload()}),d.on("updateTeam",function(a){f.teamId==a.tmid&&(!f.leader&&f.getUnits(),f.getTeamInfo())}),f.getSesInfo(),f.getUserInfo()},f.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(a){f.iteration=a.iteration,f.myUid=a.uid,0<f.iteration&&2==f.myUid&&(f.iteration=1),f.sesName=a.name,f.sesId=a.id,a.descr&&(f.sesDescr=4>f.iteration?a.descr.split("\n")[0]||a.descr:a.descr.split("\n")[1]||a.descr),f.sesSTime=null==a.stime?null:new Date(a.stime),f.getDocuments(),3==f.iteration&&f.getTeamInfo(),3<=f.iteration&&f.getSimpleTeamInfo(),4==f.iteration&&(f.writingReport=!0),5<=f.iteration&&(f.finished=!0),6==f.iteration&&window.location.replace("rubrica"),b({url:"get-finished",method:"post",data:{status:f.iteration+2}}).success(function(a){a.finished&&(f.finished=!0)})})},f.getUserInfo=function(){b.post("get-my-name").success(function(a){f.myName=a.name,f.myRole=a.role})},f.selectDocument=function(a){f.selectedDocument==a||(f.selectedDocument=a,f.text=f.originalTexts[a],f.sentences=f.originalSentences[a])},f.countHighlight=function(){//console.log(self.highlight);
return null!=f.highlight&&f.highlight.reduce(function(c,a){return c.concat(a)},[]).reduce(function(a,b){return b?a+1:a},0)},f.getDocuments=function(){b({method:"post",url:"get-semantic-documents"}).success(function(a){f.documents=a,0<f.documents.length&&(f.processDocuments(),f.selectDocument(0),f.getUnits())})},f.processDocuments=function(){f.highlight=[],f.disabledSents=[],f.originalTexts=[],f.originalSentences=[];for(var a,b=0;b<f.documents.length;b++)a=f.documents[b].content,f.originalTexts.push(a.replace(/.[ ]+\n/,".\n")),f.originalSentences.push(f.originalTexts[b].match(/[^.!?\n]+[.!?\n]+/g)||[]),f.highlight.push(Array.from({length:f.originalSentences[b].length},function(){return!1})),f.disabledSents.push(Array.from({length:f.originalSentences[b].length},function(){return!1}));console.log(f.originalSentences)},f.clearDisabledSents=function(){if(f.disabledSents)for(var a=0;a<f.disabledSents.length;a++)for(var b=0;b<f.disabledSents[a].length;b++)f.disabledSents[a][b]=!1},f.processUnits=function(){f.clearDisabledSents();for(var c=0;c<f.units.length;c++)for(var d=0;d<f.units[c].sentences.length;d++){var a=f.units[c].docs[d],b=f.units[c].sentences[d];f.disabledSents[a][b]=!0}console.table(f.disabledSents)},f.getUnits=function(){var a=3==f.iteration?"get-team-sync-units":"get-semantic-units";b({method:"post",url:a,data:{iteration:f.iteration}}).success(function(a){f.units=a,f.processUnits()}),1<f.iteration&&b({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(a){f.unitsIter1=a}),3<f.iteration&&b({method:"post",url:"get-team-sync-units",data:{iteration:3}}).success(function(a){f.unitsIter3=a})},f.getHgSents=function(){return f.highlight.map(function(b){return b.map(function(a,b){return[a,b]}).filter(function(a){return a[0]}).map(function(a){return a[1]})}).reduce(function(a,b){return a.concat(b)},[])},f.getHgDocs=function(){return f.highlight.map(function(b,a){return b.map(function(a,b){return[a,b]}).filter(function(a){return a[0]}).map(function(){return a})}).reduce(function(a,b){return a.concat(b)},[])},f.addSemUnit=function(a){if(3!=f.iteration||f.leader){if(a.edit&&f.toggleEdit(-1,a),3==f.iteration&&(null==a.comment||0==a.comment.length))return void e.error("Debe ingresar un comentario.");var c=3==f.iteration?"add-sync-semantic-unit":"add-semantic-unit";null!=a.id&&(c="update-semantic-unit");var d={id:a.id,comment:a.comment,sentences:a.sentences,docs:a.docs,iteration:f.iteration,uidoriginal:f.originalLeader};console.log(d),b({method:"post",url:c,data:d}).success(function(b){a.dirty=!1,null==a.id&&(a.id=b.id),f.sent[a.id]=!0,3==f.iteration&&f.updateSignal()})}},f.updateSignal=function(){b({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},f.takeControl=function(){b({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),f.updateSignal()})},f.addEmptyUnit=function(){if(-1!=f.editing)return void e.error("Debe terminar de editar la unidad actual para editar otra.");f.units.push({id:null,comment:"",sentences:f.getHgSents(),status:"unsaved",docs:f.getHgDocs()});//console.log(self.units);
var a=f.units.length-1;f.toggleEdit(a,f.units[a])},f.finishState=function(){if(!f.finished){if(3>=f.iteration){if(0==f.units.length)return void e.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!f.areAllUnitsSync())return void e.error("Hay unidades sem\xE1nticas que no han sido enviadas")}4==f.iteration&&f.shared.sendReport();var a=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(a){var c={status:f.iteration+2};b({url:"record-finish",method:"post",data:c}).success(function(){f.hasFinished=!0,f.finished=!0,console.log("FINISH"),3==f.iteration&&f.updateSignal()})}}},f.areAllUnitsSync=function(){return f.units.every(function(a){return!a.dirty})},f.toggleEdit=function(a,b){return 3!=f.iteration||f.leader?-1==f.editing||b.edit?b.edit&&0==f.countHighlight()?void e.error("Debe seleccionar al menos una unidad sem\xE1ntica"):void(b.edit?(b.sentences=f.getHgSents(),b.docs=f.getHgDocs(),f.fillUnitDisabled(b,!0),b.edit=!1,f.editing=-1,f.unselectAllHighlights()):(b.edit=!0,f.editing=a,f.fillHighlightByUnit(b),f.fillUnitDisabled(b,!1),b.dirty=!0)):void e.error("Debe terminar de editar la unidad actual para editar otra."):void 0},f.fillUnitDisabled=function(a,b){for(var e=0;e<a.sentences.length;e++){var c=a.docs[e],d=a.sentences[e];f.disabledSents[c][d]=b}},f.startView=function(a){f.unitsIter1&&f.unitsIter1.forEach(function(a){a.viewing=!1}),f.unitsIter3&&f.unitsIter3.forEach(function(a){a.viewing=!1}),a.viewing=!0;for(var b=f.selectedDocument,c=1;c<=f.documents.length&&(f.views={},a.sentences.filter(function(b,c){return a.docs[c]==f.selectedDocument}).forEach(function(a){f.views[a]=!0}),angular.equals(f.views,{}));c++)f.selectDocument((b+c)%f.documents.length)},f.stopView=function(a){// console.log("Stop viewing: ", unit.id);
a.viewing=!1,f.views={}},f.fillHighlightByUnit=function(a){f.unselectAllHighlights(),f.hgDocs={};for(var b,c=!0,d=0;d<a.sentences.length;d++){b=a.docs[d],f.hgDocs[b]=!0,c&&(f.selectDocument(b),c=!1);var e=a.sentences[d];f.highlight[b][e]=!0}// console.log(self.highlight);
},f.unselectAllHighlights=function(){f.hgDocs={};for(var a=0;a<f.highlight.length;a++)for(var b=0;b<f.highlight[a].length;b++)f.highlight[a][b]=!1},f.getTeamInfo=function(){b({url:"get-team-leader",method:"post"}).success(function(a){f.teamId=a.id,f.originalLeader=a.original_leader,a.leader==f.myUid?(f.leader=!0,f.followLeader=!1):(f.leader=!1,f.followLeader=!0)}),b({url:"get-team",method:"post"}).success(function(a){f.teamstr=a.map(function(a){return a.name+(a.finished?" \u2713":"")}).join(", ")})},f.getSimpleTeamInfo=function(){b({url:"get-team",method:"post"}).success(function(a){f.teamNames={},a.forEach(function(a){f.teamNames[a.id]=a.name})})},f.deleteUnit=function(a,c){if(c.edit)return void e.error("No puede eliminar una unidad que est\xE1 siendo editada");if(null!=c.id){var h={id:c.id};b({url:"delete-semantic-unit",method:"post",data:h}).success(function(){console.log("Idea deleted"),3==f.iteration&&f.updateSignal()})}for(var j=0;j<c.docs.length;j++){var d=c.docs[j],g=c.sentences[j];f.disabledSents[d][g]=!1}f.units.splice(a,1)},f.init()}]),app.controller("ReportController",["$scope","$http",function(a,b){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var a={content:c.content};b({url:"send-report",method:"post",data:a}).success(function(a){"ok"==a.status&&(c.lastSent=new Date,c.misc.reportDirty=!1)})},c.shared.sendReport=c.sendReport,c.getReport=function(){b({url:"get-my-report",method:"post"}).success(function(a){"ok"==a.status&&(c.content=a.content,c.idReport=a.id)})},c.getReport()}]);var indexById=function(a,b){return a.findIndex(function(a){return a.id==b})};
