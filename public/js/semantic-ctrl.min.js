"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(c){return c()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(c,d,f,g,h){var k=c;k.iteration=0,k.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:5,name:"Evaluaci\xF3n de Pares"},{i:6,name:"Finalizada"}],k.documents=[],k.finished=!1,k.text="",k.sentences=[],k.highlight=[],k.originalTexts=[],k.originalSentences=[],k.sent={},k.views={},k.units=[],k.unitsIter1=[],k.editing=-1,k.init=function(){k.getSesInfo()},k.getSesInfo=function(){d({url:"get-ses-info",method:"post"}).success(function(l){k.iteration=l.iteration,k.myUid=l.uid,k.sesName=l.name,k.sesId=l.id,k.sesDescr=l.descr,k.sesSTime=null==l.stime?null:new Date(l.stime),k.getDocuments(),3==k.iteration&&k.getTeamInfo(),5<=k.iteration&&(k.finished=!0),d({url:"get-finished",method:"post",data:{status:k.iteration+2}}).success(function(m){m.finished&&(k.finished=!0)})})},k.selectDocument=function(l){k.selectedDocument==l||(k.selectedDocument=l,k.text=k.originalTexts[l],k.sentences=k.originalSentences[l])},k.countHightlight=function(){return null!=k.highlight&&k.highlight.reduce(function(l,m){return l.concat(m)},[]).reduce(function(l,m){return m?l+1:l},0)},k.getDocuments=function(){d({method:"post",url:"get-semantic-documents"}).success(function(l){k.documents=l,0<k.documents.length&&(k.processDocuments(),k.selectDocument(0),k.getUnits())})},k.processDocuments=function(){k.highlight=[],k.originalTexts=[],k.originalSentences=[];for(var m,l=0;l<k.documents.length;l++)m=k.documents[l].content,k.originalTexts.push(m.replace(/.[ ]+\n/,".\n")),k.originalSentences.push(k.originalTexts[l].match(/[^.!?\n]+[.!?\n]+/g)||[]),k.highlight.push(Array.from({length:k.originalSentences[l].length},function(){return!1}))},k.getUnits=function(){d({method:"post",url:"get-semantic-units",data:{iteration:k.iteration}}).success(function(l){k.units=l}),1<k.iteration&&d({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(l){k.unitsIter1=l})},k.getHgSents=function(){return k.highlight.map(function(l){return l.map(function(n,o){return[n,o]}).filter(function(n){return n[0]}).map(function(n){return n[1]})}).reduce(function(l,m){return l.concat(m)},[])},k.getHgDocs=function(){return k.highlight.map(function(l,m){return l.map(function(n,o){return[n,o]}).filter(function(n){return n[0]}).map(function(){return m})}).reduce(function(l,m){return l.concat(m)},[])},k.addSemUnit=function(l){l.edit&&k.toggleEdit(-1,l);var m="add-semantic-unit";(null!=l.id||k.sent[l.id])&&(m="update-semantic-unit");var n={id:l.id,comment:l.comment,sentences:l.sentences,docs:l.docs,iteration:k.iteration};d({method:"post",url:m,data:n}).success(function(o){l.dirty=!1,k.sent[l.id]=!0,l.id=o.id})},k.addEmptyUnit=function(){if(-1!=k.editing)return void h.error("Debe terminar de editar la unidad actual para editar otra.");k.units.push({id:null,comment:"",sentences:k.getHgSents(),status:"unsaved",docs:k.getHgDocs()}),console.log(k.units);var l=k.units.length-1;k.toggleEdit(l,k.units[l])},k.finishState=function(){if(!k.finished){if(0==k.units.length)return void h.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!k.areAllUnitsSync())return void h.error("Hay unidades sem\xE1nticas que no han sido enviadas");var l=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(l){var m={status:k.iteration+2};d({url:"record-finish",method:"post",data:m}).success(function(){k.hasFinished=!0,k.finished=!0,console.log("FINISH")})}}},k.areAllUnitsSync=function(){return k.units.every(function(l){return!l.dirty})},k.toggleEdit=function(l,m){return-1==k.editing||m.edit?void(m.edit?(m.sentences=k.getHgSents(),m.docs=k.getHgDocs(),m.edit=!1,k.editing=-1,k.unselectAllHighlights()):(m.edit=!0,k.editing=l,k.fillHighlightByUnit(m),m.dirty=!0)):void h.error("Debe terminar de editar la unidad actual para editar otra.")},k.startView=function(l){k.views={},l.sentences.filter(function(m,n){return l.docs[n]==k.selectedDocument}).forEach(function(m){k.views[m]=!0})},k.stopView=function(){k.views={}},k.fillHighlightByUnit=function(l){k.unselectAllHighlights();for(var m=0;m<l.sentences.length;m++){var n=l.docs[m],o=l.sentences[m];k.highlight[n][o]=!0}},k.unselectAllHighlights=function(){for(var l=0;l<k.highlight.length;l++)for(var m=0;m<k.highlight[l].length;m++)k.highlight[l][m]=!1},k.getTeamInfo=function(){d({url:"get-team-leader",method:"post"}).success(function(l){k.teamId=l.id,k.originalLeader=l.original_leader,l.leader==k.myUid?(k.leader=!0,k.followLeader=!1):(k.leader=!1,k.followLeader=!0)}),d({url:"get-team",method:"post"}).success(function(l){k.teamstr=l.map(function(m){return m.name+(m.finished?" \u2713":"")}).join(", ")})},k.init()}]);var indexById=function(c,d){return c.findIndex(function(f){return f.id==d})};
