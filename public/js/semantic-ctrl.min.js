"use strict";var app=angular.module("Semantic",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(b){return b()}]),app.controller("SemanticController",["$scope","$http","$timeout","$socket","Notification",function(b,h,c,d,e){var g=b;g.iteration=0,g.sesStatusses=[{i:1,name:"Individual"},{i:3,name:"Grupal"},{i:4,name:"Reporte"},{i:6,name:"Evaluaci\xF3n de Pares"},{i:7,name:"Finalizada"}],g.documents=[],g.finished=!1,g.text="",g.sentences=[],g.highlight=[],g.disabledSents=[],g.originalTexts=[],g.originalSentences=[],g.sent={},g.writingReport=!1,g.followLeader=!1,g.leader=!1,g.writingReport=!1,g.views={},g.units=[],g.unitsIter1=[],g.unitsIter3=[],g.shared={},g.teamNames={},g.editing=-1,g.hgDocs={},g.misc={},g.init=function(){d.on("stateChange",function(b){console.log("SOCKET.IO",b),b.ses==g.sesId&&window.location.reload()}),d.on("updateTeam",function(b){g.teamId==b.tmid&&(!g.leader&&g.getUnits(),g.getTeamInfo())}),g.getSesInfo(),g.getUserInfo()},g.getSesInfo=function(){h({url:"get-ses-info",method:"post"}).success(function(b){g.iteration=b.iteration,g.myUid=b.uid,0<g.iteration&&2==g.myUid&&(g.iteration=1),g.sesName=b.name,g.sesId=b.id,b.descr&&(g.sesDescr=4>g.iteration?b.descr.split("\n")[0]||b.descr:b.descr.split("\n")[1]||b.descr),g.sesSTime=null==b.stime?null:new Date(b.stime),g.getDocuments(),3==g.iteration&&g.getTeamInfo(),3<=g.iteration&&g.getSimpleTeamInfo(),4==g.iteration&&(g.writingReport=!0),5<=g.iteration&&(g.finished=!0),6==g.iteration&&window.location.replace("rubrica"),h({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(b){b.finished&&(g.finished=!0)})})},g.getUserInfo=function(){h.post("get-my-name").success(function(b){g.myName=b.name,g.myRole=b.role})},g.selectDocument=function(b){g.selectedDocument==b||(g.selectedDocument=b,g.text=g.originalTexts[b],g.sentences=g.originalSentences[b])},g.countHighlight=function(){//console.log(self.highlight);
return null!=g.highlight&&g.highlight.reduce(function(b,c){return b.concat(c)},[]).reduce(function(c,a){return a?c+1:c},0)},g.getDocuments=function(){h({method:"post",url:"get-semantic-documents"}).success(function(b){g.documents=b,0<g.documents.length&&(g.processDocuments(),g.selectDocument(0),g.getUnits())})},g.processDocuments=function(){g.highlight=[],g.disabledSents=[],g.originalTexts=[],g.originalSentences=[];for(var c,d=0;d<g.documents.length;d++)c=g.documents[d].content,g.originalTexts.push(c.replace(/.[ ]+\n/,".\n")),g.originalSentences.push(g.originalTexts[d].match(/[^.!?\n]+[.!?\n]+/g)||[]),g.highlight.push(Array.from({length:g.originalSentences[d].length},function(){return!1})),g.disabledSents.push(Array.from({length:g.originalSentences[d].length},function(){return!1}));console.log(g.originalSentences)},g.clearDisabledSents=function(){if(g.disabledSents)for(var c=0;c<g.disabledSents.length;c++)for(var d=0;d<g.disabledSents[c].length;d++)g.disabledSents[c][d]=!1},g.processUnits=function(){g.clearDisabledSents();for(var a=0;a<g.units.length;a++)for(var d=0;d<g.units[a].sentences.length;d++){var h=g.units[a].docs[d],f=g.units[a].sentences[d];g.disabledSents[h][f]=!0}console.table(g.disabledSents)},g.getUnits=function(){var b=3==g.iteration?"get-team-sync-units":"get-semantic-units";h({method:"post",url:b,data:{iteration:g.iteration}}).success(function(b){g.units=b,g.processUnits()}),1<g.iteration&&h({method:"post",url:"get-team-semantic-units",data:{iteration:1}}).success(function(b){g.unitsIter1=b}),3<g.iteration&&h({method:"post",url:"get-team-sync-units",data:{iteration:3}}).success(function(b){g.unitsIter3=b})},g.getHgSents=function(){return g.highlight.map(function(a){return a.map(function(c,a){return[c,a]}).filter(function(b){return b[0]}).map(function(b){return b[1]})}).reduce(function(c,a){return c.concat(a)},[])},g.getHgDocs=function(){return g.highlight.map(function(c,b){return c.map(function(c,a){return[c,a]}).filter(function(b){return b[0]}).map(function(){return b})}).reduce(function(c,a){return c.concat(a)},[])},g.addSemUnit=function(c){if(3!=g.iteration||g.leader){if(c.edit&&g.toggleEdit(-1,c),3==g.iteration&&(null==c.comment||0==c.comment.length))return void e.error("Debe ingresar un comentario.");var a=3==g.iteration?"add-sync-semantic-unit":"add-semantic-unit";null!=c.id&&(a="update-semantic-unit");var d={id:c.id,comment:c.comment,sentences:c.sentences,docs:c.docs,iteration:g.iteration,uidoriginal:g.originalLeader};console.log(d),h({method:"post",url:a,data:d}).success(function(a){c.dirty=!1,null==c.id&&(c.id=a.id),g.sent[c.id]=!0,3==g.iteration&&g.updateSignal()})}},g.updateSignal=function(){h({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},g.takeControl=function(){h({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),g.updateSignal()})},g.addEmptyUnit=function(){if(-1!=g.editing)return void e.error("Debe terminar de editar la unidad actual para editar otra.");g.units.push({id:null,comment:"",sentences:g.getHgSents(),status:"unsaved",docs:g.getHgDocs()});//console.log(self.units);
var b=g.units.length-1;g.toggleEdit(b,g.units[b])},g.finishState=function(){if(!g.finished){if(3>=g.iteration){if(0==g.units.length)return void e.error("No hay suficientes unidades sem\xE1nticas para terminar la actividad");if(!g.areAllUnitsSync())return void e.error("Hay unidades sem\xE1nticas que no han sido enviadas")}4==g.iteration&&g.shared.sendReport();var b=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(b){var a={status:g.iteration+2};h({url:"record-finish",method:"post",data:a}).success(function(){g.hasFinished=!0,g.finished=!0,console.log("FINISH"),3==g.iteration&&g.updateSignal()})}}},g.areAllUnitsSync=function(){return g.units.every(function(b){return!b.dirty})},g.toggleEdit=function(c,a){return 3!=g.iteration||g.leader?-1==g.editing||a.edit?a.edit&&0==g.countHighlight()?void e.error("Debe seleccionar al menos una unidad sem\xE1ntica"):void(a.edit?(a.sentences=g.getHgSents(),a.docs=g.getHgDocs(),g.fillUnitDisabled(a,!0),a.edit=!1,g.editing=-1,g.unselectAllHighlights()):(a.edit=!0,g.editing=c,g.fillHighlightByUnit(a),g.fillUnitDisabled(a,!1),a.dirty=!0)):void e.error("Debe terminar de editar la unidad actual para editar otra."):void 0},g.fillUnitDisabled=function(b,c){for(var d=0;d<b.sentences.length;d++){var h=b.docs[d],e=b.sentences[d];g.disabledSents[h][e]=c}},g.startView=function(b){g.unitsIter1&&g.unitsIter1.forEach(function(b){b.viewing=!1}),g.unitsIter3&&g.unitsIter3.forEach(function(b){b.viewing=!1}),b.viewing=!0;for(var c=g.selectedDocument,d=1;d<=g.documents.length&&(g.views={},b.sentences.filter(function(c,d){return b.docs[d]==g.selectedDocument}).forEach(function(b){g.views[b]=!0}),angular.equals(g.views,{}));d++)g.selectDocument((c+d)%g.documents.length)},g.stopView=function(b){// console.log("Stop viewing: ", unit.id);
b.viewing=!1,g.views={}},g.fillHighlightByUnit=function(c){g.unselectAllHighlights(),g.hgDocs={};for(var a,h=!0,i=0;i<c.sentences.length;i++){a=c.docs[i],g.hgDocs[a]=!0,h&&(g.selectDocument(a),h=!1);var j=c.sentences[i];g.highlight[a][j]=!0}// console.log(self.highlight);
},g.unselectAllHighlights=function(){g.hgDocs={};for(var c=0;c<g.highlight.length;c++)for(var d=0;d<g.highlight[c].length;d++)g.highlight[c][d]=!1},g.getTeamInfo=function(){h({url:"get-team-leader",method:"post"}).success(function(b){g.teamId=b.id,g.originalLeader=b.original_leader,b.leader==g.myUid?(g.leader=!0,g.followLeader=!1):(g.leader=!1,g.followLeader=!0)}),h({url:"get-team",method:"post"}).success(function(b){g.teamstr=b.map(function(b){return b.name+(b.finished?" \u2713":"")}).join(", ")})},g.getSimpleTeamInfo=function(){h({url:"get-team",method:"post"}).success(function(b){g.teamNames={},b.forEach(function(b){g.teamNames[b.id]=b.name})})},g.deleteUnit=function(i,b){if(b.edit)return void e.error("No puede eliminar una unidad que est\xE1 siendo editada");if(null!=b.id){var a={id:b.id};h({url:"delete-semantic-unit",method:"post",data:a}).success(function(){console.log("Idea deleted"),3==g.iteration&&g.updateSignal()})}for(var c=0;c<b.docs.length;c++){var j=b.docs[c],f=b.sentences[c];g.disabledSents[j][f]=!1}g.units.splice(i,1)},g.init()}]),app.controller("ReportController",["$scope","$http",function(b,e){var c=b;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var b={content:c.content};e({url:"send-report",method:"post",data:b}).success(function(b){"ok"==b.status&&(c.lastSent=new Date,c.misc.reportDirty=!1)})},c.shared.sendReport=c.sendReport,c.getReport=function(){e({url:"get-my-report",method:"post"}).success(function(b){"ok"==b.status&&(c.content=b.content,c.idReport=b.id)})},c.getReport()}]);var indexById=function(b,d){return b.findIndex(function(b){return b.id==d})};
