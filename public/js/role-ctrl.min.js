"use strict";var BASE_APP="https://saduewa.dcc.uchile.cl:8888/Readings/",app=angular.module("Role",["ngSanitize","ui.bootstrap","ui.tree","btford.socket-io","timer","ui-notification","luegg.directives"]);app.factory("$socket",["socketFactory",function(b){return b()}]),app.controller("RoleController",["$scope","$http","$timeout","$socket","Notification","$sce","$uibModal",function(b,e,f,g,h,i,j){var l=b;l.iteration=1,l.myUid=-1,l.documents=[],l.showDoc=!0,l.selectedDocument=0,l.finished=!1,l.sesId=-1,l.chatExp=!0,l.stages=[],l.currentStageId=0,l.currentStage=null,l.selectedStage=null,l.actors=[],l.sel=[],l.selections=[],l.ansIter1={},l.ansIter2={},l.chatMsgs={},l.chatmsg="",l.chatmsgreply=null,l.tmId=-1,l.userAnon={},l.lang="spanish",l.selectedActor=null,l.init=function(){// $socket.on("diffReceived", (data) => {
//     console.log("SOCKET.IO", data);
//     if(data.ses == self.sesId){
//         self.openDetails(data);
//     }
// });
l.getSesInfo(),g.on("stateChange",function(b){console.log("SOCKET.IO",b),b.ses==l.sesId&&window.location.reload()}),g.on("chatMsg",function(b){console.log("SOCKET.IO",b),b.ses==l.sesId&&b.tmid==l.tmId&&3==l.iteration&&k()}),l.getMe()},l.getSesInfo=function(){e({url:"get-ses-info",method:"post"}).success(function(b){l.iteration=b.iteration+1,l.myUid=b.uid,l.sesName=b.name,l.sesId=b.id,l.sesSTime=b.stime,l.sesDescr=b.descr,l.currentStageId=b.current_stage,2<=l.iteration&&(l.finished=!0),null!=l.currentStageId&&(l.loadDocuments(),l.loadStageData())})};var k=function(a){e.post("get-chat-msgs").success(function(b){l.chatMsgs={},l.dfs.forEach(function(b){b.c=0}),b.forEach(function(c){var d=l.dfs.find(function(a){return a.id==c.did});d.c=d.c?d.c+1:1,(a||d.id==l.dfs[l.selectedDF].id)&&(d.cr=d.c),c.parent_id&&(c.parent=b.find(function(a){return a.id==c.parent_id})),l.chatMsgs[c.did]=l.chatMsgs[c.did]||[],l.chatMsgs[c.did].push(c)})})};l.getMe=function(){e.post("get-my-name").success(function(b){l.lang=b.lang,l.updateLang(l.lang)})},l.selectActor=function(b){l.selectedActor=b},l.getPlaceholder=function(){var a=l.actors[l.selectedActor];return null==l.selectedActor||null==a?"Seleccione un rol a justificar":a.jorder?"Escribe tu justificacio\u0301n para el ORDEN EN QUE HAS UBICADO a "+a.name:"Escribe tu justificacio\u0301n SOBRE EL ROL de "+a.name},l.sendActorSel=function(){var a=l.actors[l.selectedActor];null==l.selectedActor||null==a||(a.sent=!0,l.selectedActor=null)},l.loadDocuments=function(){e({url:"get-documents",method:"post"}).success(function(b){l.documents=b})},l.loadStageData=function(){e.post("get-stages",{}).success(function(b){l.stages=b,l.currentStage=l.stages.find(function(b){return b.id==l.currentStageId})}),null!=l.currentStageId&&(e.post("get-actors",{stageid:l.currentStageId}).success(function(b){l.actors=b}),e.post("get-my-actor-sel",{stageid:l.currentStageId}).success(function(b){l.sel=b}))},l.selectDocument=function(b){l.selectedDocument=b,l.showDoc=!0},l.selectStage=function(b){return l.stages[l.selectedStage]&&l.stages[l.selectedStage].dirty?void c("Error","Debe completar el diferencial antes de cambiar"):void(l.selectedStage=b,l.stages[l.selectedStage].cr=l.stages[l.selectedStage].c,l.showDoc=!1,l.chatmsg="")},l.sendChatMsg=function(){var b={did:l.dfs[l.selectedDF].id,content:l.chatmsg,tmid:l.tmId,parent_id:l.chatmsgreply};e.post("add-chat-msg",b).success(function(){l.chatmsg="",l.chatmsgreply=null})},l.getDocURL=function(){return i.trustAsResourceUrl("https://docs.google.com/viewer?url=https://saduewa.dcc.uchile.cl:8888/Readings/"+l.documents[l.selectedDocument].path+"&embedded=true")};// self.dfSelect = (i) => {
//     if(self.finished || self.hasFinished)
//         return;
//     self.dfs[self.selectedDF].select = i;
//     self.dfs[self.selectedDF].dirty = true;
// };
var c=function(b,c){j.open({template:"<div><div class=\"modal-header\"><h4>"+b+"</h4></div><div class=\"modal-body\"><p>"+c+"</p></div></div>"})};l.openComment=function(b){c("Comentario",b)},l.showInfo=function(){c("Factor Detonante",l.sesDescr,!1)},l.updateLang=function(b){e.get("data/"+b+".json").success(function(b){window.DIC=b})},l.changeLang=function(){l.lang="english"==l.lang?"spanish":"english",l.updateLang(l.lang)},l.openDetails=function(b){j.open({templateUrl:"templ/direct-content.html",controller:"DirectContentController",controllerAs:"vm",scope:l,resolve:{data:function(){return b}}})},l.setReply=function(b){l.chatmsgreply=null==b?null:b.id,document.getElementById("chat-input").focus()},l.init()}]),app.controller("DirectContentController",["$scope","$uibModalInstance","data",function(a,b,c){var d=this;d.data=c,d.data.title="Diferencial recibido",setTimeout(function(){console.log(d),document.getElementById("modal-content").innerHTML=d.data.content},500),d.cancel=function(){b.dismiss("cancel")}}]),window.DIC=null,window.warnDIC={},app.filter("lang",function(){function b(b){if(null!=window.DIC)return window.DIC[b]?window.DIC[b]:(window.warnDIC[b]||(console.warn("Cannot find translation for ",b),window.warnDIC[b]=!0),b)}return b.$stateful=!0,b});var indexById=function(b,d){return b.findIndex(function(b){return b.id==d})};app.directive("bindHtmlCompile",["$compile",function(c){return{restrict:"A",link:function(d,e,f){d.$watch(function(){return d.$eval(f.bindHtmlCompile)},function(g){e.html(g&&g.toString());var a=d;f.bindHtmlScope&&(a=d.$eval(f.bindHtmlScope)),c(e.contents())(a)})}}}]),app.filter("linkfy",function(){var a=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,b=/(^|[^\/])(www\.[\S]+(\b|$))/gim,c=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;return function(d){return null==d?d:(angular.forEach(d.match(a),function(){d=d.replace(a,"<a href=\"$1\" target=\"_blank\">$1</a>")}),angular.forEach(d.match(b),function(){d=d.replace(b,"$1<a href=\"http://$2\" target=\"_blank\">$2</a>")}),angular.forEach(d.match(c),function(){d=d.replace(c,"<a href=\"mailto:$1\">$1</a>")}),d);// console.log("HOLA");
}});
