"use strict";var app=angular.module("Rubrica",["ui.bootstrap","btford.socket-io","timer"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("RubricaController",["$scope","$http","$socket","$uibModal",function(a,b,d,f){var g=a;g.criterios=[],g.reports=[],g.report=null,g.selectedIndex=-1,g.iteration=-1,g.myUid=-1,g.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte",".","Evaluaci\xF3n de Pares","Finalizada"],g.canAnswer=!0,g.miters=0,g.commentError=!1,g.finished=!1,g.init=function(){g.getReports(),g.getRubrica(),d.on("stateChange",function(h){console.log("SOCKET.IO",h),h.ses==g.sesId&&g.getReports()}),d.on("reportChange",function(h){console.log("SOCKET.IO",h),h.ses==g.sesId&&g.getReports()}),d.on("reportReceived",function(h){console.log("SOCKET.IO",h),h.ses==g.sesId&&g.openReport(h)}),b({url:"data/instructions.json",method:"get"}).success(function(h){g.instructions=h})},g.getReports=function(){b({url:"get-ses-info",method:"post"}).success(function(h){g.iteration=h.iteration,g.sesId=h.id,g.myUid=h.uid,g.sesSTime=null==h.stime?null:new Date(h.stime),g.sesDescr=4>g.iteration?h.descr.split("\n")[0]||h.descr:h.descr.split("\n")[1]||h.descr,b({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(j){j.finished&&(g.finished=!0)}),"M"==h.type&&(g.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],g.miters=1),5>=g.iteration?b({url:"get-active-example-report",method:"post"}).success(function(j){g.reports=[j],g.report=j,g.selectedIndex=0,g.fillSelections()}):6==g.iteration?b({url:"get-paired-report",method:"post"}).success(function(j){g.reports=j,g.report=j[0],g.selectedIndex=0,g.fillSelections()}):7==g.iteration&&b({url:"get-my-report",method:"post"}).success(function(j){console.log(j),g.reports=[j],g.report=j,g.selectedIndex=0,g.getEvals(j.id)})})},g.selectReport=function(h){g.selectedIndex=h,g.report=g.reports[h]},g.getRubrica=function(){b({url:"get-rubrica",method:"post"}).success(function(h){g.criterios=h})},g.checkCriteria=function(h){return null!=h&&null!=h.id&&null!=h.select&&g.criterios.reduce(function(j,k){return null!=h.select[k.id]&&j},!0)},g.sendSelection=function(h){if(g.checkCriteria(h)){g.commentError=!1,h.dirty=!1,g.criterios.forEach(function(k){var l={cid:k.id,sel:h.select[k.id],rid:h.id};b({url:"send-criteria-selection",method:"post",data:l}).success(function(){console.log("ok")})});var j={rid:h.id,text:h.comment};if(b({url:"send-report-comment",method:"post",data:j}).success(function(){console.log("ok")}),h.status="SENT",5==g.iteration){g.canAnswer=!1;var k={rid:h.id};b({url:"get-criteria-answer",method:"post",data:k}).success(function(l){var m=g.reports.findIndex(function(n){return n.id==h.id});console.log(m),g.reports[m].truev={},l.forEach(function(n){g.reports[m].truev[n.cid]=n.selection})})}}},g.finishState=function(){if(!g.finished){var h=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(h){var j={status:g.iteration+2};b({url:"record-finish",method:"post",data:j}).success(function(){g.finished=!0,console.log("FINISH")})}}},g.fillSelections=function(){g.reports.forEach(function(h){var j={rid:h.id};g.canAnswer=!0,b({url:"get-criteria-selection",method:"post",data:j}).success(function(k){h.select={},k.forEach(function(l){h.select[l.cid]=l.selection,5==g.iteration&&(g.canAnswer=!1)})}),b({url:"get-report-comment",method:"post",data:j}).success(function(k){h.comment=k.comment})})},g.getEvals=function(h){var j={repid:h};b({url:"get-report-result",method:"post",data:j}).success(function(k){g.answers=k}),b.post("get-criteria-selection-by-report",j).success(function(k){g.answersRubrica={},k.forEach(function(l){null==g.answersRubrica[l.uid]&&(g.answersRubrica[l.uid]={}),g.answersRubrica[l.uid][l.cid]=l.selection})})},g.getAvg=function(){if(null!=g.answers&&0!=g.answers.length){var h=g.answers.reduce(function(j,k){return j+k.val},0);return h/g.answers.length}},g.openReport=function(h){var j={rid:h.rid};b({url:"get-report",method:"post",data:j}).success(function(k){console.log(k),f.open({templateUrl:"templ/report-forward.html",controller:"ReportModalController",controllerAs:"vm",scope:g,resolve:{report:function report(){return k}}})})},g.selectCriterio=function(h,j){g.canAnswer&&(g.report.select[h]=j,g.report.dirty=!0)},g.openCriterio=function(h,j){var k=f.open({templateUrl:"templ/criterio-dialog.html",controller:"CriterioModalController",controllerAs:"vm",scope:g,resolve:{data:function data(){return{criterio:h,dis:j||!g.canAnswer||g.finished,res:j?j:g.report.select[h.id]||0}}}});k.result.then(function(l){g.selectCriterio(h.id,l)})},g.init()}]),app.controller("ReportModalController",["$scope","$uibModalInstance","report",function(a,b,d){var f=this;f.report=d,f.cancel=function(){b.dismiss("cancel")}}]),app.controller("CriterioModalController",["$scope","$uibModalInstance","data",function(a,b,d){var f=this;f.data=d,f.res=d.res,f.cancel=function(){b.dismiss("cancel")},f.done=function(){b.close(f.res)},f.select=function(g){f.data.dis||(f.res=g)}}]);
