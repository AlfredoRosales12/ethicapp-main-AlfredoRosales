"use strict";var app=angular.module("Rubrica",["ui.bootstrap","btford.socket-io","timer"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("RubricaController",["$scope","$http","$socket","$uibModal",function(a,b,d,f){var g=a;g.criterios=[],g.reports=[],g.report=null,g.selectedIndex=-1,g.iteration=-1,g.myUid=-1,g.sesStatusses=["Lectura","Individual","An\xF3nimo","Grupal","Reporte",".","Evaluaci\xF3n de Pares","Finalizada"],g.canAnswer=!0,g.miters=0,g.commentError=!1,g.finished=!1,g.init=function(){g.getReports(),g.getRubrica(),d.on("stateChange",function(j){console.log("SOCKET.IO",j),j.ses==g.sesId&&g.getReports()}),d.on("reportChange",function(j){console.log("SOCKET.IO",j),j.ses==g.sesId&&g.getReports()}),d.on("reportReceived",function(j){console.log("SOCKET.IO",j),j.ses==g.sesId&&g.openReport(j)}),b({url:"data/instructions.json",method:"get"}).success(function(j){g.instructions=j})},g.getReports=function(){b({url:"get-ses-info",method:"post"}).success(function(j){g.iteration=j.iteration,g.sesId=j.id,g.myUid=j.uid,g.sesSTime=null==j.stime?null:new Date(j.stime),g.sesDescr=4>g.iteration?j.descr.split("\n")[0]||j.descr:j.descr.split("\n")[1]||j.descr,b({url:"get-finished",method:"post",data:{status:g.iteration+2}}).success(function(k){k.finished&&(g.finished=!0)}),"M"==j.type&&(g.sesStatusses=["Individual","Grupal","Reporte","Evaluaci\xF3n de Pares","Finalizada"],g.miters=1),5>=g.iteration?b({url:"get-active-example-report",method:"post"}).success(function(k){g.reports=[k],g.report=k,g.selectedIndex=0,g.fillSelections()}):6==g.iteration?b({url:"get-paired-report",method:"post"}).success(function(k){g.reports=k,g.report=k[0],g.selectedIndex=0,g.fillSelections()}):7==g.iteration&&b({url:"get-my-report",method:"post"}).success(function(k){console.log(k),g.reports=[k],g.report=k,g.selectedIndex=0,g.getEvals(k.id)})})},g.selectReport=function(j){g.selectedIndex=j,g.report=g.reports[j]},g.getRubrica=function(){b({url:"get-rubrica",method:"post"}).success(function(j){g.criterios=j})},g.checkCriteria=function(j){return null!=j&&null!=j.id&&null!=j.select&&g.criterios.reduce(function(k,l){return null!=j.select[l.id]&&k},!0)},g.sendSelection=function(j){if(g.checkCriteria(j)){g.commentError=!1,j.dirty=!1,g.criterios.forEach(function(l){var m={cid:l.id,sel:j.select[l.id],rid:j.id};b({url:"send-criteria-selection",method:"post",data:m}).success(function(){console.log("ok")})});var k={rid:j.id,text:j.comment};if(b({url:"send-report-comment",method:"post",data:k}).success(function(){console.log("ok")}),j.status="SENT",5==g.iteration){g.canAnswer=!1;var l={rid:j.id};b({url:"get-criteria-answer",method:"post",data:l}).success(function(m){var n=g.reports.findIndex(function(o){return o.id==j.id});console.log(n),g.reports[n].truev={},m.forEach(function(o){g.reports[n].truev[o.cid]=o.selection})})}}},g.finishState=function(){if(!g.finished){if(g.reports.some(function(k){return"SENT"!=k.status}))return void h("Error","Debe terminar de responder todos los reportes");var j=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(j){var k={status:g.iteration+2};b({url:"record-finish",method:"post",data:k}).success(function(){g.finished=!0,console.log("FINISH")})}}},g.fillSelections=function(){g.reports.forEach(function(j){var k={rid:j.id};g.canAnswer=!0,b({url:"get-criteria-selection",method:"post",data:k}).success(function(l){j.select={},l.forEach(function(m){j.status="SENT",j.select[m.cid]=m.selection,5==g.iteration&&(g.canAnswer=!1)})}),b({url:"get-report-comment",method:"post",data:k}).success(function(l){j.comment=l.comment})})},g.getEvals=function(j){var k={repid:j};b({url:"get-report-result",method:"post",data:k}).success(function(l){g.answers=l}),b.post("get-criteria-selection-by-report",k).success(function(l){g.answersRubrica={},l.forEach(function(m){null==g.answersRubrica[m.uid]&&(g.answersRubrica[m.uid]={}),g.answersRubrica[m.uid][m.cid]=m.selection})})},g.getAvg=function(){if(null!=g.answers&&0!=g.answers.length){var j=g.answers.reduce(function(k,l){return k+l.val},0);return j/g.answers.length}},g.openReport=function(j){var k={rid:j.rid};b({url:"get-report",method:"post",data:k}).success(function(l){console.log(l),f.open({templateUrl:"templ/report-forward.html",controller:"ReportModalController",controllerAs:"vm",scope:g,resolve:{report:function report(){return l}}})})},g.selectCriterio=function(j,k){g.canAnswer&&(g.report.select[j]=k,g.report.dirty=!0)},g.openCriterio=function(j,k){var l=f.open({templateUrl:"templ/criterio-dialog.html",controller:"CriterioModalController",controllerAs:"vm",scope:g,resolve:{data:function data(){return{criterio:j,dis:k||!g.canAnswer||g.finished,res:k?k:g.report.select[j.id]||0}}}});l.result.then(function(m){g.selectCriterio(j.id,m)})};var h=function notify(j,k){f.open({template:"<div><div class=\"modal-header\"><i class=\"fa fa-close pull-right hoverable\" ng-click=\"$uibModalInstance.dismiss()\"></i> <h4>"+j+"</h4></div><div class=\"modal-body\"><p>"+k+"</p></div></div>"})};g.init()}]),app.controller("ReportModalController",["$scope","$uibModalInstance","report",function(a,b,d){var f=this;f.report=d,f.cancel=function(){b.dismiss("cancel")}}]),app.controller("CriterioModalController",["$scope","$uibModalInstance","data",function(a,b,d){var f=this;f.data=d,f.res=d.res,f.cancel=function(){b.dismiss("cancel")},f.done=function(){b.close(f.res)},f.select=function(g){f.data.dis||(f.res=g)}}]);
