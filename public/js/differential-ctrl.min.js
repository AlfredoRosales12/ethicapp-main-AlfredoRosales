"use strict";var BASE_APP="https://saduewa.dcc.uchile.cl:8888/Readings/",app=angular.module("Differential",["ngSanitize","ui.bootstrap","ui.tree","btford.socket-io","timer","ui-notification","luegg.directives"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("DifferentialController",["$scope","$http","$timeout","$socket","Notification","$sce","$uibModal",function(a,b,c,d,e,f,g){var h=a;h.iteration=1,h.myUid=-1,h.documents=[],h.dfs=[],h.showDoc=!0,h.selectedDocument=0,h.selectedDF=0,h.ansIter1={},h.ansIter2={},h.chatMsgs={},h.chatmsg="",h.chatmsgreply=null,h.tmId=-1,h.sesId=-1,h.finished=!1,h.userAnon={},h.sesStatusses=["individual","anon","discussion","finished"],h.lang="spanish",h.init=function(){h.getSesInfo(),d.on("stateChange",function(a){console.log("SOCKET.IO",a),a.ses==h.sesId&&window.location.reload()}),d.on("chatMsg",function(a){console.log("SOCKET.IO",a),a.ses==h.sesId&&a.tmid==h.tmId&&3==h.iteration&&i()}),d.on("diffReceived",function(a){console.log("SOCKET.IO",a),a.ses==h.sesId&&h.openDetails(a)}),h.getMe()},h.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(a){h.iteration=a.iteration+1,h.myUid=a.uid,h.sesName=a.name,h.sesId=a.id,h.sesSTime=a.stime,h.sesDescr=a.descr,1<h.iteration&&b({url:"get-team-diff-selection",method:"post",data:{iteration:1}}).success(function(a){a.forEach(function(a){h.ansIter1[a.did]=h.ansIter1[a.did]||[],h.ansIter1[a.did].push({select:a.sel,comment:a.comment,uid:a.uid})})}),2<h.iteration&&b({url:"get-team-diff-selection",method:"post",data:{iteration:2}}).success(function(a){a.forEach(function(a){h.ansIter2[a.did]=h.ansIter2[a.did]||[],h.ansIter2[a.did].push({select:a.sel,comment:a.comment,uid:a.uid})})}),4<=h.iteration&&(h.finished=!0),0<h.iteration&&(h.loadDocuments(),h.loadDifferentials(),b.post("get-anon-team").success(function(a){var b=["A","B","C","D","E"];a.forEach(function(a,c){h.userAnon[a.id]=b[c],h.tmId=a.tmid})}))})};var i=function(a){b.post("get-chat-msgs").success(function(b){h.chatMsgs={},h.dfs.forEach(function(a){a.c=0}),b.forEach(function(c){var d=h.dfs.find(function(a){return a.id==c.did});d.c=d.c?d.c+1:1,(a||d.id==h.dfs[h.selectedDF].id)&&(d.cr=d.c),c.parent_id&&(c.parent=b.find(function(a){return a.id==c.parent_id})),h.chatMsgs[c.did]=h.chatMsgs[c.did]||[],h.chatMsgs[c.did].push(c)})})};h.getMe=function(){b.post("get-my-name").success(function(a){h.lang=a.lang,h.updateLang(h.lang)})},h.loadDocuments=function(){b({url:"get-documents",method:"post"}).success(function(a){h.documents=a})},h.loadDifferentials=function(){b({url:"get-differentials",method:"post"}).success(function(a){h.dfs=a,console.log(h.dfs),h.loadDiffSelection(),i(!0)})},h.loadDiffSelection=function(){var a={iteration:h.iteration};b.post("get-diff-selection",a).success(function(a){a.forEach(function(a){var b=h.dfs.find(function(b){return a.did==b.id});b.select=a.sel,b.comment=a.comment})})},h.selectDocument=function(a){h.selectedDocument=a,h.showDoc=!0},h.selectDF=function(a){return h.dfs[h.selectedDF].dirty?void j("Error","Debe completar el diferencial antes de cambiar"):void(h.selectedDF=a,h.dfs[h.selectedDF].cr=h.dfs[h.selectedDF].c,h.showDoc=!1,h.chatmsg="")},h.sendDFSel=function(){var a=h.dfs[h.selectedDF];if(null==a.select||-1==a.select||null==a.comment||""==a.comment)return void j("Error","El diferencial no est\xE1 completo");var c={sel:a.select,comment:a.comment,did:a.id,iteration:h.iteration};b.post("send-diff-selection",c).success(function(){a.dirty=!1})},h.finishState=function(){if(!h.finished){if(3>=h.iteration&&h.dfs.some(function(a){return null==a.id}))return void j("Error","Falta responder algunos diferenciales sem\xE1nticos");var a=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(a){var c={status:h.iteration+2};b({url:"record-finish",method:"post",data:c}).success(function(){h.hasFinished=!0,h.finished=!0,console.log("FINISH")})}}},h.sendChatMsg=function(){var a={did:h.dfs[h.selectedDF].id,content:h.chatmsg,tmid:h.tmId,parent_id:h.chatmsgreply};b.post("add-chat-msg",a).success(function(){h.chatmsg="",h.chatmsgreply=null})},h.getDocURL=function(){return f.trustAsResourceUrl("https://docs.google.com/viewer?url=https://saduewa.dcc.uchile.cl:8888/Readings/"+h.documents[h.selectedDocument].path+"&embedded=true")},h.dfSelect=function(a){h.finished||h.hasFinished||(h.dfs[h.selectedDF].select=a,h.dfs[h.selectedDF].dirty=!0)};var j=function(a,b){g.open({template:"<div><div class=\"modal-header\"><h4>"+a+"</h4></div><div class=\"modal-body\"><p>"+b+"</p></div></div>"})};h.openComment=function(a){j("Comentario",a)},h.showInfo=function(){j("Factor Detonante",h.sesDescr,!1)},h.updateLang=function(a){b.get("data/"+a+".json").success(function(a){window.DIC=a})},h.changeLang=function(){h.lang="english"==h.lang?"spanish":"english",h.updateLang(h.lang)},h.openDetails=function(a){g.open({templateUrl:"templ/direct-content.html",controller:"DirectContentController",controllerAs:"vm",scope:h,resolve:{data:function b(){return a}}})},h.setReply=function(a){h.chatmsgreply=null==a?null:a.id,document.getElementById("chat-input").focus()},h.init()}]),app.controller("DirectContentController",["$scope","$uibModalInstance","data",function(a,b,c){var d=this;d.data=c,d.data.title="Diferencial recibido",setTimeout(function(){console.log(d),document.getElementById("modal-content").innerHTML=d.data.content},500),d.cancel=function(){b.dismiss("cancel")}}]),window.DIC=null,window.warnDIC={},app.filter("lang",function(){function a(a){if(null!=window.DIC)return window.DIC[a]?window.DIC[a]:(window.warnDIC[a]||(console.warn("Cannot find translation for ",a),window.warnDIC[a]=!0),a)}return a.$stateful=!0,a});var indexById=function(a,b){return a.findIndex(function(a){return a.id==b})};app.directive("bindHtmlCompile",["$compile",function(a){return{restrict:"A",link:function e(b,c,d){b.$watch(function(){return b.$eval(d.bindHtmlCompile)},function(e){c.html(e&&e.toString());var f=b;d.bindHtmlScope&&(f=b.$eval(d.bindHtmlScope)),a(c.contents())(f)})}}}]),app.filter("linkfy",function(){var a=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,b=/(^|[^\/])(www\.[\S]+(\b|$))/gim,c=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;return function(d){return null==d?d:(angular.forEach(d.match(a),function(){d=d.replace(a,"<a href=\"$1\" target=\"_blank\">$1</a>")}),angular.forEach(d.match(b),function(){d=d.replace(b,"$1<a href=\"http://$2\" target=\"_blank\">$2</a>")}),angular.forEach(d.match(c),function(){d=d.replace(c,"<a href=\"mailto:$1\">$1</a>")}),d);// console.log("HOLA");
}});
