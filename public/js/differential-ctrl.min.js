"use strict";var BASE_APP="https://saduewa.dcc.uchile.cl:8888/Readings/",app=angular.module("Differential",["ui.bootstrap","ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("DifferentialController",["$scope","$http","$timeout","$socket","Notification","$sce","$uibModal",function(a,b,c,f,g,h,j){var k=a;k.iteration=1,k.myUid=-1,k.documents=[],k.dfs=[],k.showDoc=!0,k.selectedDocument=0,k.selectedDF=0,k.ansIter1={},k.ansIter2={},k.chatMsgs={},k.chatmsg="",k.tmId=-1,k.sesId=-1,k.finished=!1,k.userAnon={},k.sesStatusses=["individual","anon","discussion","finished"],k.lang="spanish",k.init=function(){k.getSesInfo(),f.on("stateChange",function(n){console.log("SOCKET.IO",n),n.ses==k.sesId&&window.location.reload()}),f.on("chatMsg",function(n){console.log("SOCKET.IO",n),n.ses==k.sesId&&n.tmid==k.tmId&&3==k.iteration&&l()}),k.getMe()},k.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(n){k.iteration=n.iteration+1,k.myUid=n.uid,k.sesName=n.name,k.sesId=n.id,k.sesSTime=n.stime,k.sesDescr=n.descr,1<k.iteration&&b({url:"get-team-diff-selection",method:"post",data:{iteration:1}}).success(function(o){o.forEach(function(p){k.ansIter1[p.did]=k.ansIter1[p.did]||[],k.ansIter1[p.did].push({select:p.sel,comment:p.comment,uid:p.uid})})}),2<k.iteration&&(b({url:"get-team-diff-selection",method:"post",data:{iteration:2}}).success(function(o){o.forEach(function(p){k.ansIter2[p.did]=k.ansIter2[p.did]||[],k.ansIter2[p.did].push({select:p.sel,comment:p.comment,uid:p.uid})})}),l()),4<=k.iteration&&(k.finished=!0),0<k.iteration&&(k.loadDocuments(),k.loadDifferentials(),b.post("get-anon-team").success(function(o){var p=["A","B","C","D","E"];o.forEach(function(q,r){k.userAnon[q.id]=p[r],k.tmId=q.tmid})}))})};var l=function updateChat(){b.post("get-chat-msgs").success(function(n){k.chatMsgs={},n.forEach(function(o){var p=k.dfs.find(function(q){return q.id==o.did});p.c=p.c?p.c+1:1,k.chatMsgs[o.did]=k.chatMsgs[o.did]||[],k.chatMsgs[o.did].push(o)})})};k.getMe=function(){b.post("get-my-name").success(function(n){k.lang=n.lang,k.updateLang(k.lang)})},k.loadDocuments=function(){b({url:"get-documents",method:"post"}).success(function(n){k.documents=n})},k.loadDifferentials=function(){b({url:"get-differentials",method:"post"}).success(function(n){k.dfs=n,console.log(k.dfs),k.loadDiffSelection()})},k.loadDiffSelection=function(){var n={iteration:k.iteration};b.post("get-diff-selection",n).success(function(o){o.forEach(function(p){var q=k.dfs.find(function(r){return p.did==r.id});q.select=p.sel,q.comment=p.comment})})},k.selectDocument=function(n){k.selectedDocument=n,k.showDoc=!0},k.selectDF=function(n){k.selectedDF=n,k.dfs[k.selectedDF].c=0,k.showDoc=!1,k.chatmsg=""},k.sendDFSel=function(){var n=k.dfs[k.selectedDF];if(null==n.select||-1==n.select||null==n.comment||""==n.comment)return void m("Error","El diferencial no est\xE1 completo");var o={sel:n.select,comment:n.comment,did:n.id,iteration:k.iteration};b.post("send-diff-selection",o).success(function(){n.dirty=!1})},k.finishState=function(){if(!k.finished){if(3>=k.iteration&&k.dfs.some(function(o){return null==o.id}))return void m("Error","Falta responder algunos diferenciales sem\xE1nticos");var n=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(n){var o={status:k.iteration+2};b({url:"record-finish",method:"post",data:o}).success(function(){k.hasFinished=!0,k.finished=!0,console.log("FINISH")})}}},k.sendChatMsg=function(){var n={did:k.dfs[k.selectedDF].id,content:k.chatmsg,tmid:k.tmId};b.post("add-chat-msg",n).success(function(){k.chatmsg=""})},k.getDocURL=function(){return h.trustAsResourceUrl("https://docs.google.com/viewer?url="+BASE_APP+k.documents[k.selectedDocument].path+"&embedded=true")},k.dfSelect=function(n){k.dfs[k.selectedDF].select=n,k.dfs[k.selectedDF].dirty=!0};var m=function notify(n,o){j.open({template:"<div><div class=\"modal-header\"><h4>"+n+"</h4></div><div class=\"modal-body\"><p>"+o+"</p></div></div>"})};k.openComment=function(n){m("Comentario",n)},k.showInfo=function(){m("Factor Detonante",k.sesDescr,!1)},k.updateLang=function(n){b.get("data/"+n+".json").success(function(o){window.DIC=o})},k.changeLang=function(){k.lang="english"==k.lang?"spanish":"english",k.updateLang(k.lang)},k.init()}]),window.DIC=null,window.warnDIC={},app.filter("lang",function(){function a(b){if(null!=window.DIC)return window.DIC[b]?window.DIC[b]:(window.warnDIC[b]||(console.warn("Cannot find translation for ",b),window.warnDIC[b]=!0),b)}return a.$stateful=!0,a});var indexById=function(a,b){return a.findIndex(function(c){return c.id==b})};
