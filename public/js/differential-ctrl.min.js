"use strict";var BASE_APP="https://saduewa.dcc.uchile.cl:8888/Readings/",app=angular.module("Differential",["ui.tree","btford.socket-io","timer","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("DifferentialController",["$scope","$http","$timeout","$socket","Notification","$sce",function(a,b,c,f,g,h){var j=a;j.iteration=1,j.myUid=-1,j.documents=[],j.dfs=[],j.showDoc=!0,j.selectedDocument=0,j.selectedDF=0,j.ansIter1={},j.ansIter2={},j.chatMsgs={},j.chatmsg="",j.tmId=-1,j.sesId=-1,j.finished=!1,j.userAnon={},j.sesStatusses=["individual","anon","teamWork","finished"],j.lang="spanish",j.init=function(){j.getSesInfo(),f.on("stateChange",function(m){console.log("SOCKET.IO",m),m.ses==j.sesId&&window.location.reload()}),f.on("chatMsg",function(m){console.log("SOCKET.IO",m),m.ses==j.sesId&&m.tmid==j.tmId&&3==j.iteration&&k()}),j.getMe()},j.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(m){j.iteration=m.iteration+1,j.myUid=m.uid,j.sesName=m.name,j.sesId=m.id,j.sesSTime=m.stime,j.sesDescr=m.descr,1<j.iteration&&(b({url:"get-team-diff-selection",method:"post",data:{iteration:1}}).success(function(n){n.forEach(function(o){j.ansIter1[o.did]=j.ansIter1[o.did]||[],j.ansIter1[o.did].push({select:o.sel,comment:o.comment,uid:o.uid})})}),b.post("get-anon-team").success(function(n){var o=["A","B","C","D","E"];n.forEach(function(p,q){j.userAnon[p.id]=o[q],j.tmId=p.tmid})})),2<j.iteration&&(b({url:"get-team-diff-selection",method:"post",data:{iteration:2}}).success(function(n){n.forEach(function(o){j.ansIter2[o.did]=j.ansIter2[o.did]||[],j.ansIter2[o.did].push({select:o.sel,comment:o.comment,uid:o.uid})})}),k()),4<=j.iteration&&(j.finished=!0),0<j.iteration&&(j.loadDocuments(),j.loadDifferentials())})};var k=function updateChat(){b.post("get-chat-msgs").success(function(m){j.chatMsgs={},m.forEach(function(n){var o=j.dfs.find(function(p){return p.id==n.did});o.c=o.c?o.c+1:1,j.chatMsgs[n.did]=j.chatMsgs[n.did]||[],j.chatMsgs[n.did].push(n)})})};j.getMe=function(){b.post("get-my-name").success(function(m){j.lang=m.lang,j.updateLang(j.lang)})},j.loadDocuments=function(){b({url:"get-documents",method:"post"}).success(function(m){j.documents=m})},j.loadDifferentials=function(){b({url:"get-differentials",method:"post"}).success(function(m){j.dfs=m,j.loadDiffSelection()})},j.loadDiffSelection=function(){var m={iteration:j.iteration};b.post("get-diff-selection",m).success(function(n){n.forEach(function(o){var p=j.dfs.find(function(q){return o.did==q.id});p.select=o.sel,p.comment=o.comment})})},j.selectDocument=function(m){j.selectedDocument=m,j.showDoc=!0},j.selectDF=function(m){j.selectedDF=m,j.dfs[j.selectedDF].c=0,j.showDoc=!1,j.chatmsg=""},j.sendDFSel=function(){var m=j.dfs[j.selectedDF];if(null==m.select||-1==m.select||null==m.comment||""==m.comment)return void l("Error","El diferencial no est\xE1 completo");var n={sel:m.select,comment:m.comment,did:m.id,iteration:j.iteration};b.post("send-diff-selection",n).success(function(){m.dirty=!1})},j.finishState=function(){if(!j.finished){if(3>=j.iteration&&j.dfs.some(function(n){return null==n.id}))return void l("Error","Falta responder algunos diferenciales sem\xE1nticos");var m=window.confirm("\xBFEsta seguro que desea terminar la actividad?\nEsto implica no volver a poder editar sus respuestas");if(m){var n={status:j.iteration+2};b({url:"record-finish",method:"post",data:n}).success(function(){j.hasFinished=!0,j.finished=!0,console.log("FINISH")})}}},j.sendChatMsg=function(){var m={did:j.dfs[j.selectedDF].id,content:j.chatmsg,tmid:j.tmId};b.post("add-chat-msg",m).success(function(){j.chatmsg=""})},j.getDocURL=function(){return h.trustAsResourceUrl("https://docs.google.com/viewer?url="+BASE_APP+j.documents[j.selectedDocument].path+"&embedded=true")},j.dfSelect=function(m){j.dfs[j.selectedDF].select=m,j.dfs[j.selectedDF].dirty=!0};var l=function notify(m,n){$uibModal.open({template:"<div><div class=\"modal-header\"><h4>"+m+"</h4></div><div class=\"modal-body\"><p>"+n+"</p></div></div>"})};j.openComment=function(m){l("Comentario",m)},j.showInfo=function(){l("Factor Detonante",j.sesDescr,!1)},j.updateLang=function(m){b.get("data/"+m+".json").success(function(n){window.DIC=n})},j.changeLang=function(){j.lang="english"==j.lang?"spanish":"english",j.updateLang(j.lang)},j.init()}]),window.DIC=null,window.warnDIC={},app.filter("lang",function(){function a(b){if(null!=window.DIC)return window.DIC[b]?window.DIC[b]:(window.warnDIC[b]||(console.warn("Cannot find translation for ",b),window.warnDIC[b]=!0),b)}return a.$stateful=!0,a});var indexById=function(a,b){return a.findIndex(function(c){return c.id==b})};
