"use strict";var app=angular.module("Select",["ui.bootstrap","timer","btford.socket-io","ui-notification","ngSanitize","ngMap"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SelectController",["$scope","$http","$socket","Notification","$uibModal","NgMap",function(a,b,d,f,g,h){var j=a;j.selectedQs=0,j.iteration=1,j.myUid=-1,j.questions=[],j.otherAnswsers={},j.answers={},j.anskey={},j.comments={},j.confidences={},j.optLabels=["A","B","C","D","E"],j.optConfidence=[0,25,50,75,100],j.sent={},j.teamUids=[],j.bottomMsg="",j.finished=!1,j.useConfidence=!1,j.shared={},j.ansIter1={},j.ansIter2={},j.sesStatusses=["Individual","An\xF3nimo","Grupal","Finalizada"],j.init=function(){j.loadQuestions(),j.getSesInfo(),d.on("stateChange",function(l){console.log("SOCKET.IO",l),l.ses==j.sesId&&window.location.reload()}),d.on("teamProgress",function(l){console.log("SOCKET.IO",l),l.ses==j.sesId&&l.tmid==j.teamId&&3==j.iteration&&j.updateTeam()}),h.getMap().then(function(l){j.map=l})},j.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(l){j.iteration=l.iteration+1,j.myUid=l.uid,j.sesName=l.name,j.sesId=l.id,j.sesSTime=l.stime,j.sesDescr=l.descr,j.useConfidence=null!=l.options&&l.options.includes("C");var m=new Set;1<j.iteration&&b({url:"get-team-selection",method:"post",data:{iteration:1}}).success(function(n){n.forEach(function(o){j.ansIter1[o.qid]=j.ansIter1[o.qid]||{},j.ansIter1[o.qid][o.uid]={answer:o.answer,comment:o.comment},m.add(o.uid),j.teamUids=Array.from(m)})}),2<j.iteration&&(b({url:"get-team-selection",method:"post",data:{iteration:2}}).success(function(n){n.forEach(function(o){j.ansIter2[o.qid]=j.ansIter2[o.qid]||{},j.ansIter2[o.qid][o.uid]={answer:o.answer,comment:o.comment},m.add(o.uid),j.teamUids=Array.from(m)})}),j.updateTeam()),4<=j.iteration&&(j.finished=!0,j.loadAnskey()),j.loadAnswers()})},j.updateTeam=function(){b({url:"get-team",method:"post"}).success(function(l){j.team={},j.teamstr=l.map(function(m){return m.name}).join(", "),l.forEach(function(m){j.team[m.id]=m.name}),0<l.length&&(j.teamId=l[0].tmid,j.teamProgress=l[0].progress,3==j.iteration&&j.selectQuestion(j.teamProgress))})},j.loadQuestions=function(){b({url:"get-questions",method:"post"}).success(function(l){j.questions=l,j.questions.forEach(function(m){m.options=m.options.split("\n"),m.map=k(m)}),j.shared.updateOverlayList()})};var k=function processMap(l){var m="<pre class=\"ql-syntax\" spellcheck=\"false\">MAP ",n=l.content.indexOf(m),o=l.content.indexOf("</pre>");if(-1!=n&&-1!=o&&n<o){var q=l.content.substring(n+m.length,o-1).split(" ");return l.content=l.content.substring(0,n)+l.content.substring(o+6),{center:"["+q[0]+", "+q[1]+"]",zoom:q[2],nav:"NAV"==q[3],edit:"EDIT"==q[3]||"EDIT"==q[4]}}return null};j.loadAnskey=function(){b({url:"get-anskey",method:"post"}).success(function(l){j.anskey={},l.forEach(function(m){j.anskey[m.id]=m})})},j.loadAnswers=function(){b({url:"get-answers",method:"post",data:{iteration:Math.min(3,j.iteration)}}).success(function(l){l.forEach(function(m){j.answers[m.qid]=m.answer,j.comments[m.qid]=m.comment,j.confidences[m.qid]=m.confidence,j.sent[m.qid]=!0})})},j.setAnswer=function(l,m){j.answers[l.id]=m,l.dirty=!0},j.selectQuestion=function(l){j.selectedQs=l,j.shared.updateOverlayList()},j.nextQuestion=function(){if(3==j.iteration){console.log("Checking team answers");var l={qid:j.questions[j.selectedQs].id};b({url:"check-team-answer",method:"post",data:l}).success(function(m){"ok"==m.status?(j.sendTeamProgress(j.selectedQs+1),j.bottomMsg=""):"incomplete"==m.status?j.bottomMsg="Debe esperar a que todos los miembros del equipo respondan":"different"==m.status?j.bottomMsg="Las respuestas de los miembros del equipo no coinciden":"incorrect"!=m.status||j.questions[j.selectedQs].hinted?j.questions[j.selectedQs].hinted?(j.sendTeamProgress(j.selectedQs+1),j.bottomMsg=""):f.info("Se alcanzo el final de la actividad"):(j.bottomMsg="Comentario: "+m.msg,j.questions[j.selectedQs].hinted=!0)})}else j.questions[j.selectedQs].dirty?f.error("No se ha enviado una respuesta a la pregunta"):j.selectedQs>=j.questions.length-1&&3!=j.iteration?f.info("Se alcanzo el final de la actividad"):j.selectQuestion(j.selectedQs+1)},j.sendTeamProgress=function(l){var m={tmid:j.teamId,progress:l};b({url:"send-team-progress",method:"post",data:m}).success(function(n){"ok"==n.status&&console.log("Progress sent")})},j.prevQuestion=function(){return 0>=j.selectedQs?void f.info("Se alcanzo el inicio de la actividad"):void(j.questions[j.selectedQs].dirty?f.error("No se ha enviado una respuesta a la pregunta"):3!=j.iteration&&j.selectQuestion(j.selectedQs-1))},j.sendAnswer=function(l){if(null==j.answers[l.id]||-1==j.answers[l.id])return void f.error("Debe seleccionar una alternativa");if(null==j.comments[l.id]||""==j.comments[l.id])return void f.error("Debe agregar un comentario");var m={qid:l.id,answer:j.answers[l.id],comment:j.comments[l.id],confidence:j.confidences[l.id],iteration:j.iteration};b({url:"send-answer",method:"post",data:m}).success(function(n){"ok"==n.status&&(j.sent[m.qid]=!0,l.dirty=!1)})},j.showInfo=function(){g.open({template:"<div><div class=\"modal-header\"><h4>Factor Detonante</h4></div><div class=\"modal-body\"><p>"+j.sesDescr+"</p></div></div>"})},j.init()}]),app.controller("GeoController",["$scope","$http","NgMap","$socket",function(a,b,d,f){var g=a;g.openRight=!1,g.rightTab="",g.mOverlays=[],g.sOverlays=[],g.selectedOverlay=null,g.editing=!1;var j=function toOverlay(o){return{id:o.id,name:o.name,description:o.description,color:k(o),type:o.type,fullType:m(o.type),geom:JSON.parse(o.geom)}},k=function getColor(o){return 0==o.iteration?"blue":"red"},l=function packOverlay(o){return{name:o.name,description:o.description,iteration:g.iteration,qid:null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id,type:o.type,geom:JSON.stringify(o.geom)}},m=function getFullType(o){return"M"===o?"marker":"P"===o?"polygon":"L"===o?"polyline":"R"===o?"rectangle":"C"===o?"circle":"I"===o?"image":void 0};g.clearOverlay=function(){g.newOverlay={name:"",description:"",color:"red",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},g.updateOverlayList=function(){var o={qid:null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id};b.post("list-overlay",o).success(function(q){var s=q.map(j);g.mOverlays=s.filter(function(u){return"M"==u.type}),g.sOverlays=s.filter(function(u){return"M"!=u.type})})},g.shared.updateOverlayList=g.updateOverlayList,g.onMapOverlayCompleted=function(o){g.editing=!0,g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType=o.type,g.newOverlay.type="polyline"==o.type?"L":o.type[0].toUpperCase(),g.newOverlay.geom.position=o.overlay.getPosition?positionToArray(o.overlay.getPosition()):null,g.newOverlay.geom.radius=o.overlay.radius,g.newOverlay.geom.center=positionToArray(o.overlay.center),g.newOverlay.geom.path=o.overlay.getPath?mutiplePositionToArray(o.overlay.getPath()):null,g.newOverlay.geom.bounds=o.overlay.getBounds?boundsToArray(o.overlay.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2"),o.overlay.setMap(null)},g.colorizeShape=function(o){g.map.shapes&&g.map.shapes.nshp&&(g.map.shapes.nshp.set("fillColor",o),g.map.shapes.nshp.set("strokeColor","dark"+o))},g.closeOverlay=function(){g.clearOverlay(),g.map.infoWindows.iw2.close()};var n=function updateOverlay(){var o="M"==g.newOverlay.type?g.map.markers.nmkr:g.map.shapes.nshp;g.newOverlay.geom.position=o.getPosition?positionToArray(o.getPosition()):null,g.newOverlay.geom.radius=o.radius,g.newOverlay.geom.center=positionToArray(o.center),g.newOverlay.geom.path=o.getPath?mutiplePositionToArray(o.getPath()):null,g.newOverlay.geom.bounds=o.getBounds?boundsToArray(o.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2")};g.sendOverlay=function(){n(),b.post("add-overlay",l(g.newOverlay)).success(function(o){"ok"==o.status&&(g.closeOverlay(),g.updateOverlayList())})},g.clickOverlay=function(){g.selectOverlay(this.id)},g.selectOverlay=function(o){g.selectedOverlay=g.mOverlays.find(function(q){return q.id==o})||g.sOverlays.find(function(q){return q.id==o}),g.selectedOverlay.centroid=centroidAsLatLng(g.selectedOverlay.type,g.selectedOverlay.geom),g.map.panTo(g.selectedOverlay.centroid),g.map.showInfoWindow("iw")},g.googleSearch=function(){var o=this.getPlace();null==o||null==o.geometry||null==o.geometry.location||(g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType="marker",g.newOverlay.type="M",g.newOverlay.geom.position=positionToArray(o.geometry.location),g.map.panTo(o.geometry.location))},function init(){g.updateOverlayList(),g.clearOverlay(),d.getMap().then(function(o){console.log("MAP cargado correctamente"),g.map=o,g.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),g.map.infoWindows.iw.close()}),f.on("update-overlay",function(o){o.sesid==g.sesId&&g.updateOverlayList()})}()}]),app.filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]);var positionToArray=function(a){return null==a?null:[a.lat(),a.lng()]},mutiplePositionToArray=function(a){for(var f,b=[],d=0;d<a.getLength();d++)f=a.getAt(d),b.push(positionToArray(f));return b},boundsToArray=function(a){return[positionToArray(a.getSouthWest()),positionToArray(a.getNorthEast())]},avgCoord=function(a){for(var b=0,d=0,f=0;f<a.length;f++)b+=a[f][0],d+=a[f][1];return[b/a.length,d/a.length]},centroidAsLatLng=function(a,b){var d=centroid(a,b);return new google.maps.LatLng(d[0],d[1])},centroid=function(a,b){return"M"==a?b.position:"C"==a?b.center:"R"==a?avgCoord(b.bounds):"P"==a||"L"==a?avgCoord(b.path):null};
