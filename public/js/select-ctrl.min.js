"use strict";var app=angular.module("Select",["timer","btford.socket-io","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SelectController",["$scope","$http","$socket","Notification",function(a,b,c,d){var f=a;f.selectedQs=0,f.iteration=1,f.myUid=-1,f.questions=[],f.otherAnswsers={},f.answers={},f.comments={},f.optLabels=["A","B","C","D","E"],f.sent={},f.teamUids=[],f.bottomMsg="",f.ansIter1={},f.ansIter2={},f.sesStatusses=["Individual","An\xF3nimo","Grupal","Finalizada"],f.init=function(){f.loadQuestions(),f.getSesInfo(),c.on("stateChange",function(g){console.log("SOCKET.IO",g),g.ses==f.sesId&&window.location.reload()})},f.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(g){f.iteration=g.iteration+1,f.myUid=g.uid,f.sesName=g.name,f.sesId=g.id,f.sesSTime=g.stime;var h=new Set;1<f.iteration&&b({url:"get-team-selection",method:"post",data:{iteration:1}}).success(function(i){i.forEach(function(j){f.ansIter1[j.qid]=f.ansIter1[j.qid]||{},f.ansIter1[j.qid][j.uid]={answer:j.answer,comment:j.comment},h.add(j.uid),f.teamUids=Array.from(h)})}),2<f.iteration&&(b({url:"get-team-selection",method:"post",data:{iteration:2}}).success(function(i){i.forEach(function(j){f.ansIter2[j.qid]=f.ansIter2[j.qid]||{},f.ansIter2[j.qid][j.uid]={answer:j.answer,comment:j.comment},h.add(j.uid),f.teamUids=Array.from(h)})}),b({url:"get-team",method:"post"}).success(function(i){f.team={},f.teamstr=i.map(function(j){return j.name}).join(", "),i.forEach(function(j){f.team[j.id]=j.name})})),f.loadAnswers()})},f.loadQuestions=function(){b({url:"get-questions",method:"post"}).success(function(g){f.questions=g,f.questions.forEach(function(h){h.options=h.options.split("\n")})})},f.loadAnswers=function(){b({url:"get-answers",method:"post",data:{iteration:Math.min(3,f.iteration)}}).success(function(g){g.forEach(function(h){f.answers[h.qid]=h.answer,f.comments[h.qid]=h.comment,f.sent[h.qid]=!0})})},f.setAnswer=function(g,h){f.answers[g.id]=h,g.dirty=!0},f.selectQuestion=function(g){f.selectedQs=g},f.nextQuestion=function(){if(f.selectedQs>=f.questions.length-1)return void d.info("Se alcanzo el final de la actividad");if(3==f.iteration){console.log("Checking team answers");var g={qid:f.questions[f.selectedQs].id};b({url:"check-team-answer",method:"post",data:g}).success(function(h){"ok"==h.status?(f.selectQuestion(f.selectedQs+1),f.bottomMsg=""):"incomplete"==h.status?f.bottomMsg="Debe esperar a que todos los miembros del equipo respondan":"different"==h.status?f.bottomMsg="Las respuestas de los miembros del equipo no coinciden":"incorrect"==h.status&&!f.questions[f.selectedQs].hinted&&(f.bottomMsg=h.msg,f.questions[f.selectedQs].hinted=!0)})}else f.selectQuestion(f.selectedQs+1)},f.prevQuestion=function(){return 0>=f.selectedQs?void d.info("Se alcanzo el inicio de la actividad"):void(3!=f.iteration&&f.selectQuestion(f.selectedQs-1))},f.sendAnswer=function(g){if(null==f.answers[g.id]||-1==f.answers[g.id])return void d.error("Debe seleccionar una alternativa");if(null==f.comments[g.id]||""==f.comments[g.id])return void d.error("Debe agregar un comentario");var h={qid:g.id,answer:f.answers[g.id],comment:f.comments[g.id],iteration:f.iteration};b({url:"send-answer",method:"post",data:h}).success(function(i){"ok"==i.status&&(f.sent[h.qid]=!0,g.dirty=!1)})},f.init()}]);
