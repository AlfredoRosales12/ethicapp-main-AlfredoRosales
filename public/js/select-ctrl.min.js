"use strict";var app=angular.module("Select",["ui.bootstrap","timer","btford.socket-io","ui-notification","ngSanitize","ngMap"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SelectController",["$scope","$http","$socket","Notification","$uibModal","NgMap",function(a,b,c,d,f,g){var h=a;h.selectedQs=0,h.iteration=1,h.myUid=-1,h.questions=[],h.otherAnswsers={},h.answers={},h.anskey={},h.comments={},h.confidences={},h.optLabels=["A","B","C","D","E"],h.optConfidence=[0,25,50,75,100],h.sent={},h.teamUids=[],h.bottomMsg="",h.finished=!1,h.useConfidence=!1,h.ansIter1={},h.ansIter2={},h.sesStatusses=["Individual","An\xF3nimo","Grupal","Finalizada"],h.init=function(){h.loadQuestions(),h.getSesInfo(),c.on("stateChange",function(j){console.log("SOCKET.IO",j),j.ses==h.sesId&&window.location.reload()}),c.on("teamProgress",function(j){console.log("SOCKET.IO",j),j.ses==h.sesId&&j.tmid==h.teamId&&3==h.iteration&&h.updateTeam()}),g.getMap().then(function(j){h.map=j})},h.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(j){h.iteration=j.iteration+1,h.myUid=j.uid,h.sesName=j.name,h.sesId=j.id,h.sesSTime=j.stime,h.sesDescr=j.descr,h.useConfidence=null!=j.options&&j.options.includes("C");var k=new Set;1<h.iteration&&b({url:"get-team-selection",method:"post",data:{iteration:1}}).success(function(l){l.forEach(function(m){h.ansIter1[m.qid]=h.ansIter1[m.qid]||{},h.ansIter1[m.qid][m.uid]={answer:m.answer,comment:m.comment},k.add(m.uid),h.teamUids=Array.from(k)})}),2<h.iteration&&(b({url:"get-team-selection",method:"post",data:{iteration:2}}).success(function(l){l.forEach(function(m){h.ansIter2[m.qid]=h.ansIter2[m.qid]||{},h.ansIter2[m.qid][m.uid]={answer:m.answer,comment:m.comment},k.add(m.uid),h.teamUids=Array.from(k)})}),h.updateTeam()),4<=h.iteration&&(h.finished=!0,h.loadAnskey()),h.loadAnswers()})},h.updateTeam=function(){b({url:"get-team",method:"post"}).success(function(j){h.team={},h.teamstr=j.map(function(k){return k.name}).join(", "),j.forEach(function(k){h.team[k.id]=k.name}),0<j.length&&(h.teamId=j[0].tmid,h.teamProgress=j[0].progress,3==h.iteration&&h.selectQuestion(h.teamProgress))})},h.loadQuestions=function(){b({url:"get-questions",method:"post"}).success(function(j){h.questions=j,h.questions.forEach(function(k){k.options=k.options.split("\n"),k.map=i(k)})})};var i=function processMap(j){var k="<pre class=\"ql-syntax\" spellcheck=\"false\">MAP ",l=j.content.indexOf(k),m=j.content.indexOf("</pre>");if(-1!=l&&-1!=m&&l<m){var n=j.content.substring(l+k.length,m-1).split(" ");return j.content=j.content.substring(0,l)+j.content.substring(m+6),{center:"["+n[0]+", "+n[1]+"]",zoom:n[2],nav:"NAV"==n[3],edit:"EDIT"==n[3]||"EDIT"==n[4]}}return null};h.loadAnskey=function(){b({url:"get-anskey",method:"post"}).success(function(j){h.anskey={},j.forEach(function(k){h.anskey[k.id]=k})})},h.loadAnswers=function(){b({url:"get-answers",method:"post",data:{iteration:Math.min(3,h.iteration)}}).success(function(j){j.forEach(function(k){h.answers[k.qid]=k.answer,h.comments[k.qid]=k.comment,h.confidences[k.qid]=k.confidence,h.sent[k.qid]=!0})})},h.setAnswer=function(j,k){h.answers[j.id]=k,j.dirty=!0},h.selectQuestion=function(j){h.selectedQs=j},h.nextQuestion=function(){if(3==h.iteration){console.log("Checking team answers");var j={qid:h.questions[h.selectedQs].id};b({url:"check-team-answer",method:"post",data:j}).success(function(k){"ok"==k.status?(h.sendTeamProgress(h.selectedQs+1),h.bottomMsg=""):"incomplete"==k.status?h.bottomMsg="Debe esperar a que todos los miembros del equipo respondan":"different"==k.status?h.bottomMsg="Las respuestas de los miembros del equipo no coinciden":"incorrect"!=k.status||h.questions[h.selectedQs].hinted?h.questions[h.selectedQs].hinted?(h.sendTeamProgress(h.selectedQs+1),h.bottomMsg=""):d.info("Se alcanzo el final de la actividad"):(h.bottomMsg="Comentario: "+k.msg,h.questions[h.selectedQs].hinted=!0)})}else h.questions[h.selectedQs].dirty?d.error("No se ha enviado una respuesta a la pregunta"):h.selectedQs>=h.questions.length-1&&3!=h.iteration?d.info("Se alcanzo el final de la actividad"):h.selectQuestion(h.selectedQs+1)},h.sendTeamProgress=function(j){var k={tmid:h.teamId,progress:j};b({url:"send-team-progress",method:"post",data:k}).success(function(l){"ok"==l.status&&console.log("Progress sent")})},h.prevQuestion=function(){return 0>=h.selectedQs?void d.info("Se alcanzo el inicio de la actividad"):void(h.questions[h.selectedQs].dirty?d.error("No se ha enviado una respuesta a la pregunta"):3!=h.iteration&&h.selectQuestion(h.selectedQs-1))},h.sendAnswer=function(j){if(null==h.answers[j.id]||-1==h.answers[j.id])return void d.error("Debe seleccionar una alternativa");if(null==h.comments[j.id]||""==h.comments[j.id])return void d.error("Debe agregar un comentario");var k={qid:j.id,answer:h.answers[j.id],comment:h.comments[j.id],confidence:h.confidences[j.id],iteration:h.iteration};b({url:"send-answer",method:"post",data:k}).success(function(l){"ok"==l.status&&(h.sent[k.qid]=!0,j.dirty=!1)})},h.showInfo=function(){f.open({template:"<div><div class=\"modal-header\"><h4>Factor Detonante</h4></div><div class=\"modal-body\"><p>"+h.sesDescr+"</p></div></div>"})},h.init()}]),app.filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]);
