"use strict";var app=angular.module("Select",["ui.bootstrap","timer","btford.socket-io","ui-notification"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("SelectController",["$scope","$http","$socket","Notification","$uibModal",function(a,b,c,d,f){var g=a;g.selectedQs=0,g.iteration=1,g.myUid=-1,g.questions=[],g.otherAnswsers={},g.answers={},g.anskey={},g.comments={},g.optLabels=["A","B","C","D","E"],g.sent={},g.teamUids=[],g.bottomMsg="",g.finished=!1,g.ansIter1={},g.ansIter2={},g.sesStatusses=["Individual","An\xF3nimo","Grupal","Finalizada"],g.init=function(){g.loadQuestions(),g.getSesInfo(),c.on("stateChange",function(h){console.log("SOCKET.IO",h),h.ses==g.sesId&&window.location.reload()})},g.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(h){g.iteration=h.iteration+1,g.myUid=h.uid,g.sesName=h.name,g.sesId=h.id,g.sesSTime=h.stime,g.sesDescr=h.descr;var i=new Set;1<g.iteration&&b({url:"get-team-selection",method:"post",data:{iteration:1}}).success(function(j){j.forEach(function(k){g.ansIter1[k.qid]=g.ansIter1[k.qid]||{},g.ansIter1[k.qid][k.uid]={answer:k.answer,comment:k.comment},i.add(k.uid),g.teamUids=Array.from(i)})}),2<g.iteration&&(b({url:"get-team-selection",method:"post",data:{iteration:2}}).success(function(j){j.forEach(function(k){g.ansIter2[k.qid]=g.ansIter2[k.qid]||{},g.ansIter2[k.qid][k.uid]={answer:k.answer,comment:k.comment},i.add(k.uid),g.teamUids=Array.from(i)})}),b({url:"get-team",method:"post"}).success(function(j){g.team={},g.teamstr=j.map(function(k){return k.name}).join(", "),j.forEach(function(k){g.team[k.id]=k.name})})),4<=g.iteration&&(g.finished=!0,g.loadAnskey()),g.loadAnswers()})},g.loadQuestions=function(){b({url:"get-questions",method:"post"}).success(function(h){g.questions=h,g.questions.forEach(function(i){i.options=i.options.split("\n")})})},g.loadAnskey=function(){b({url:"get-anskey",method:"post"}).success(function(h){g.anskey={},h.forEach(function(i){g.anskey[i.id]=i})})},g.loadAnswers=function(){b({url:"get-answers",method:"post",data:{iteration:Math.min(3,g.iteration)}}).success(function(h){h.forEach(function(i){g.answers[i.qid]=i.answer,g.comments[i.qid]=i.comment,g.sent[i.qid]=!0})})},g.setAnswer=function(h,i){g.answers[h.id]=i,h.dirty=!0},g.selectQuestion=function(h){g.selectedQs=h},g.nextQuestion=function(){if(g.selectedQs>=g.questions.length-1&&3!=g.iteration)return void d.info("Se alcanzo el final de la actividad");if(3==g.iteration){console.log("Checking team answers");var h={qid:g.questions[g.selectedQs].id};b({url:"check-team-answer",method:"post",data:h}).success(function(i){"ok"==i.status?(g.selectQuestion(g.selectedQs+1),g.bottomMsg=""):"incomplete"==i.status?g.bottomMsg="Debe esperar a que todos los miembros del equipo respondan":"different"==i.status?g.bottomMsg="Las respuestas de los miembros del equipo no coinciden":"incorrect"!=i.status||g.questions[g.selectedQs].hinted?g.questions[g.selectedQs].hinted?(g.selectQuestion(g.selectedQs+1),g.bottomMsg=""):d.info("Se alcanzo el final de la actividad"):(g.bottomMsg="Comentario: "+i.msg,g.questions[g.selectedQs].hinted=!0)})}else g.selectQuestion(g.selectedQs+1)},g.prevQuestion=function(){return 0>=g.selectedQs?void d.info("Se alcanzo el inicio de la actividad"):void(3!=g.iteration&&g.selectQuestion(g.selectedQs-1))},g.sendAnswer=function(h){if(null==g.answers[h.id]||-1==g.answers[h.id])return void d.error("Debe seleccionar una alternativa");if(null==g.comments[h.id]||""==g.comments[h.id])return void d.error("Debe agregar un comentario");var i={qid:h.id,answer:g.answers[h.id],comment:g.comments[h.id],iteration:g.iteration};b({url:"send-answer",method:"post",data:i}).success(function(j){"ok"==j.status&&(g.sent[i.qid]=!0,h.dirty=!1)})},g.showInfo=function(){f.open({template:"<div><div class=\"modal-header\"><h4>Factor Detonante</h4></div><div class=\"modal-body\"><p>"+g.sesDescr+"</p></div></div>"})},g.init()}]);
