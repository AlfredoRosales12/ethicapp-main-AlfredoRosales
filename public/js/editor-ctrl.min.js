"use strict";var app=angular.module("Editor",["ui.tree","btford.socket-io"]);app.factory("$socket",["socketFactory",function(a){return a()}]),app.controller("EditorController",["$scope","$http","$timeout","$socket",function(a,b,c,d){var f=a;f.iteration=0,f.myUid=-1,f.documents=[],f.selections=[],f.selectedDocument=0,f.numPages=0,f.ansIter1={},f.ansIter2={},f.sideTab=0,f.docIdx={},f.writingReport=!1,f.followLeader=!1,f.leader=!1,f.teamId=-1,f.iterationNames=["Lectura","Individual","Grupal An\xF3nimo","Grupal"],f.tabOptions=["Actual"],rangy.init(),f.applier=rangy.createClassApplier("highlight"),f.secondaryApplier=rangy.createClassApplier("highlight-secondary"),f.init=function(){f.getSesInfo(),d.on("stateChange",function(l){console.log("SOCKET.IO",l),l.ses==f.sesId&&window.location.reload()}),d.on("updateTeam",function(l){f.teamId==l.tmid&&(f.getIdeas(),f.getTeamInfo())})},f.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(l){f.iteration=l.iteration,f.myUid=l.uid,f.sesName=l.name,f.sesId=l.id,b({url:"get-documents",method:"post"}).success(function(m){f.documents=m,m.forEach(function(n,o){f.docIdx[n.id]=o}),f.renderAll()}),b({url:"data/instructions.json",method:"get"}).success(function(m){f.instructions=m}),3==f.iteration&&f.getTeamInfo()})},f.getTeamInfo=function(){b({url:"get-team-leader",method:"post"}).success(function(l){f.teamId=l.id,l.leader==f.myUid?(f.leader=!0,f.followLeader=!1):(f.leader=!1,f.followLeader=!0)}),b({url:"get-team",method:"post"}).success(function(l){f.teamstr=l.map(function(m){return m.name}).join(", ")})},f.setTab=function(l){f.sideTab=l},f.selectText=function(){var l=window.getSelection(),m=rangy.serializeSelection(window,!0,$("#pdf-canvas-"+f.selectedDocument)[0]),n={text:l.toString(),length:l.toString().length,serial:m,document:f.selectedDocument,comment:"",expanded:!0,status:"unsaved"};2>n.length||50<n.length||(f.highlightSerial(n.serial,n.document),f.selections.push(n))},f.goToSerial=function(l,m,n){n=null==n?".highlight":n,f.selectedDocument=m;var o=angular.element(n);o=o.filter(function(q,r){return r.innerHTML==l}),console.log(o),0<o.length&&c(function(){return o[0].scrollIntoView()},100)},f.highlightSerial=function(l,m,n){console.log(l,m),n=null==n?f.applier:n;try{n.applyToRange(rangy.deserializeRange(l,$("#pdf-canvas-"+m)[0],document))}catch(o){console.log(l+" no se pudo highlightear!",o)}},f.renderAll=function(){f.numPages=0,f.documents.forEach(function(l,m){h(l.path,m)})},f.selectPDF=function(l){f.selectedDocument=l},f.getIdeas=function(){var l={iteration:Math.min(3,f.iteration)},m=3==l.iteration?"get-team-sync-ideas":"get-ideas";b({url:m,method:"post",data:l}).success(function(n){f.selections=[],n.forEach(function(o){var q={id:o.id,text:o.content,serial:o.serial,document:g(f.documents,o.docid),comment:o.descr,expanded:!1,status:"saved"};f.highlightSerial(q.serial,q.document),f.selections.push(q)})}),1<f.iteration&&(f.tabOptions=["Actual","Individual"],b({url:"get-team-ideas",method:"post",data:{iteration:1}}).success(function(n){f.ansIter1={},n.forEach(function(o){f.ansIter1[o.uid]=f.ansIter1[o.uid]||[],f.ansIter1[o.uid].push(o),f.highlightSerial(o.serial,f.docIdx[o.docid],f.secondaryApplier)})})),2<f.iteration&&(f.tabOptions=["Actual","Individual","G. Anonimo"],b({url:"get-team-ideas",method:"post",data:{iteration:2}}).success(function(n){f.ansIter2={},n.forEach(function(o){f.ansIter2[o.uid]=f.ansIter2[o.uid]||[],f.ansIter2[o.uid].push(o),f.highlightSerial(o.serial,f.docIdx[o.docid],f.secondaryApplier)})})),4==f.iteration?f.writingReport=!0:5==f.iteration&&window.location.replace("rubrica")},f.sendIdea=function(l){var m={text:l.text,comment:l.comment,serial:l.serial,docid:f.documents[l.document].id,iteration:f.iteration};"unsaved"==l.status?b({url:"send-idea",method:"post",data:m}).success(function(n){"ok"==n.status&&(l.expanded=!1,l.status="saved",l.id=n.id),f.updateSignal()}):"dirty"==l.status&&null!=l.id&&(m.id=l.id,b({url:"update-idea",method:"post",data:m}).success(function(n){"ok"==n.status&&(l.expanded=!1,l.status="saved"),f.updateSignal()}))},f.updateSignal=function(){b({url:"update-my-team",method:"post"}).success(function(){console.log("Team updated")})},f.deleteIdea=function(l,m){if(null!=l.id){var n={id:l.id};b({url:"delete-idea",method:"post",data:n}).success(function(o){"ok"==o.status&&f.selections.splice(m,1),f.updateSignal()})}else f.selections.splice(m,1)},f.copyIdea=function(l){if(console.log(l),null!=l&&(null==l.copied||l.copied)){var m={text:l.content,length:l.content.length,serial:l.serial,document:f.docIdx[l.docid],comment:l.descr,expanded:!0,status:"unsaved"};f.selections.push(m),l.copied=!0,l.expanded=!1,f.setTab(0)}},f.takeControl=function(){b({url:"take-team-control",method:"post"}).success(function(){console.log("Control given"),f.updateSignal()})},f.selTextChange=function(l){l.status="saved"==l.status?"dirty":l.status},f.checkAllSync=function(){return 0==f.selections.filter(function(l){return"saved"!=l.status}).length},f.setSelOrder=function(){if(f.checkAllSync()){var l=f.selections.map(function(n){return n.id});b({url:"set-ideas-orden",method:"post",data:{orden:l}}).success(function(n){"ok"==n.status&&console.log("Order saved")})}};var g=function arrayIndexOfId(l,m){return l.reduce(function(n,o,q){return o.id==m?q:n},-1)},h=function loadPdf(l,m){PDFJS.disableWorker=!0;var n=PDFJS.getDocument(l);n.then(function(o){return j(o,m)})},j=function renderPdf(l,m){for(var o,n=1;n<=l.numPages;n++)o=l.getPage(n).then(function(q){return k(q,m)}),f.numPages+=1},k=function renderPage(l,m){var o=l.getViewport(1.3),q=$("<canvas></canvas>"),r=q.get(0),s=r.getContext("2d");r.height=o.height,r.width=o.width;var t=$("#pdf-canvas-"+m);t.css("height",r.height+"px").css("width",r.width+"px"),t.append(q);var u=q.offset(),v=jQuery("<div></div>").addClass("textLayer").css("height",o.height+"px").css("width",o.width+"px");t.append(v),l.getTextContent({normalizeWhitespace:!0}).then(function(w){var x=new TextLayerBuilder(v.get(0),0);x.setTextContent(w);l.render({canvasContext:s,viewport:o,textLayer:x}).then(function(){f.numPages-=1,0==f.numPages&&(f.getIdeas(),$(".textLayer").html(function(){return this.innerHTML.replace(/\t/g," ")}))})})};f.init()}]),app.controller("ReportController",["$scope","$http",function(a,b){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var d={content:c.content};b({url:"send-report",method:"post",data:d}).success(function(f){"ok"==f.status&&(c.lastSent=new Date)})},c.getReport=function(){b({url:"get-my-report",method:"post"}).success(function(d){"ok"==d.status&&(c.content=d.content)})},c.getReport()}]);
