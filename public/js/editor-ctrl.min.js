"use strict";var app=angular.module("Editor",["ui.tree"]);app.controller("EditorController",["$scope","$http","$timeout",function(a,b,c){var d=a;d.iteration=1,d.myUid=-1,d.documents=[],d.selections=[],d.selectedDocument=0,d.numPages=0,d.ansIter1={},d.ansIter2={},d.sideTab=0,d.docIdx={},d.writingReport=!1,d.followLeader=!1,d.leader=!1,d.tabOptions=["Actual"],rangy.init(),d.applier=rangy.createClassApplier("highlight"),d.secondaryApplier=rangy.createClassApplier("highlight-secondary"),d.init=function(){d.getSesInfo()},d.getSesInfo=function(){b({url:"get-ses-info",method:"post"}).success(function(k){d.iteration=k.iteration,d.myUid=k.uid,d.sesName=k.name,b({url:"get-documents",method:"post"}).success(function(l){d.documents=l,l.forEach(function(m,n){d.docIdx[m.id]=n}),d.renderAll()}),3==d.iteration&&b({url:"get-team-leader",method:"post"}).success(function(l){l.leader==d.myUid?d.leader=!0:d.followLeader=!0})})},d.setTab=function(k){d.sideTab=k},d.selectText=function(){var k=window.getSelection(),l=rangy.serializeSelection(window,!0,$("#pdf-canvas-"+d.selectedDocument)[0]),m={text:k.toString(),length:k.toString().length,serial:l,document:d.selectedDocument,comment:"",expanded:!0,status:"unsaved"};2>m.length||50<m.length||(d.highlightSerial(m.serial,m.document),d.selections.push(m))},d.goToSerial=function(k,l,m){m=null==m?".highlight":m,d.selectedDocument=l;var n=angular.element(m);n=n.filter(function(o,q){return q.innerHTML==k}),console.log(n),0<n.length&&c(function(){return n[0].scrollIntoView()},100)},d.highlightSerial=function(k,l,m){console.log(k,l),m=null==m?d.applier:m;try{m.applyToRange(rangy.deserializeRange(k,$("#pdf-canvas-"+l)[0],document))}catch(n){console.log(k+" no se pudo highlightear!",n)}},d.renderAll=function(){d.numPages=0,d.documents.forEach(function(k,l){g(k.path,l)})},d.selectPDF=function(k){d.selectedDocument=k},d.getIdeas=function(){var k={iteration:Math.min(3,d.iteration)},l=3==k.iteration?"get-team-sync-ideas":"get-ideas";b({url:l,method:"post",data:k}).success(function(m){d.selections=[],m.forEach(function(n){var o={id:n.id,text:n.content,serial:n.serial,document:f(d.documents,n.docid),comment:n.descr,expanded:!1,status:"saved"};d.highlightSerial(o.serial,o.document),d.selections.push(o)})}),1<d.iteration&&b({url:"get-team-ideas",method:"post",data:{iteration:1}}).success(function(m){m.forEach(function(n){d.ansIter1[n.uid]=d.ansIter1[n.uid]||[],d.ansIter1[n.uid].push(n),d.highlightSerial(n.serial,d.docIdx[n.docid],d.secondaryApplier)}),d.tabOptions.push("Iteraci\xF3n 1")}),2<d.iteration&&b({url:"get-team-ideas",method:"post",data:{iteration:2}}).success(function(m){m.forEach(function(n){d.ansIter2[n.uid]=d.ansIter2[n.uid]||[],d.ansIter2[n.uid].push(n),d.highlightSerial(n.serial,d.docIdx[n.docid],d.secondaryApplier)}),d.tabOptions.push("Iteraci\xF3n 2")}),4==d.iteration?d.writingReport=!0:5==d.iteration&&window.location.replace("rubrica")},d.sendIdea=function(k){var l={text:k.text,comment:k.comment,serial:k.serial,docid:d.documents[k.document].id,iteration:d.iteration};"unsaved"==k.status?b({url:"send-idea",method:"post",data:l}).success(function(m){"ok"==m.status&&(k.expanded=!1,k.status="saved",k.id=m.id)}):"dirty"==k.status&&null!=k.id&&(l.id=k.id,b({url:"update-idea",method:"post",data:l}).success(function(m){"ok"==m.status&&(k.expanded=!1,k.status="saved")}))},d.selTextChange=function(k){k.status="saved"==k.status?"dirty":k.status},d.checkAllSync=function(){return 0==d.selections.filter(function(k){return"saved"!=k.status}).length},d.setSelOrder=function(){if(d.checkAllSync()){var k=d.selections.map(function(m){return m.id});b({url:"set-ideas-orden",method:"post",data:{orden:k}}).success(function(m){"ok"==m.status&&console.log("Order saved")})}};var f=function arrayIndexOfId(k,l){return k.reduce(function(m,n,o){return n.id==l?o:m},-1)},g=function loadPdf(k,l){PDFJS.disableWorker=!0;var m=PDFJS.getDocument(k);m.then(function(n){return h(n,l)})},h=function renderPdf(k,l){for(var n,m=1;m<=k.numPages;m++)n=k.getPage(m).then(function(o){return j(o,l)}),d.numPages+=1},j=function renderPage(k,l){var n=k.getViewport(1.3),o=$("<canvas></canvas>"),q=o.get(0),r=q.getContext("2d");q.height=n.height,q.width=n.width;var s=$("#pdf-canvas-"+l);s.css("height",q.height+"px").css("width",q.width+"px"),s.append(o);var t=o.offset(),u=jQuery("<div></div>").addClass("textLayer").css("height",n.height+"px").css("width",n.width+"px");s.append(u),k.getTextContent().then(function(v){var w=new TextLayerBuilder(u.get(0),0);w.setTextContent(v);k.render({canvasContext:r,viewport:n,textLayer:w}).then(function(){d.numPages-=1,0==d.numPages&&d.getIdeas()})})};d.init()}]),app.controller("ReportController",["$scope","$http",function(a,b){var c=a;c.isFull=!0,c.content="",c.lastSent=null,c.toggleFull=function(){c.isFull=!c.isFull},c.sendReport=function(){var d={content:c.content};b({url:"send-report",method:"post",data:d}).success(function(f){"ok"==f.status&&(c.lastSent=new Date)})},c.getReport=function(){b({url:"get-my-report",method:"post"}).success(function(d){"ok"==d.status&&(c.content=d.content)})},c.getReport()}]);
