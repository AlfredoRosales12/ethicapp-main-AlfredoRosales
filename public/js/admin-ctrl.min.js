"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;adpp.controller("AdminController",function(a,b,g,h,l){var m=a;l.NUMBER_FORMATS.GROUP_SEP="",m.shared={},m.sessions=[],m.selectedSes=null,m.documents=[],m.questions=[],m.questionTexts=[],m.newUsers=[],m.users={},m.selectedIndex=-1,m.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],m.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],m.openSidebar=!0,m.init=function(){m.shared.updateSesData()},m.selectSession=function(o){m.selectedIndex=o,m.selectedSes=m.sessions[o],m.requestDocuments(),m.requestQuestions(),m.getNewUsers(),m.getMembers(),m.shared.verifyGroups(),m.shared.resetGraphs(),m.shared.verifyTabs(),m.shared.resetTab(),h.path(m.selectedSes.id)},m.shared.updateSesData=function(){b({url:"get-session-list",method:"post"}).success(function(o){console.log("Session data updated"),m.sessions=o,-1==m.selectedIndex?m.sesFromURL():m.selectSession(m.selectedIndex)})},m.sesFromURL=function(){var o=+h.path().substring(1),q=m.sessions.findIndex(function(w){return w.id==o});-1!=q&&m.selectSession(q)},m.requestDocuments=function(){var o={sesid:m.selectedSes.id};b({url:"documents-session",method:"post",data:o}).success(function(q){m.documents=q})},m.shared.updateDocuments=m.requestDocuments,m.deleteDocument=function(o){b({url:"delete-document",method:"post",data:{docid:o}}).success(function(){m.requestDocuments()})},m.requestQuestions=function(){var o={sesid:m.selectedSes.id};b({url:"questions-session",method:"post",data:o}).success(function(q){m.questions=q.map(function(w){return w.options=w.options.split("\n"),w})}),b({url:"get-question-text",method:"post",data:o}).success(function(q){m.questionTexts=q})},m.getNewUsers=function(){var o={sesid:m.selectedSes.id};b({url:"get-new-users",method:"post",data:o}).success(function(q){m.newUsers=q})},m.getMembers=function(){var o={sesid:m.selectedSes.id};b({url:"get-ses-users",method:"post",data:o}).success(function(q){m.usersArr=q,q.forEach(function(w){m.users[w.id]=w})})},m.openNewSes=function(){g.open({templateUrl:"templ/new-ses.html"})},m.init()}),adpp.controller("TabsController",function(a){var g=a;g.tabOptions=["Descripci\xF3n","Dashboard"],g.tabConfig=["Usuarios","Grupos"],g.selectedTab=0,g.selectedTabConfig=-1,g.shared.resetTab=function(){g.selectedTab=0,null!=g.selectedSes&&1<g.selectedSes.status&&(g.selectedTab=1),g.selectedTabConfig=-1,7==g.selectedSes.status&&g.shared.gotoRubrica()},g.shared.verifyTabs=function(){"L"==g.selectedSes.type?(g.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Calibraci\xF3n Rubrica",val:5},{name:"Evaluaci\xF3n de Pares",val:6}],g.tabOptions=["Configuraci\xF3n","Dashboard"],g.tabConfig=["Usuarios","Grupos","R\xFAbrica"],g.sesStatusses=["Configuraci\xF3n","Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],g.shared.getRubrica(),g.shared.getExampleReports(),g.shared.getReports()):(g.iterationNames=[{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],g.tabOptions=["Configuraci\xF3n","Dashboard"],g.tabConfig=["Usuarios","Grupos"],g.sesStatusses=["Configuraci\xF3n","Individual","An\xF3nimo","Grupal","Finalizada"]),1<g.selectedSes.status&&(g.selectedTab=1)},g.setTab=function(h){g.selectedTab=h},g.setTabConfig=function(h){g.selectedTabConfig=h},g.shared.gotoGrupos=function(){g.selectedTab=0,g.selectedTabConfig=1},g.shared.gotoRubrica=function(){g.selectedTab=0,g.selectedTabConfig=2}}),adpp.controller("DocumentsController",function(a,b,g){var h=a;h.busy=!1,h.uploadDocument=function(l){h.busy=!0;var m=new FormData(l.target);b.post("upload-file",m,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(o){"ok"==o.status&&(g.success("Documento cargado correctamente"),l.target.reset(),h.busy=!1,h.shared.updateDocuments())})}}),adpp.controller("SesEditorController",function(a,b,g){var h=a;h.updateSession=function(){if(3>h.selectedSes.name.length||5>h.selectedSes.descr.length)return void g.error("Datos de la sesi\xF3n incorrectos o incompletos");var l={name:h.selectedSes.name,descr:h.selectedSes.descr,id:h.selectedSes.id};b({url:"update-session",method:"post",data:l}).success(function(){console.log("Session updated")})},h.shared.changeState=function(){if(h.selectedSes.status>=h.sesStatusses.length)return void g.error("La sesi\xF3n est\xE1 finalizada");if("L"==h.selectedSes.type&&3<=h.selectedSes.status&&!h.selectedSes.grouped||"S"==h.selectedSes.type&&2<=h.selectedSes.status&&!h.selectedSes.grouped)return h.shared.gotoGrupos(),void g.error("Los grupos no han sido generados");if(7<=h.selectedSes.status&&!h.selectedSes.paired)return h.shared.gotoRubrica(),void g.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var l=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(l){var m={sesid:h.selectedSes.id};b({url:"change-state-session",method:"post",data:m}).success(function(){h.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(a,b,g){var h=a;h.addToSession=function(){if(0==h.newMembs.length)return void g.error("No hay usuarios seleccionados para agregar");var m={users:h.newMembs.map(function(o){return o.id}),sesid:h.selectedSes.id};b({url:"add-ses-users",method:"post",data:m}).success(function(o){"ok"==o.status&&(h.getNewUsers(),h.getMembers())})},h.removeUser=function(m){if(1==h.selectedSes.status){var o={uid:m,sesid:h.selectedSes.id};b({url:"delete-ses-user",method:"post",data:o}).success(function(q){"ok"==q.status&&(h.getNewUsers(),h.getMembers())})}}}),adpp.controller("QuestionsController",function(a,b,g){var h=a;h.qsLabels=["A","B","C","D","E"],h.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},h.newText={title:"",content:""},h.selectAnswer=function(l){h.newQuestion.answer=l},h.addQuestion=function(){if(-1==h.newQuestion.answer)return void g.error("Debe indicar la respuesta correcta a la pregunta");var l={content:h.newQuestion.content,options:h.newQuestion.alternatives.join("\n"),comment:h.newQuestion.comment,answer:h.newQuestion.answer,sesid:h.selectedSes.id,textid:h.newQuestion.textid,other:h.newQuestion.other};b({url:"add-question",method:"post",data:l}).success(function(m){"ok"==m.status&&(h.requestQuestions(),g.success("Pregunta agrgada correctamente"),h.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1})})},h.addQuestionText=function(){var l={sesid:h.selectedSes.id,title:h.newText.title,content:h.newText.content};b({url:"add-question-text",method:"post",data:l}).success(function(m){"ok"==m.status&&(h.requestQuestions(),h.newText={title:"",content:""})})}}),adpp.controller("DashboardController",function(a,b,g,h,l){var m=a;m.iterationIndicator=1,m.currentTimer=null,m.shared.resetGraphs=function(){null!=m.selectedSes&&"L"==m.selectedSes.type?m.iterationIndicator=Math.max(Math.min(6,m.selectedSes.status-2),0):"S"==m.selectedSes.type&&(m.iterationIndicator=Math.max(Math.min(3,m.selectedSes.status-1),1)),m.alumState=null,m.barOpts={chart:{type:"multiBarChart",height:320,x:function x(o){return o.label},y:function y(o){return o.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},m.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}],m.updateState(),9>m.selectedSes.status&&m.reload(!0)},m.reload=function(o){o||m.updateState(),null!=m.currentTimer&&g.cancel(m.currentTimer),m.currentTimer=g(m.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},m.updateState=function(){4>=m.iterationIndicator?m.updateStateIni():m.updateStateRub()},m.updateStateIni=function(){m.alumTime={};var o={sesid:m.selectedSes.id,iteration:m.iterationIndicator};"S"==m.selectedSes.type?(b({url:"get-alum-full-state-sel",method:"post",data:o}).success(function(q){for(var w in m.alumState={},m.users)"A"==m.users[w].role&&(m.alumState[w]={});q.forEach(function(w){null==m.alumState[w.uid]?(m.alumState[w.uid]={},m.alumState[w.uid][w.qid]=w.correct):m.alumState[w.uid][w.qid]=w.correct})}),b({url:"get-alum-state-sel",method:"post",data:o}).success(function(q){var w=q.map(function(x){return x.score/=m.questions.length,x});m.buildBarData(w)})):"L"==m.selectedSes.type&&(b({url:"get-alum-state-lect",method:"post",data:o}).success(function(q){m.alumState=q,m.buildBarData(q),m.getAlumDoneTime(o)}),b({url:"get-ideas-progress",method:"post",data:o}).success(function(q){m.numProgress=0,m.numUsers=Object.keys(m.users).length-1;var w=3*m.documents.length;0!=w&&(q.forEach(function(x){m.numProgress+=x.count/w}),m.numProgress*=100/m.numUsers)}))},m.avgAlum=function(o){if(null!=m.alumState&&null!=m.alumState[o]){var q=0,w=0;for(var x in m.alumState[o])m.alumState[o][x]&&w++,q++;return 0<q?100*w/q:0}return 0},m.avgPreg=function(o){if(null!=m.alumState){var q=0,w=0;for(var x in m.alumState)null!=m.alumState[x][o]&&(m.alumState[x][o]&&w++,q++);return 0<q?100*w/q:0}return 0},m.avgAll=function(){var o=0,q=0;if(null!=m.alumState)for(var w in m.alumState)for(var x in m.alumState[w])m.alumState[w][x]&&q++,o++;return 0<o?100*q/o:0},m.progress=function(){var o=0;if(null!=m.alumState)for(var q in m.alumState)for(var w in m.alumState[q])o++;return 100*o/(Object.keys(m.alumState).length*m.questions.length)},m.getAlumDoneTime=function(o){b({url:"get-alum-done-time",method:"post",data:o}).success(function(q){m.numComplete=0,q.forEach(function(w){m.numComplete+=1;var x=m.alumState.findIndex(function(y){return y.uid==w.uid});-1==x?m.alumState.push(w):m.alumState[x].dtime=~~w.dtime})})},m.buildBarData=function(o){var q=5;m.barData[0].values=[];for(var x,w=0;w<q;w++)x=20*w+"% - "+20*(w+1)+"%",m.barData[0].values.push({label:x,value:0});o.forEach(function(w){var x=Math.min(Math.floor(q*w.score),q-1);m.barData[0].values[x].value+=1}),m.barOpts.chart.xAxis.axisLabel="Rendimiento"},m.updateStateRub=function(){5==m.iterationIndicator?m.computeDif():6==m.iterationIndicator&&m.getAllReportResult()},m.showName=function(o){return o.example?o.title+" - Texto ejemplo":o.id+" - Reporte de Alumno "+m.users[o.uid].name},m.shared.getReports=function(){var o={sesid:m.selectedSes.id};b({url:"get-report-list",method:"post",data:o}).success(function(q){m.reports=q,m.exampleReports=q.filter(function(w){return w.example})})},m.getReportResult=function(){var o={repid:m.selectedReport.id};b({url:"get-report-result",method:"post",data:o}).success(function(q){m.result=q,m.updateState()})},m.getAllReportResult=function(){var o={sesid:m.selectedSes.id};b({url:"get-report-result-all",method:"post",data:o}).success(function(q){m.resultAll=q,m.pairArr=q[0]?Array(q[0].length):[],console.log(q),m.buildRubricaBarData(q)})},m.buildRubricaBarData=function(o){var q=3;m.barData[0].values=[];for(var x,w=0;w<q;w++)x=w+1+" - "+(w+2),m.barData[0].values.push({label:x,value:0});o.forEach(function(w){var x=w.reduce(function(z,A){return z+A.val},0)/w.length,y=Math.min(Math.floor(x-1),q-1);m.barData[0].values[y].value+=1}),m.barOpts.chart.xAxis.axisLabel="Puntaje"},m.computeDif=function(){m.result&&function(){var o=m.result.findIndex(function(q){return"P"==m.users[q.uid].role});-1!=o&&function(){var q=m.result[o].val,w=[];m.result.forEach(function(x,y){y!=o&&w.push(Math.abs(q-x.val))}),m.buildRubricaDiffData(w)}()}()},m.buildRubricaDiffData=function(o){console.log("difs",o);var q=6;m.barData[0].values=[];for(var x,w=0;w<q;w++)x=0.5*w+" - "+0.5*(w+1),m.barData[0].values.push({label:x,value:0});o.forEach(function(w){var x=Math.min(Math.floor(2*w),q-1);m.barData[0].values[x].value+=1}),m.barOpts.chart.xAxis.axisLabel="Diferencia de Puntaje"},m.getReportAuthor=function(o){if(m.reports){var q=m.reports.find(function(w){return w.id==o});if(q)return m.users[q.uid]?m.users[q.uid].name:null}},m.getAvg=function(o){if(null==o||0==o.length)return"";var q=o.reduce(function(w,x){return w+x.val},0);return q/o.length},m.getInMax=function(o){if(null==o||0==o.length)return[];var q=o.reduce(function(w,x){return Math.max(w,x.length)},0);return Array(q)},m.showReport=function(o){b({url:"get-report",method:"post",data:{rid:o}}).success(function(w){h.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:m,resolve:{report:function report(){return w.author=m.users[w.uid],w}}})})},m.broadcastReport=function(o){var q={sesid:m.selectedSes.id,rid:o};b({url:"set-eval-report",method:"post",data:q}).success(function(){l.success("Reporte enviado a alumnos")})}}),adpp.controller("ReportModalController",function(a,b,g){var h=this;h.report=g,h.cancel=function(){b.dismiss("cancel")}}),adpp.controller("GroupController",function(a,b,g){var h=a;h.methods=["Aleatorio","Rendimiento Homogeneo","Rendimiento Heterogeneo","Tipo Aprendizaje Homogeneo","Tipo Aprendizaje Heterogeoneo"],h.lastI=-1,h.lastJ=-1,h.shared.verifyGroups=function(){h.groupNum=3,h.groupMet=h.methods[0],h.groups=[],h.groupNames=[],null!=h.selectedSes&&h.selectedSes.grouped&&(h.groupNum=null,h.groupMet=null,h.generateGroups(!0))},h.generateGroups=function(l){if(null==l&&(1>h.groupNum||h.groupNum>h.users.length))return void g.error("Error en los par\xE1metros de formaci\xF3n de grupos");var m={sesid:h.selectedSes.id,gnum:h.groupNum,method:h.groupMet},o="";"S"==h.selectedSes.type?o="group-proposal-sel":"L"==h.selectedSes.type&&(o="group-proposal-lect"),"Tipo Aprendizaje Homogeneo"==h.groupMet||"Tipo Aprendizaje Heterogeoneo"==h.groupMet?o="group-proposal-hab":"Aleatorio"==h.groupMet&&(o="group-proposal-rand"),""!=o&&b({url:o,method:"post",data:m}).success(function(q){h.groups=q,h.groupsProp=angular.copy(h.groups),console.log(q),h.groupNames=[]})},h.acceptGroups=function(){if(null==h.groupsProp)return void g.error("No hay propuesta de grupos para fijar");var l={sesid:h.selectedSes.id,groups:JSON.stringify(h.groupsProp.map(function(m){return m.map(function(o){return o.uid})}))};console.log(l),b({url:"set-groups",method:"post",data:l}).success(function(m){"ok"==m.status&&(console.log("Groups accepted"),h.selectedSes.grouped=!0,h.shared.verifyGroups())})},h.swapTable=function(l,m){if(console.log(l,m,h.groups),-1==h.lastI&&-1==h.lastJ)return h.lastI=l,void(h.lastJ=m);if(h.lastI!=l||h.lastJ!=m){var o=angular.copy(h.groupsProp[l][m]);h.groupsProp[l][m]=angular.copy(h.groupsProp[h.lastI][h.lastJ]),h.groupsProp[h.lastI][h.lastJ]=o}h.lastI=-1,h.lastJ=-1}}),adpp.controller("RubricaController",function(a,b){var g=a;g.criterios=[],g.newCriterio={},g.editable=!1,g.exampleReports=[],g.newExampleReport="",g.addCriterio=function(){g.criterios.push(g.newCriterio),g.newCriterio={}},g.removeCriterio=function(h){g.criterios.splice(h,1)},g.checkSum=function(){return 100==g.criterios.reduce(function(h,l){return h+l.pond},0)},g.shared.getRubrica=function(){g.criterios=[],g.newCriterio={},g.editable=!1;var h={sesid:g.selectedSes.id};b({url:"get-admin-rubrica",method:"post",data:h}).success(function(l){0==l.length?g.editable=!0:g.criterios=l})},g.saveRubrica=function(){var h={sesid:g.selectedSes.id};b({url:"send-rubrica",method:"post",data:h}).success(function(l){"ok"==l.status&&function(){var m=l.id;g.criterios.forEach(function(o){var q=angular.copy(o);q.rid=m,b({url:"send-criteria",method:"post",data:q}).success(function(w){"ok"==w.status&&console.log("Ok")})}),g.editable=!1}()})},g.shared.getExampleReports=function(){g.exampleReports=[];var h={sesid:g.selectedSes.id};b({url:"get-example-reports",method:"post",data:h}).success(function(l){g.exampleReports=l})},g.sendExampleReport=function(){var h={sesid:g.selectedSes.id,content:g.newExampleReport.text,title:g.newExampleReport.title};b({url:"send-example-report",method:"post",data:h}).success(function(){g.newExampleReport="",g.shared.getExampleReports()})},g.setActiveExampleReport=function(h){var l={sesid:g.selectedSes.id,rid:h.id};b({url:"set-active-example-report",method:"post",data:l}).success(function(m){"ok"==m.status&&(g.exampleReports.forEach(function(o){o.active=!1}),h.active=!0)})},g.goToReport=function(h){g.setActiveExampleReport(h),window.location.href="to-rubrica?sesid="+g.selectedSes.id},g.pairAssign=function(){var h={sesid:g.selectedSes.id,rnum:2};b({url:"assign-pairs",method:"post",data:h}).success(function(l){"ok"==l.status?(g.selectedSes.paired=!0,g.errPairMsg=""):g.errPairMsg=l.msg})}}),adpp.controller("DashboardRubricaController",function(a){var g=a;g.reports=[],g.result=[],g.selectedReport=null,g.shared.resetRubricaGraphs=function(){g.alumState=null,g.barOpts={chart:{type:"multiBarChart",height:320,x:function x(h){return h.label},y:function y(h){return h.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},g.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},g.shared.resetRubricaGraphs()});
