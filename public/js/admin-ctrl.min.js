"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification","ngQuill","ngMap"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;window.DIC=null,window.warnDIC={},adpp.config(["ngQuillConfigProvider",function(e){e.set({modules:{formula:!0,toolbar:{container:[["bold","italic","underline","strike"],// toggled buttons
[{color:[]},{background:[]}],// dropdown with defaults from theme
[{font:[]}],[{align:[]}],//[{ 'header': 1 }, { 'header': 2 }],               // custom button values
[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],// superscript/subscript
//[{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
//[{ 'direction': 'rtl' }],                         // text direction
//['blockquote', 'code-block'],
[{size:["small",!1,"large","huge"]}],// custom dropdown
//[{ 'header': [1, 2, 3, 4, 5, 6, false] }],
["clean"],// remove formatting button
["image","link","video"],// remove formatting button
["formula"]//['map']
],handlers:{map:quillMapHandler}}}})}]),adpp.controller("AdminController",function(e,t,s,a,r,o){var n=e;n.temp="",r.NUMBER_FORMATS.GROUP_SEP="",n.shared={},n.sessions=[],n.selectedSes=null,n.documents=[],n.questions=[],n.questionTexts=[],n.newUsers=[],n.users={},n.selectedId=-1,n.sesStatusses=["notPublicada","reading","personal","anon","teamWork","finished"],n.optConfidence=[0,25,50,75,100],n.iterationNames=[],n.showSeslist=!0,n.lang="english",n.secIcons={configuration:"cog",editor:"edit",dashboard:"bar-chart",users:"male",rubrica:"check-square",groups:"users",options:"sliders"},n.typeNames={L:"readComp",S:"multSel",M:"semUnits",E:"ethics"},n.misc={},n.init=function(){n.shared.updateSesData(),n.updateLang(n.lang)},n.selectSession=function(e,t){n.selectedId=t,n.selectedSes=e,n.requestDocuments(),n.requestSemDocuments(),n.requestQuestions(),n.getNewUsers(),n.getMembers(),n.shared.verifyGroups(),n.shared.resetGraphs(),n.shared.verifyTabs(),n.shared.resetTab(),n.shared.updateConf(),a.path(n.selectedSes.id)},n.shared.updateSesData=function(){t({url:"get-session-list",method:"post"}).success(function(e){if(console.log("Session data updated"),n.sessions=e,-1!=n.selectedId){var t=n.sessions.find(function(t){return t.id==n.selectedId});null!=t&&n.selectSession(t,n.selectedId)}else n.sesFromURL()})},n.sesFromURL=function(){var t=+a.path().substring(1),s=n.sessions.find(function(s){return s.id==t});null!=s&&n.selectSession(s,t)},n.requestDocuments=function(){var e={sesid:n.selectedSes.id};t({url:"documents-session",method:"post",data:e}).success(function(e){n.documents=e})},n.shared.updateDocuments=n.requestDocuments,n.deleteDocument=function(e){t({url:"delete-document",method:"post",data:{docid:e}}).success(function(){n.requestDocuments()})},n.requestQuestions=function(){var e={sesid:n.selectedSes.id};t({url:"questions-session",method:"post",data:e}).success(function(e){n.questions=e.map(function(t){return t.options=t.options.split("\n"),t})}),t({url:"get-question-text",method:"post",data:e}).success(function(e){n.questionTexts=e})},n.requestSemDocuments=function(){var e={sesid:n.selectedSes.id};t({url:"semantic-documents",method:"post",data:e}).success(function(e){n.semDocs=e})},n.getNewUsers=function(){var e={sesid:n.selectedSes.id};t({url:"get-new-users",method:"post",data:e}).success(function(e){n.newUsers=e})},n.getMembers=function(){var e={sesid:n.selectedSes.id};t({url:"get-ses-users",method:"post",data:e}).success(function(e){n.usersArr=e,n.users={},e.forEach(function(e){n.users[e.id]=e})})},n.openNewSes=function(){s.open({templateUrl:"templ/new-ses.html"})},n.openDuplicateSes=function(){if(null!=n.selectedSes){var e=angular.copy(n.selectedSes);s.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:n,resolve:{data:function(){return e}}})}},n.openDuplicateSesSpec=function(e,t){t.stopPropagation();var a=angular.copy(e);s.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:n,resolve:{data:function(){return a}}})},n.toggleSidebar=function(){n.openSidebar=!n.openSidebar,n.shared.updateState()},n.updateLang=function(e){t.get("data/"+e+".json").success(function(e){window.DIC=e})},n.shared.resetSesId=function(){n.selectedId=-1},n.changeLang=function(){n.lang="english"==n.lang?"spanish":"english",n.updateLang(n.lang)},n.generateCode=function(){var e={id:n.selectedSes.id};t.post("generate-session-code",e).success(function(e){null!=e.code&&(n.selectedSes.code=e.code)})},n.flang=function(e){return o("lang")(e)},n.init()}),adpp.controller("TabsController",function(e){var t=e;t.tabOptions=[],t.tabConfig=["users","groups"],t.selectedTab="",t.shared.resetTab=function(){t.selectedTab="editor",null!=t.selectedSes&&1<t.selectedSes.status&&(t.selectedTab="dashboard"),t.selectedTabConfig=-1,7==t.selectedSes.status&&t.shared.gotoRubrica()},t.shared.verifyTabs=function(){"L"==t.selectedSes.type?(t.iterationNames=[{name:"reading",val:0},{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3},{name:"report",val:4},{name:"rubricCalib",val:5},{name:"pairEval",val:6}],t.tabOptions=["editor","users","groups","rubrica","dashboard"],t.sesStatusses=["configuration","reading","individual","anon","teamWork","report","rubricCalib","pairEval","finished"],t.shared.getRubrica(),t.shared.getExampleReports(),t.shared.getReports()):"S"==t.selectedSes.type?(t.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],t.tabOptions=["editor","users","groups","dashboard"],t.sesStatusses=["configuration","individual","anon","teamWork","finished"]):"M"==t.selectedSes.type?(t.iterationNames=[{name:"individual",val:1},{name:"teamWork",val:3},{name:"report",val:4},{name:"pairEval",val:6}],t.tabOptions=["editor","users","groups","rubrica","dashboard"],t.sesStatusses=[{i:-1,name:"configuration"},{i:1,name:"individual"},{i:3,name:"teamWork"},{i:4,name:"report"},{i:6,name:"pairEval"},{i:7,name:"finished"}],t.shared.getRubrica(),t.shared.getExampleReports(),t.shared.getReports()):"E"==t.selectedSes.type&&(t.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],t.tabOptions=["editor","users","groups","dashboard"],t.sesStatusses=["configuration","individual","anon","teamWork","finished"]),1<t.selectedSes.status&&(t.selectedTab="dashboard")},t.setTab=function(e){t.selectedTab=e},t.setTabConfig=function(e){t.selectedTabConfig=e},t.backToList=function(){t.shared.resetSesId(),t.tabOptions=[],t.selectedTab=""},t.shared.gotoGrupos=function(){t.selectedTab="groups"},t.shared.gotoRubrica=function(){t.selectedTab="rubrica"}}),adpp.controller("DocumentsController",function(e,t,s,a){var r=e;r.busy=!1,r.dfs=[],r.shared.dfs=r.dfs,r.getDifferentials=function(){t.post("differentials",{sesid:r.selectedSes.id}).success(function(e){e.forEach(function(e){e.name=e.title,r.dfs[e.orden]=e})})},r.uploadDocument=function(e){r.busy=!0;var o=new FormData(e.target);t.post("upload-file",o,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(t){"ok"==t.status&&a(function(){s.success("Documento cargado correctamente"),e.target.reset(),r.busy=!1,r.shared.updateDocuments()},2e3)})},r.sendDFS=function(){var e=0;r.misc.dfSending=!0,r.dfs.forEach(function(a,o){var d=a.id?"update-differential":"add-differential";a.orden=o,a.sesid=r.selectedSes.id,t.post(d,a).success(function(){e+=1,e==r.dfs.length-1&&(s.success("Diferenciales guardados correctamente"),r.misc.dfSending=!1,r.getDifferentials())})})},r.shared.sendDFS=r.sendDFS,r.getDifferentials()}),adpp.controller("SesEditorController",function(e,t,s){var a=e;a.mTransition={1:3,3:5,5:6,6:8,8:9},a.splitDescr=!1,a.splDes1="",a.splDes2="",a.toggleSplit=function(){a.splitDescr=!a.splitDescr,a.splitDescr?(a.splDes1=a.selectedSes.descr.split("\n")[0],a.splDes2=a.selectedSes.descr.split("\n")[1]||""):a.selectedSes.descr=a.splDes1+"\n"+a.splDes2},a.updateSession=function(){if(a.splitDescr&&(a.selectedSes.descr=a.splDes1+"\n"+a.splDes2),3>a.selectedSes.name.length||5>a.selectedSes.descr.length)return void s.error("Datos de la sesi\xF3n incorrectos o incompletos");var e={name:a.selectedSes.name,descr:a.selectedSes.descr,id:a.selectedSes.id};t({url:"update-session",method:"post",data:e}).success(function(){console.log("Session updated")})},a.shared.changeState=function(){if("M"!=a.selectedSes.type&&a.selectedSes.status>=a.sesStatusses.length)return void s.error("La sesi\xF3n est\xE1 finalizada");if("M"==a.selectedSes.type&&9<=a.selectedSes.status)return void s.error("La sesi\xF3n est\xE1 finalizada");if("L"==a.selectedSes.type&&3<=a.selectedSes.status&&!a.selectedSes.grouped||"M"==a.selectedSes.type&&3<=a.selectedSes.status&&!a.selectedSes.grouped||"E"==a.selectedSes.type&&2<=a.selectedSes.status&&!a.selectedSes.grouped||"S"==a.selectedSes.type&&2<=a.selectedSes.status&&!a.selectedSes.grouped)return a.shared.gotoGrupos(),void s.error("Los grupos no han sido generados");if("L"==a.selectedSes.type&&6<=a.selectedSes.status&&a.shared.isRubricaSet&&!a.shared.isRubricaSet()||"M"==a.selectedSes.type&&5<=a.selectedSes.status&&a.shared.isRubricaSet&&!a.shared.isRubricaSet())return a.shared.gotoRubrica(),void s.error("La r\xFAbrica no ha sido asignada");if("L"==a.selectedSes.type&&7<=a.selectedSes.status&&(null==a.selectedSes.paired||0==a.selectedSes.paired)||"M"==a.selectedSes.type&&6<=a.selectedSes.status&&(null==a.selectedSes.paired||0==a.selectedSes.paired))return a.shared.gotoRubrica(),void s.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");"E"==a.selectedSes.type&&0==a.selectedSes.status&&a.shared.sendDFS();var e=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(e)if("M"==a.selectedSes.type){var r={sesid:a.selectedSes.id,state:a.mTransition[a.selectedSes.status]||a.selectedSes.status};t({url:"force-state-session",method:"post",data:r}).success(function(){a.shared.updateSesData()})}else{1==a.selectedSes.status&&(a.updateSession(),"S"==a.selectedSes.type&&a.shared.saveConfs());var o={sesid:a.selectedSes.id};t({url:"change-state-session",method:"post",data:o}).success(function(){a.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(e,t,s){var a=e;a.addToSession=function(){if(0==a.newMembs.length)return void s.error("No hay usuarios seleccionados para agregar");var e={users:a.newMembs.map(function(t){return t.id}),sesid:a.selectedSes.id};t({url:"add-ses-users",method:"post",data:e}).success(function(e){"ok"==e.status&&a.refreshUsers()})},a.removeUser=function(e){if(2>=a.selectedSes.status){var s={uid:e,sesid:a.selectedSes.id};t({url:"delete-ses-user",method:"post",data:s}).success(function(e){"ok"==e.status&&a.refreshUsers()})}},a.refreshUsers=function(){a.getNewUsers(),a.getMembers()},a.shared.refreshUsers=a.refreshUsers}),adpp.controller("SemDocController",function(e,t,s){var a=e;a.newSDoc={id:null,title:"",content:""},a.addSemDoc=function(){var e={sesid:a.selectedSes.id,title:a.newSDoc.title,content:a.newSDoc.content};t({url:"add-semantic-document",method:"post",data:e}).success(function(e){"ok"==e.status&&(a.requestSemDocuments(),s.success("Texto agregado correctamente"),a.newSDoc={id:null,title:"",content:""})})},a.deleteText=function(e){t.post("delete-semantic-document",{id:e}).success(function(e){"ok"==e.status&&(a.requestSemDocuments(),s.success("Texto eliminado correctamente"))})},a.startEditText=function(e){a.newSDoc={id:e.id,title:e.title,content:e.content},s.info("Edite el texto en el formulario")},a.updateSemDoc=function(){if(null==a.newSDoc.id)return void s.error("No hay texto a editar.");var e={id:a.newSDoc.id,sesid:a.selectedSes.id,title:a.newSDoc.title,content:a.newSDoc.content};t({url:"update-semantic-document",method:"post",data:e}).success(function(e){"ok"==e.status&&(a.requestSemDocuments(),s.success("Texto editado correctamente."),a.newSDoc={id:null,title:"",content:""})})}}),adpp.controller("QuestionsController",function(e,t,s,a,r,o){var d=e;d.qsLabels=["A","B","C","D","E"],d.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},d.newText={id:null,title:"",content:""},d.newQsExp=!1,d.startNewQuestion=function(){d.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},d.newQsExp=!0,d.shared.closePrevMapData()},d.selectAnswer=function(e){d.newQuestion.answer=e},d.addQuestion=function(){if(-1==d.newQuestion.answer)return void s.error("Debe indicar la respuesta correcta a la pregunta");if(""==d.newQuestion.alternatives[0]||""==d.newQuestion.alternatives[1])return void s.error("Debe ingresar al menos 2 alternativas");if(d.newQuestion.alternatives.some(function(t,e){return d.newQuestion.alternatives.indexOf(t)!=e}))return void s.error("Hay alternativas duplicadas");if(""==d.newQuestion.comment)return void s.error("Debe ingresar un comentario para la pregunta");d.newQuestion.includesMap&&i();var e={content:d.newQuestion.content,options:d.newQuestion.alternatives.join("\n"),comment:d.newQuestion.comment,answer:d.newQuestion.answer,sesid:d.selectedSes.id,textid:d.newQuestion.textid,other:d.newQuestion.other,pluginData:d.newQuestion.pluginData};t({url:"add-question",method:"post",data:e}).success(function(e){"ok"==e.status&&(d.requestQuestions(),s.success("Pregunta agrgada correctamente"),d.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},d.shared.sendOverlayBuffer&&d.shared.sendOverlayBuffer(e.id),d.newQsExp=!1)})},d.updateQuestion=function(){if(null==d.newQuestion.id)return void s.error("No hay pregunta para editar");if(-1==d.newQuestion.answer)return void s.error("Debe indicar la respuesta correcta a la pregunta");d.newQuestion.includesMap&&i();var e={id:d.newQuestion.id,content:d.newQuestion.content,options:d.newQuestion.alternatives.join("\n"),comment:d.newQuestion.comment,answer:d.newQuestion.answer,sesid:d.selectedSes.id,textid:d.newQuestion.textid,other:d.newQuestion.other,pluginData:d.newQuestion.pluginData};t({url:"update-question",method:"post",data:e}).success(function(t){"ok"==t.status&&(d.requestQuestions(),s.success("Pregunta editada correctamente"),d.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},d.shared.sendOverlayBuffer&&d.shared.sendOverlayBuffer(e.id),d.newQsExp=!1)})},d.startEditQuestion=function(e){d.questions.forEach(function(e){return e.expanded=!1}),d.newQuestion={id:e.id,content:e.content,alternatives:e.options,comment:e.comment,other:e.other,textid:e.textid,answer:e.answer,includesMap:e.plugin_data&&e.plugin_data.startsWith("MAP")},s.info("Edite la pregunta en el formulario."),d.newQuestion.includesMap&&(d.shared.clearOverlayBuffer&&d.shared.clearOverlayBuffer(),d.shared.processMapData(e.plugin_data,e.id),n()),d.newQsExp=!0},d.startEditText=function(e){d.newText={id:e.id,title:e.title,content:e.content},s.info("Edite el texto en el formulario."),d.newTextExp=!0},d.addQuestionText=function(){var e={sesid:d.selectedSes.id,title:d.newText.title,content:d.newText.content};t({url:"add-question-text",method:"post",data:e}).success(function(e){"ok"==e.status&&(d.requestQuestions(),d.newText={id:null,title:"",content:""},d.newTextExp=!1)})},d.updateQuestionText=function(){if(null==d.newText.id)return void s.error("No hay texto para editar");var e={id:d.newText.id,sesid:d.selectedSes.id,title:d.newText.title,content:d.newText.content};t({url:"update-question-text",method:"post",data:e}).success(function(e){"ok"==e.status&&(d.requestQuestions(),d.newText={title:"",content:""},d.newTextExp=!1)})},d.deleteQuestion=function(e){t.post("delete-question",{id:e}).success(function(){d.requestQuestions(),d.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},s.success("Pregunta eliminada correctamente")})},d.deleteQuestionText=function(e){t.post("delete-question-text",{id:e}).success(function(){d.requestQuestions(),s.success("Texto eliminado correctamente")})},d.configQuillExtra=function(e){d.editor=e},d.toggleMapPlugin=function(){d.newQuestion.includesMap=!d.newQuestion.includesMap,d.newQuestion.includesMap&&n()},d.expandQuestion=function(e){e.expanded?(e.expanded=!1,d.shared.closePrevMapData()):(d.questions.forEach(function(e){return e.expanded=!1}),e.expanded=!0,e.plugin_data&&e.plugin_data.startsWith("MAP")&&d.shared.processPrevMapData(e.plugin_data,e.id))};var n=function(){o(function(){var e=d.shared.getActiveMap();google.maps.event.trigger(e,"resize")},1e3)},i=function(){var e=d.shared.getPluginMapOptions(),t=d.shared.getActiveMap();if(null==t)//});
return void s.error("Ocurrio un error al cargar los datos del mapa, intente nuevamente.");var a=t.getCenter().lat(),r=t.getCenter().lng(),o=t.getZoom();d.newQuestion.pluginData="MAP "+a+" "+r+" "+o+(e.nav?" NAV":"")+(e.edit?" EDIT":"")}}),adpp.controller("DashboardController",function(e,t,s,a,r){var o=Math.floor,d=Math.max,n=Math.min,l=e;l.iterationIndicator=1,l.currentTimer=null,l.showCf=!1,l.dataDF=[],l.dataChatCount={},l.shared.resetGraphs=function(){null!=l.selectedSes&&"L"==l.selectedSes.type?l.iterationIndicator=d(n(6,l.selectedSes.status-2),0):"S"==l.selectedSes.type?l.iterationIndicator=d(n(3,l.selectedSes.status-1),1):"M"==l.selectedSes.type&&(l.iterationIndicator=d(n(6,l.selectedSes.status-2),0)),l.alumState=null,l.barOpts={chart:{type:"multiBarChart",height:320,x:function(e){return e.label},y:function(e){return e.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:l.flang("students")}}},l.barData=[{key:l.flang("students"),color:"#0077c1",values:[]}],l.updateState(),DASHBOARD_AUTOREALOD&&9>l.selectedSes.status&&l.reload(!0)},l.reload=function(e){e||l.updateState(),null!=l.currentTimer&&s.cancel(l.currentTimer),l.currentTimer=s(l.reload,15000)},l.updateState=function(){1==l.selectedSes.status?l.shared.refreshUsers():4>=l.iterationIndicator?l.updateStateIni():l.updateStateRub()},l.shared.updateState=l.updateState,l.updateStateIni=function(){l.alumTime={};var e={sesid:l.selectedSes.id,iteration:l.iterationIndicator};if("S"==l.selectedSes.type)t({url:"get-alum-full-state-sel",method:"post",data:e}).success(function(e){for(var s in l.alumState={},l.users)"A"==l.users[s].role&&(l.alumState[s]={});e.forEach(function(e){null==l.alumState[e.uid]?(l.alumState[e.uid]={},l.alumState[e.uid][e.qid]=e.correct):l.alumState[e.uid][e.qid]=e.correct}),3==l.iterationIndicator&&t({url:"get-original-leaders",method:"post",data:{sesid:l.selectedSes.id}}).success(function(e){var t=angular.copy(l.alumState);l.alumState={},l.leaderTeamStr={},l.leaderTeamId={},e.forEach(function(e){l.alumState[e.leader]=t[e.leader],l.leaderTeamStr[e.leader]=e.team.map(function(e){return l.users[e]?l.users[e].name:"- "}).join(", "),l.leaderTeamId[e.leader]=e.id})}),l.shared.alumState=l.alumState}),t({url:"get-alum-state-sel",method:"post",data:e}).success(function(e){var t=e.map(function(e){return e.score/=l.questions.length,e});l.buildBarData(t)}),t({url:"get-alum-confidence",method:"post",data:e}).success(function(e){l.confidence={},e.forEach(function(e){l.confidence[e.qid]||(l.confidence[e.qid]={}),l.confidence[e.qid][e.conf]=e.freq})});else if("L"==l.selectedSes.type)t({url:"get-alum-state-lect",method:"post",data:e}).success(function(s){for(var a in l.alumState={},l.users)"A"==l.users[a].role&&(l.alumState[a]={});s.forEach(function(e){l.alumState[e.uid]=null==l.alumState[e.uid]?e:e}),l.buildBarData(s),l.getAlumDoneTime(e),3==l.iterationIndicator&&t({url:"get-original-leaders",method:"post",data:{sesid:l.selectedSes.id}}).success(function(e){var t=angular.copy(l.alumState);l.alumState={},l.leaderTeamStr={},e.forEach(function(e){l.alumState[e.leader]=t[e.leader],l.leaderTeamStr[e.leader]=e.team.map(function(e){return l.users[e]?l.users[e].name:"- "}).join(", ")})}),l.shared.alumState=l.alumState}),t({url:"get-ideas-progress",method:"post",data:e}).success(function(e){l.numProgress=0,l.numUsers=Object.keys(l.users).length-1;var t=3*l.documents.length;0!=t&&(e.forEach(function(e){l.numProgress+=e.count/t}),l.numProgress*=100/l.numUsers)});else if("M"==l.selectedSes.type)t({url:"get-alum-state-semantic",method:"post",data:e}).success(function(s){for(var a in l.alumState={},l.numUsers=0,l.users)"A"==l.users[a].role&&(l.alumState[a]={},l.numUsers++);s.forEach(function(e){l.alumState[e.uid]=null==l.alumState[e.uid]?e:e}),l.buildBarData(s),l.getAlumDoneTime(e),3==l.iterationIndicator&&t({url:"get-original-leaders",method:"post",data:{sesid:l.selectedSes.id}}).success(function(e){var t=angular.copy(l.alumState);l.alumState={},l.leaderTeamStr={},e.forEach(function(e){l.alumState[e.leader]=t[e.leader],l.leaderTeamStr[e.leader]=e.team.map(function(e){return l.users[e]?l.users[e].name:"- "}).join(", ")})}),l.shared.alumState=l.alumState});else if("E"==l.selectedSes.type){var s={sesid:l.selectedSes.id},a=l.selectedSes.grouped?"get-differential-all":"get-differential-indv";t.post(a,s).success(function(e){l.dataDF=[],console.log("SELF"),console.log(l);var a=-1,r=-1,o=["","ind","anon","team"];e.forEach(function(e){if(e.tmid!=a){r+=1,a=e.tmid;var t=e.uid,s=1;if(l.shared.groups){var d=l.shared.groups.find(function(s){return s.some(function(e){return e.uid==t})});s=d?d.length:1}l.dataDF.push({tmid:a,ind:[],anon:[],team:[],glen:s})}l.dataDF[r][o[e.iteration]].push(e)}),t.post("get-chat-count",s).success(function(e){l.dataChatCount={},e.forEach(function(e){l.dataChatCount[e.tmid]||(l.dataChatCount[e.tmid]={}),l.dataChatCount[e.tmid][e.orden]=e.count})}),l.shared.dataDF=l.dataDF})}},l.avgAlum=function(e){if(null!=l.alumState&&null!=l.alumState[e]){var s=0,a=0;for(var r in l.alumState[e])l.alumState[e][r]&&a++,s++;return 0<s?100*a/s:0}return 0},l.avgPreg=function(e){if(null!=l.alumState){var s=0,a=0;for(var r in l.alumState)null!=l.alumState[r]&&null!=l.alumState[r][e]&&(l.alumState[r][e]&&a++,s++);return 0<s?100*a/s:0}return 0},l.avgAll=function(){var e=0,s=0;if(null!=l.alumState)for(var a in l.alumState)for(var r in l.alumState[a])l.alumState[a][r]&&s++,e++;return 0<e?100*s/e:0},l.progress=function(){var e=0;if(null!=l.alumState){for(var s in l.alumState)for(var a in l.alumState[s])e++;return 100*e/(Object.keys(l.alumState).length*l.questions.length)}return 0},l.progressAlum=function(e){var s=0;if(null!=l.alumState&&null!=l.alumState[e]){for(var a in l.alumState[e])s++;return 100*s/l.questions.length}return 0},l.progressPreg=function(e){var s=0;if(null!=l.alumState){for(var a in l.alumState)null!=l.alumState[a][e]&&s++;return 100*s/Object.keys(l.alumState).length}return 0},l.lectPerformance=function(){var e=0,s=0;if(null!=l.alumState){for(var r in l.alumState){var o=l.alumState[r];e++,s+=o.score}return 100*s/e}return 0},l.DFAll=function(e,t){return e.filter(function(s){return s.orden==t}).map(function(t){return t.sel})},l.DFL=function(e,t){return e.filter(function(s){return s.orden==t}).length},l.DFAvg=function(e,t){var s=e.filter(function(s){return s.orden==t}).map(function(t){return t.sel});return 0<s.length?s.reduce(function(t,s){return t+s},0)/s.length:0},l.DFMinMax=function(e,t){var s=e.filter(function(s){return s.orden==t}).map(function(t){return t.sel});s.sort();var a=s.length-1;return s[a]-s[0]},l.DFColor=function(e,t){var s=l.DFAvg(e,t),r=0,a=e.filter(function(s){return s.orden==t}).map(function(t){return t.sel});a.forEach(function(e){r+=(e-s)*(e-s)});var o=Math.sqrt(r/a.length);return 1>=o?"bg-darkgreen":2.8<o?"bg-red":"bg-yellow"},l.getAlumDoneTime=function(e){t({url:"get-alum-done-time",method:"post",data:e}).success(function(e){l.numComplete=0,e.forEach(function(e){l.numComplete+=1,null==l.alumState[e.uid]?l.alumState[e.uid]=e:l.alumState[e.uid].dtime=~~e.dtime})})},l.buildBarData=function(e){l.barData[0].values=[];for(var t,s=0;s<5;s++)t=20*s+"% - "+20*(s+1)+"%",l.barData[0].values.push({label:t,value:0});e.forEach(function(e){var t=n(o(5*e.score),4);l.barData[0].values[t].value+=1}),l.barOpts.chart.xAxis.axisLabel=l.flang("performance")},l.updateStateRub=function(){5==l.iterationIndicator?l.computeDif():6==l.iterationIndicator&&l.getAllReportResult()},l.showName=function(e){return e.example?e.title+" - "+l.flang("exampleReport"):e.id+" - "+l.flang("reportOf")+" "+l.users[e.uid].name},l.shared.getReports=function(){var e={sesid:l.selectedSes.id};t({url:"get-report-list",method:"post",data:e}).success(function(e){l.reports=e,l.exampleReports=e.filter(function(t){return t.example})})},l.getReportResult=function(){var e={repid:l.selectedReport.id};t({url:"get-report-result",method:"post",data:e}).success(function(e){l.result=e,l.updateState()})},l.getAllReportResult=function(){var e={sesid:l.selectedSes.id};t({url:"get-report-result-all",method:"post",data:e}).success(function(e){l.resultAll={};var t=e.length;for(var s in l.users)"A"==l.users[s].role&&(l.resultAll[s]={reviews:0,data:[]});//console.log(self.resul);
e.forEach(function(e){if(null!=e&&0<e.length){var s=l.getReportAuthor(e[0].rid);-1!=s&&null==l.resultAll[s].data?l.resultAll[s].data=e:-1!=s&&(l.resultAll[s].data=e),e.forEach(function(e){l.resultAll[e.uid].reviews+=t})}}),l.pairArr=e[0]?Array(e[0].length):[],l.buildRubricaBarData(e)})},l.buildRubricaBarData=function(e){var t=["1 - 2","2 - 3","3 - 4"];//let rubnms = [self.flang("") + "-" + self.flang(""), "Proceso-Competente", "Competente-Avanzado"];
l.barData[0].values=[];for(var s,a=0;a<3;a++)s=a+1+" - "+(a+2)+" ("+t[a]+")",l.barData[0].values.push({label:s,value:0});e.forEach(function(e){var t=e.reduce(function(t,e){return t+e.val},0)/e.length,s=n(o(t-1),2);l.barData[0].values[s].value+=1}),l.barOpts.chart.xAxis.axisLabel=l.flang("scoreDist")},l.computeDif=function(){if(l.result){var t=l.result.findIndex(function(t){return"P"==l.users[t.uid].role});if(-1!=t){var s=l.result[t].val,a=[];l.result.forEach(function(r,e){e!=t&&a.push(Math.abs(s-r.val))}),l.buildRubricaDiffData(a)}}},l.buildRubricaDiffData=function(e){console.log("difs",e);var t=l.flang("high2lowScale").split(",");l.barData[0].values=[];for(var s=0;s<5;s++)// let lbl = (i * 0.5) + " - " + (i + 1) * 0.5;
l.barData[0].values.push({label:t[s],value:0});e.forEach(function(e){var t=n(o(2*e),4);l.barData[0].values[t].value+=1}),l.barOpts.chart.xAxis.axisLabel=l.flang("correctDistance")},l.getReportAuthor=function(t){if(l.reports){var s=l.reports.find(function(s){return s.id==t});return s?s.uid:-1}return-1},l.getAvg=function(e){if(null==e||0==e.length)return"";var t=e.reduce(function(t,s){return t+s.val},0);return t/e.length},l.getInMax=function(e){if(null==e)return[];var t=0;for(var s in e)t=d(t,e[s].data.length);return Array(t)},l.showReport=function(e){t({url:"get-report",method:"post",data:{rid:e}}).success(function(e){var s={report:e,criterios:l.shared.obtainCriterios()};s.report.author=l.users[e.uid];var r={repid:e.id};t({url:"get-report-result",method:"post",data:r}).success(function(e){s.answers=e,t.post("get-criteria-selection-by-report",r).success(function(e){s.answersRubrica={},e.forEach(function(e){null==s.answersRubrica[e.uid]&&(s.answersRubrica[e.uid]={}),s.answersRubrica[e.uid][e.cid]=e.selection}),t.post("get-report-evaluators",r).success(function(e){e.forEach(function(t){var a=s.answers.findIndex(function(s){return s.uid==t.uid});-1==a?s.answers.push({uid:t.uid,evaluatorName:l.users[t.uid].name}):s.answers[a].evaluatorName=l.users[t.uid].name}),a.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",size:"lg",scope:l,resolve:{data:function(){return s}}})})})})})},l.showReportByUid=function(e){console.log(e);var s={uid:e,sesid:l.selectedSes.id};t({url:"get-report-uid",method:"post",data:s}).success(function(t){var s={report:t};s.report.author=l.users[e],a.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:l,resolve:{data:function(){return s}}})})},l.broadcastReport=function(e){var s={sesid:l.selectedSes.id,rid:e};t({url:"set-eval-report",method:"post",data:s}).success(function(){r.success("Reporte enviado a alumnos")})},l.showDetailAnswer=function(s,o,d){var e=["A","B","C","D","E"],n={uid:o,qid:s,iteration:d},i=l.questions.reduce(function(t,e){return e.id==s?e:t},null);3>d?t({url:"get-selection-comment",method:"post",data:n}).success(function(t){if(null==t||null==t.answer)return void r.warning("No hay respuesta registrada para el alumno");var s=e[t.answer]+". "+i.options[t.answer],d=i.content;a.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:l,resolve:{data:function(){return t.title=l.flang("answerOf")+" "+l.users[o].name,t.content=l.flang("question")+":\n"+d+"\n\n"+l.flang("answer")+":\n"+s+"\n\n"+l.flang("comment")+":\n"+(t.comment?t.comment:""),t.confidence&&(t.content+="\n\n"+l.flang("confidenceLevel")+": "+t.confidence+"%"),t}}})}):(n.tmid=l.leaderTeamId[o],t({url:"get-selection-team-comment",method:"post",data:n}).success(function(t){if(null==t||0==t.length)return void r.warning("No hay respuesta registrada para el grupo");var s=e[t[0].answer]+". "+i.options[t[0].answer],d=i.content;a.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:l,resolve:{data:function(){var e={};return e.title=l.flang("answerOf")+" "+l.leaderTeamStr[o],e.content=l.flang("question")+":\n"+d+"\n\n"+l.flang("answer")+":\n"+s+"\n\n",t.forEach(function(t){e.content+=l.flang("comment")+" "+t.uname+":\n"+(null==t.comment?"":t.comment)+"\n",null!=t.confidence&&(e.content+=l.flang("confidenceLevel")+": "+t.confidence+"%\n"),e.content+="\n"}),e}}})}))},l.openDFDetails=function(s,r){var o={sesid:l.selectedSes.id,tmid:s,orden:r};t.post("get-team-chat",o).success(function(e){a.open({templateUrl:"templ/differential-group.html",controller:"EthicsModalController",controllerAs:"vm",scope:l,resolve:{data:function(){var t={names:[l.flang("individual"),l.flang("anon"),l.flang("teamWork")],orden:r,group:s,users:l.users},a=l.dataDF.find(function(t){return t.tmid==s});// console.log(self.shared);
if(a.ind.some(function(t){return t.orden==r})){var o=a.ind.find(function(t){return t.orden==r});t.master=l.shared.dfs.filter(function(t){return t.id}).find(function(t){return t.id==o.did})}t.dfIters=[],t.dfIters.push(a.ind.filter(function(t){return t.orden==r})),t.dfIters.push(a.anon.filter(function(t){return t.orden==r})),t.dfIters.push(a.team.filter(function(t){return t.orden==r})),t.anonNames={},t.sesid=l.selectedSes.id;var d=0;return t.dfIters.flat().forEach(function(s){t.anonNames[s.uid]||(t.anonNames[s.uid]="ABCD"[d],d++)}),t.chat=e,t.chat.forEach(function(s){s.parent_id&&(s.parent=t.chat.find(function(t){return t.id==s.parent_id}))}),console.log(t),t}}})})}}),adpp.controller("MapSelectionModalController",function(e,t){var s=this;s.nav=!0,s.edit=!1,s.cancel=function(){t.dismiss("cancel")},s.resolve=function(){t.close({nav:s.nav,edit:s.edit})}}),adpp.controller("ReportModalController",function(e,t,s){var a=this;a.data=s,a.cancel=function(){t.dismiss("cancel")}}),adpp.controller("ContentModalController",function(e,t,s){var a=this;a.data=s,a.cancel=function(){t.dismiss("cancel")}}),adpp.controller("EthicsModalController",function(e,t,s,a,r){var o=this;o.data=r,o.isAnon=!0,o.cancel=function(){s.dismiss("cancel")},o.shareDetails=function(){if(!o.isAnon)return void a.error("S\xF3lo se pueden enviar diferenciales en forma an\xF3nima");var e=document.getElementById("details-modal").innerHTML.replace(/<\!--.*?-->/g,""),s={sesid:o.data.sesid,content:e};t({url:"broadcast-diff",method:"post",data:s}).success(function(){a.success("Diferencial enviado exitosamente")})}}),adpp.controller("DuplicateSesModalController",function(e,t,s,a){var r=this;r.data=a,r.nses={name:r.data.name,tipo:r.data.type,descr:r.data.descr,originalSesid:r.data.id,copyDocuments:!1,copyIdeas:!1,copyQuestions:!1,copyRubrica:!1,copyUsers:!1,copySemUnits:!1,copySemDocs:!1,copyDifferentials:!1},r.cancel=function(){s.dismiss("cancel")},r.sendDuplicate=function(){console.log(r.nses),t({url:"duplicate-session",method:"post",data:r.nses}).success(function(e){console.log(e),window.location.replace("admin")})}}),adpp.controller("GroupController",function(e,t,a){var o=e;o.methods=[],o.lastI=-1,o.lastJ=-1,o.groupMet="random",o.shared.verifyGroups=function(){o.methods=[d("random"),d("performance","homog"),d("performance","heterg"),d("knowledgeType","homog"),d("knowledgeType","heterg")],o.groupNum=3,o.groupMet=o.methods[0].key,o.groups=[],o.groupNames=[],null!=o.selectedSes&&o.selectedSes.grouped&&(o.groupNum=null,o.groupMet=null,o.generateGroups(!0))};var d=function(e,t){return{key:e+(null==t?"":" "+t),name:o.flang(e)+(null==t?"":" "+o.flang(t))}};o.generateGroups=function(e){if(o.selectedSes.grouped)return void t({url:"group-proposal-sel",method:"post",data:{sesid:o.selectedSes.id}}).success(function(e){o.groups=e,o.shared.groups=o.groups,console.log("G",e)});if(null==e&&(1>o.groupNum||o.groupNum>o.users.length))return void a.error("Error en los par\xE1metros de formaci\xF3n de grupos");var r={sesid:o.selectedSes.id,gnum:o.groupNum,method:o.groupMet};console.log(r),console.log(o.shared.alumState);var d=Object.values(o.users).filter(function(t){return"A"==t.role});if(console.log(d),"knowledgeType homog"==o.groupMet||"knowledgeType heterg"==o.groupMet)o.groups=generateTeams(d,habMetric,o.groupNum,isDifferent(o.groupMet));else if("random"==o.groupMet){var n=d.map(function(t){return t.rnd=Math.random(),t});o.groups=generateTeams(n,function(e){return e.rnd},o.groupNum,!1)}else if("S"==o.selectedSes.type||"M"==o.selectedSes.type){console.log(o.shared.alumState);var i=[];for(var l in o.shared.alumState){var u=0;for(var c in o.shared.alumState[l])u+=+c;i.push({uid:l,score:u})}o.groups=generateTeams(i,function(e){return e.score},o.groupNum,isDifferent(o.groupMet))}else if("L"==o.selectedSes.type)o.groups=generateTeams(o.shared.alumState,function(e){return e.score},o.groupNum,isDifferent(o.groupMet));else if("E"==o.selectedSes.type){console.log("AAAAA");var p=d.map(function(t){var e=o.shared.dataDF||[],s=e.find(function(e){return e.tmid==t.id});return console.log(s),{uid:t.id,score:s&&s.ind&&0<s.ind.length?s.ind.reduce(function(e,t){return e+t.sel},0)/s.ind.length:0}});console.log(p),o.groups=generateTeams(p,function(e){return e.score},o.groupNum,isDifferent(o.groupMet))}null!=o.groups&&(o.groupsProp=angular.copy(o.groups),o.groupNames=[])},o.acceptGroups=function(){if(null==o.groupsProp)return void a.error("No hay propuesta de grupos para fijar");var e={sesid:o.selectedSes.id,groups:JSON.stringify(o.groups.map(function(t){return t.map(function(e){return e.uid||e.id})}))};console.log(e),t({url:"set-groups",method:"post",data:e}).success(function(e){"ok"==e.status&&(console.log("Groups accepted"),o.selectedSes.grouped=!0,o.shared.verifyGroups())})},o.swapTable=function(e,t){if(console.log(e,t,o.groups),-1==o.lastI&&-1==o.lastJ)return o.lastI=e,void(o.lastJ=t);if(o.lastI!=e||o.lastJ!=t){var s=angular.copy(o.groupsProp[e][t]);o.groupsProp[e][t]=angular.copy(o.groupsProp[o.lastI][o.lastJ]),o.groupsProp[o.lastI][o.lastJ]=s}o.lastI=-1,o.lastJ=-1}}),adpp.controller("RubricaController",function(e,t){var s=e;s.criterios=[],s.newCriterio={},s.editable=!1,s.exampleReports=[],s.newExampleReport="",s.pairNum=3,s.rid=-1,s.addCriterio=function(){s.criterios.push({})},s.removeCriterio=function(e){s.criterios.splice(e,1)},s.checkSum=function(){return 100==s.criterios.reduce(function(t,e){return t+e.pond},0)},s.shared.getRubrica=function(){s.criterios=[],s.newCriterio={},s.editable=!1;var e={sesid:s.selectedSes.id};t({url:"get-admin-rubrica",method:"post",data:e}).success(function(e){0==e.length?s.editable=!0:(s.criterios=e,s.rid=e[0].rid)})},s.startEditing=function(){s.editable=!0},s.saveRubrica=function(){if(-1!=s.rid)return void s.saveEditRubrica();var e={sesid:s.selectedSes.id};t({url:"send-rubrica",method:"post",data:e}).success(function(e){if("ok"==e.status){var a=e.id;s.criterios.forEach(function(e){var s=angular.copy(e);s.rid=a,t({url:"send-criteria",method:"post",data:s}).success(function(e){"ok"==e.status&&console.log("Ok")})}),s.editable=!1}})},s.saveEditRubrica=function(){if(-1!=s.rid){var e={rid:s.rid};t({url:"delete-criterias",method:"post",data:e}).success(function(e){if("ok"==e.status){var a=s.rid;s.criterios.forEach(function(e){var s=angular.copy(e);s.rid=a,t({url:"send-criteria",method:"post",data:s}).success(function(e){"ok"==e.status&&console.log("Ok")})}),s.editable=!1}})}},s.shared.getExampleReports=function(){s.exampleReports=[];var e={sesid:s.selectedSes.id};t({url:"get-example-reports",method:"post",data:e}).success(function(e){s.exampleReports=e})},s.sendExampleReport=function(){var e={sesid:s.selectedSes.id,content:s.newExampleReport.text,title:s.newExampleReport.title};t({url:"send-example-report",method:"post",data:e}).success(function(){s.newExampleReport="",s.shared.getExampleReports()})},s.setActiveExampleReport=function(e){var a={sesid:s.selectedSes.id,rid:e.id};t({url:"set-active-example-report",method:"post",data:a}).success(function(t){"ok"==t.status&&(s.exampleReports.forEach(function(e){e.active=!1}),e.active=!0)})},s.goToReport=function(e){s.setActiveExampleReport(e),window.location.href="to-rubrica?sesid="+s.selectedSes.id},s.pairAssign=function(){var e={sesid:s.selectedSes.id,rnum:+s.pairNum||3};t({url:"assign-pairs",method:"post",data:e}).success(function(e){"ok"==e.status?(s.selectedSes.paired=s.pairNum,s.errPairMsg=""):s.errPairMsg=e.msg})},s.shared.obtainCriterios=function(){return s.criterios},s.shared.isRubricaSet=function(){return!s.editable}}),adpp.controller("OptionsController",function(e,t,s){var a=e;a.conf={},a.sesidConfig=-1,a.options=[{name:"optCom",code:"J"},{name:"optConfLv",code:"C"},{name:"optHint",code:"H"}],a.saveConfs=function(){var e={sesid:a.selectedSes.id,options:a.buildConfStr()};t.post("update-ses-options",e).success(function(t){"ok"==t.status&&(s.success("Opciones actualizadas"),a.selectedSes.options=e.options,a.selectedSes.conf=null,a.shared.updateConf())})},a.shared.saveConfs=a.saveConfs,a.shared.updateConf=function(){if(null==a.selectedSes.conf){a.selectedSes.conf={};for(var e=a.selectedSes.options||"",t=0;t<e.length;t++)a.selectedSes.conf[e[t]]=!0;console.log(a.selectedSes)}return!0},a.buildConfStr=function(){var e="";for(var t in a.selectedSes.conf)a.selectedSes.conf[t]&&(e+=t);return e}}),adpp.controller("DashboardRubricaController",function(e){var t=e;t.reports=[],t.result=[],t.selectedReport=null,t.shared.resetRubricaGraphs=function(){t.alumState=null,t.barOpts={chart:{type:"multiBarChart",height:320,x:function(e){return e.label},y:function(e){return e.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},t.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},t.shared.resetRubricaGraphs()}),adpp.controller("GeoAdminController",["$scope","$http","NgMap",function(e,t,s){var a=e;a.openRight=!1,a.rightTab="",a.mOverlays=[],a.sOverlays=[],a.selectedOverlay=null,a.overlayBuffer=[];var r=function(e){return{id:e.id,name:e.name,description:e.description,color:o(e),type:e.type,fullType:n(e.type),geom:JSON.parse(e.geom)}},o=function(){return"blue"},d=function(e){return{name:e.name,description:e.description,iteration:0,qid:null==a.questions[a.selectedQs]?-1:a.questions[a.selectedQs].id,type:e.type,geom:JSON.stringify(e.geom)}},n=function(e){return"M"===e?"marker":"P"===e?"polygon":"L"===e?"polyline":"R"===e?"rectangle":"C"===e?"circle":"I"===e?"image":void 0};a.shared.processPrevMapData=function(e,t){a.shared.closePrevMapData(),a.shared.processMapData(e,t),a.misc.mapHasVisData=!0,console.log(a.misc)},a.shared.processMapData=function(e,t){a.shared.closePrevMapData();var s=e.split(" ");console.log(s),a.map.setCenter(new google.maps.LatLng(+s[1],+s[2])),a.map.setZoom(+s[3]),a.misc.mapNav="NAV"==s[4],a.misc.mapEdit="EDIT"==s[4]||"EDIT"==s[5],i(t),google.maps.event.trigger(a.map,"resize"),a.misc.mapHasVisData=!1},a.shared.closePrevMapData=function(){a.shared.clearOverlayBuffer(),a.misc.mapHasVisData=!1};var i=function(e){t.post("list-default-overlay",{qid:e}).success(function(e){var t=e.map(r);a.mOverlays=a.mOverlays.concat(t.filter(function(t){return"M"==t.type})),a.sOverlays=a.sOverlays.concat(t.filter(function(t){return"M"!=t.type}))})};a.clearOverlay=function(){a.newOverlay={name:"",description:"",color:"blue",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},a.updateOverlayList=function(){var e={qid:null==a.questions[a.selectedQs]?-1:a.questions[a.selectedQs].id};t.post("list-overlay",e).success(function(e){var t=e.map(r);a.mOverlays=t.filter(function(t){return"M"==t.type}),a.sOverlays=t.filter(function(t){return"M"!=t.type})})},a.shared.updateOverlayList=a.updateOverlayList,a.onMapOverlayCompleted=function(e){a.map.mapDrawingManager[0].setDrawingMode(null),a.newOverlay.fullType=e.type,a.newOverlay.type="polyline"==e.type?"L":e.type[0].toUpperCase(),a.newOverlay.geom.position=e.overlay.getPosition?positionToArray(e.overlay.getPosition()):null,a.newOverlay.geom.radius=e.overlay.radius,a.newOverlay.geom.center=positionToArray(e.overlay.center),a.newOverlay.geom.path=e.overlay.getPath?mutiplePositionToArray(e.overlay.getPath()):null,a.newOverlay.geom.bounds=e.overlay.getBounds?boundsToArray(e.overlay.getBounds()):null,a.newOverlay.centroid=centroidAsLatLng(a.newOverlay.type,a.newOverlay.geom),a.map.showInfoWindow("iw2"),e.overlay.setMap(null)},a.colorizeShape=function(e){a.map.shapes&&a.map.shapes.nshp&&(a.map.shapes.nshp.set("fillColor",e),a.map.shapes.nshp.set("strokeColor","dark"+e))},a.closeOverlay=function(){a.clearOverlay(),a.map.infoWindows.iw2.close()};var l=function(){var e="M"==a.newOverlay.type?a.map.markers.nmkr:a.map.shapes.nshp;a.newOverlay.geom.position=e.getPosition?positionToArray(e.getPosition()):null,a.newOverlay.geom.radius=e.radius,a.newOverlay.geom.center=positionToArray(e.center),a.newOverlay.geom.path=e.getPath?mutiplePositionToArray(e.getPath()):null,a.newOverlay.geom.bounds=e.getBounds?boundsToArray(e.getBounds()):null,a.newOverlay.centroid=centroidAsLatLng(a.newOverlay.type,a.newOverlay.geom)};a.sendOverlay=function(){l(),a.overlayBuffer.push(d(a.newOverlay)),console.log(a.overlayBuffer),"M"==a.newOverlay.type?a.mOverlays.push(a.newOverlay):a.sOverlays.push(a.newOverlay),a.closeOverlay()},a.shared.clearOverlayBuffer=function(){a.mOverlays=[],a.sOverlays=[],a.overlayBuffer=[]},a.shared.sendOverlayBuffer=function(e){console.log(e,a.overlayBuffer),a.overlayBuffer.forEach(function(s){s.qid=e,t.post("add-overlay",s).success(function(){console.log("OK")})}),a.shared.closePrevMapData()},a.clickOverlay=function(){a.selectOverlay(this.id)},a.selectOverlay=function(t){a.selectedOverlay=a.mOverlays.find(function(s){return s.id==t})||a.sOverlays.find(function(s){return s.id==t}),a.selectedOverlay.centroid=centroidAsLatLng(a.selectedOverlay.type,a.selectedOverlay.geom),a.map.panTo(a.selectedOverlay.centroid),a.map.showInfoWindow("iw")},a.googleSearch=function(){var e=this.getPlace();null==e||null==e.geometry||null==e.geometry.location||(a.map.mapDrawingManager[0].setDrawingMode(null),a.newOverlay.fullType="marker",a.newOverlay.type="M",a.newOverlay.geom.position=positionToArray(e.geometry.location),a.newOverlay.centroid=centroidAsLatLng(a.newOverlay.type,a.newOverlay.geom),a.map.showInfoWindow("iw2"),a.map.panTo(e.geometry.location))},a.shared.getPluginMapOptions=function(){return{nav:a.misc.mapNav,edit:a.misc.mapEdit}},a.shared.getActiveMap=function(){return a.map},function(){a.updateOverlayList(),a.clearOverlay(),s.getMap().then(function(e){console.log("MAP cargado correctamente"),a.map=e,a.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),a.map.infoWindows.iw.close()}),a.misc.mapHasVisData=!1}()}]),adpp.filter("htmlExtractText",function(){return function(e){return e?(e+"").replace(/<[^>]+>/gm,""):""}}),adpp.filter("trustHtml",["$sce",function(e){return function(t){return e.trustAsHtml(t)}}]),adpp.filter("lang",function(){function e(e){if(null!=window.DIC)return window.DIC[e]?window.DIC[e]:(window.warnDIC[e]||(console.warn("Cannot find translation for ",e),window.warnDIC[e]=!0),e)}return e.$stateful=!0,e});var generateTeams=function(e,t,s,a,r){if(null==s||0==s)return[];console.log(e);var o=e;r?o.sort(t):o.sort(function(e,s){return t(s)-t(e)});for(var d=[],n=e.length/s,l=0;l<n;l++)a?function(){for(var e=[],t=o.length/s,a=0;a<s;a++)e.push(~~(Math.random()*t+t*a));d.push(o.filter(function(t,s){return e.includes(s)})),o=o.filter(function(t,s){return!e.includes(s)})}():(d.push(o.filter(function(e,t){return t<s})),o=o.filter(function(e,t){return t>=s}));for(var u=[],c=0,p=0;p<d.length;p++)1<d[p].length||0==u.length?u.push(d[p]):(u[c%u.length].push(d[p][0]),c++);return u},isDifferent=function(e){return"performance homog"!==e&&(!("performance heterg"!==e)||"knowledgeType homog"!==e&&!("knowledgeType heterg"!==e))},habMetric=function(e){switch(e.aprendizaje){case"Teorico":return-2;case"Reflexivo":return-1;case"Activo":return 1;case"Pragmatico":return 2;}return 0},quillMapHandler=function(){alert("Mapa s\xF3lo disponible para preguntas")},positionToArray=function(e){return null==e?null:[e.lat(),e.lng()]},mutiplePositionToArray=function(e){for(var t,s=[],a=0;a<e.getLength();a++)t=e.getAt(a),s.push(positionToArray(t));return s},boundsToArray=function(e){return[positionToArray(e.getSouthWest()),positionToArray(e.getNorthEast())]},avgCoord=function(e){for(var t=0,s=0,a=0;a<e.length;a++)t+=e[a][0],s+=e[a][1];return[t/e.length,s/e.length]},centroidAsLatLng=function(e,t){var s=centroid(e,t);return new google.maps.LatLng(s[0],s[1])},centroid=function(e,t){return"M"==e?t.position:"C"==e?t.center:"R"==e?avgCoord(t.bounds):"P"==e||"L"==e?avgCoord(t.path):null};
