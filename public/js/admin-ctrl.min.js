"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification","ngQuill","ngMap"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;window.DIC=null,window.warnDIC={},adpp.config(["ngQuillConfigProvider",function(g){g.set({modules:{formula:!0,toolbar:{container:[["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{size:["small",!1,"large","huge"]}],["clean"],["image","link","video"],["formula"]],handlers:{map:quillMapHandler}}}})}]),adpp.controller("AdminController",function(g,h,l,m,o,w){var x=g;x.temp="",o.NUMBER_FORMATS.GROUP_SEP="",x.shared={},x.sessions=[],x.selectedSes=null,x.documents=[],x.questions=[],x.questionTexts=[],x.newUsers=[],x.users={},x.selectedId=-1,x.sesStatusses=["notPublicada","reading","personal","anon","teamWork","finished"],x.optConfidence=[0,25,50,75,100],x.iterationNames=[],x.showSeslist=!0,x.lang="english",x.secIcons={configuration:"cog",editor:"edit",dashboard:"bar-chart",users:"male",rubrica:"check-square",groups:"users",options:"sliders"},x.typeNames={L:"readComp",S:"multSel",M:"semUnits"},x.misc={},x.init=function(){x.shared.updateSesData(),x.updateLang(x.lang)},x.selectSession=function(y,z){x.selectedId=z,x.selectedSes=y,x.requestDocuments(),x.requestSemDocuments(),x.requestQuestions(),x.getNewUsers(),x.getMembers(),x.shared.verifyGroups(),x.shared.resetGraphs(),x.shared.verifyTabs(),x.shared.resetTab(),x.shared.updateConf(),m.path(x.selectedSes.id)},x.shared.updateSesData=function(){h({url:"get-session-list",method:"post"}).success(function(y){if(console.log("Session data updated"),x.sessions=y,-1!=x.selectedId){var z=x.sessions.find(function(A){return A.id==x.selectedId});null!=z&&x.selectSession(z,x.selectedId)}else x.sesFromURL()})},x.sesFromURL=function(){var y=+m.path().substring(1),z=x.sessions.find(function(A){return A.id==y});null!=z&&x.selectSession(z,y)},x.requestDocuments=function(){var y={sesid:x.selectedSes.id};h({url:"documents-session",method:"post",data:y}).success(function(z){x.documents=z})},x.shared.updateDocuments=x.requestDocuments,x.deleteDocument=function(y){h({url:"delete-document",method:"post",data:{docid:y}}).success(function(){x.requestDocuments()})},x.requestQuestions=function(){var y={sesid:x.selectedSes.id};h({url:"questions-session",method:"post",data:y}).success(function(z){x.questions=z.map(function(A){return A.options=A.options.split("\n"),A})}),h({url:"get-question-text",method:"post",data:y}).success(function(z){x.questionTexts=z})},x.requestSemDocuments=function(){var y={sesid:x.selectedSes.id};h({url:"semantic-documents",method:"post",data:y}).success(function(z){x.semDocs=z})},x.getNewUsers=function(){var y={sesid:x.selectedSes.id};h({url:"get-new-users",method:"post",data:y}).success(function(z){x.newUsers=z})},x.getMembers=function(){var y={sesid:x.selectedSes.id};h({url:"get-ses-users",method:"post",data:y}).success(function(z){x.usersArr=z,x.users={},z.forEach(function(A){x.users[A.id]=A})})},x.openNewSes=function(){l.open({templateUrl:"templ/new-ses.html"})},x.openDuplicateSes=function(){if(null!=x.selectedSes){var y=angular.copy(x.selectedSes);l.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:x,resolve:{data:function data(){return y}}})}},x.openDuplicateSesSpec=function(y,z){z.stopPropagation();var A=angular.copy(y);l.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:x,resolve:{data:function data(){return A}}})},x.toggleSidebar=function(){x.openSidebar=!x.openSidebar,x.shared.updateState()},x.updateLang=function(y){h.get("data/"+y+".json").success(function(z){window.DIC=z})},x.shared.resetSesId=function(){x.selectedId=-1},x.changeLang=function(){x.lang="english"==x.lang?"spanish":"english",x.updateLang(x.lang)},x.generateCode=function(){var y={id:x.selectedSes.id};h.post("generate-session-code",y).success(function(z){null!=z.code&&(x.selectedSes.code=z.code)})},x.flang=function(y){return w("lang")(y)},x.init()}),adpp.controller("TabsController",function(g){var l=g;l.tabOptions=[],l.tabConfig=["users","groups"],l.selectedTab="",l.shared.resetTab=function(){l.selectedTab="editor",null!=l.selectedSes&&1<l.selectedSes.status&&(l.selectedTab="dashboard"),l.selectedTabConfig=-1,7==l.selectedSes.status&&l.shared.gotoRubrica()},l.shared.verifyTabs=function(){"L"==l.selectedSes.type?(l.iterationNames=[{name:"reading",val:0},{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3},{name:"report",val:4},{name:"rubricCalib",val:5},{name:"pairEval",val:6}],l.tabOptions=["editor","users","groups","rubrica","dashboard"],l.sesStatusses=["configuration","reading","individual","anon","teamWork","report","rubricCalib","pairEval","finished"],l.shared.getRubrica(),l.shared.getExampleReports(),l.shared.getReports()):"S"==l.selectedSes.type?(l.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],l.tabOptions=["editor","users","groups","dashboard"],l.sesStatusses=["configuration","individual","anon","teamWork","finished"]):"M"==l.selectedSes.type&&(l.iterationNames=[{name:"individual",val:1},{name:"teamWork",val:3},{name:"report",val:4},{name:"pairEval",val:6}],l.tabOptions=["editor","users","groups","rubrica","dashboard"],l.sesStatusses=[{i:-1,name:"configuration"},{i:1,name:"individual"},{i:3,name:"teamWork"},{i:4,name:"report"},{i:6,name:"pairEval"},{i:7,name:"finished"}],l.shared.getRubrica(),l.shared.getExampleReports(),l.shared.getReports()),1<l.selectedSes.status&&(l.selectedTab="dashboard")},l.setTab=function(m){l.selectedTab=m},l.setTabConfig=function(m){l.selectedTabConfig=m},l.backToList=function(){l.shared.resetSesId(),l.tabOptions=[],l.selectedTab=""},l.shared.gotoGrupos=function(){l.selectedTab="groups"},l.shared.gotoRubrica=function(){l.selectedTab="rubrica"}}),adpp.controller("DocumentsController",function(g,h,l,m){var o=g;o.busy=!1,o.uploadDocument=function(w){o.busy=!0;var x=new FormData(w.target);h.post("upload-file",x,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(y){"ok"==y.status&&m(function(){l.success("Documento cargado correctamente"),w.target.reset(),o.busy=!1,o.shared.updateDocuments()},2e3)})}}),adpp.controller("SesEditorController",function(g,h,l){var m=g;m.mTransition={1:3,3:5,5:6,6:8,8:9},m.splitDescr=!1,m.splDes1="",m.splDes2="",m.toggleSplit=function(){m.splitDescr=!m.splitDescr,m.splitDescr?(m.splDes1=m.selectedSes.descr.split("\n")[0],m.splDes2=m.selectedSes.descr.split("\n")[1]||""):m.selectedSes.descr=m.splDes1+"\n"+m.splDes2},m.updateSession=function(){if(m.splitDescr&&(m.selectedSes.descr=m.splDes1+"\n"+m.splDes2),3>m.selectedSes.name.length||5>m.selectedSes.descr.length)return void l.error("Datos de la sesi\xF3n incorrectos o incompletos");var o={name:m.selectedSes.name,descr:m.selectedSes.descr,id:m.selectedSes.id};h({url:"update-session",method:"post",data:o}).success(function(){console.log("Session updated")})},m.shared.changeState=function(){if("M"!=m.selectedSes.type&&m.selectedSes.status>=m.sesStatusses.length)return void l.error("La sesi\xF3n est\xE1 finalizada");if("M"==m.selectedSes.type&&9<=m.selectedSes.status)return void l.error("La sesi\xF3n est\xE1 finalizada");if("L"==m.selectedSes.type&&3<=m.selectedSes.status&&!m.selectedSes.grouped||"M"==m.selectedSes.type&&3<=m.selectedSes.status&&!m.selectedSes.grouped||"S"==m.selectedSes.type&&2<=m.selectedSes.status&&!m.selectedSes.grouped)return m.shared.gotoGrupos(),void l.error("Los grupos no han sido generados");if("L"==m.selectedSes.type&&7<=m.selectedSes.status&&!m.selectedSes.paired||"M"==m.selectedSes.type&&6<=m.selectedSes.status&&!m.selectedSes.paired)return m.shared.gotoRubrica(),void l.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var o=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(o)if("M"==m.selectedSes.type){var w={sesid:m.selectedSes.id,state:m.mTransition[m.selectedSes.status]||m.selectedSes.status};h({url:"force-state-session",method:"post",data:w}).success(function(){m.shared.updateSesData()})}else{1==m.selectedSes.status&&(m.updateSession(),"S"==m.selectedSes.type&&m.shared.saveConfs());var w={sesid:m.selectedSes.id};h({url:"change-state-session",method:"post",data:w}).success(function(){m.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(g,h,l){var m=g;m.addToSession=function(){if(0==m.newMembs.length)return void l.error("No hay usuarios seleccionados para agregar");var w={users:m.newMembs.map(function(x){return x.id}),sesid:m.selectedSes.id};h({url:"add-ses-users",method:"post",data:w}).success(function(x){"ok"==x.status&&m.refreshUsers()})},m.removeUser=function(w){if(2>=m.selectedSes.status){var x={uid:w,sesid:m.selectedSes.id};h({url:"delete-ses-user",method:"post",data:x}).success(function(y){"ok"==y.status&&m.refreshUsers()})}},m.refreshUsers=function(){m.getNewUsers(),m.getMembers()}}),adpp.controller("SemDocController",function(g,h,l){var m=g;m.newSDoc={id:null,title:"",content:""},m.addSemDoc=function(){var o={sesid:m.selectedSes.id,title:m.newSDoc.title,content:m.newSDoc.content};h({url:"add-semantic-document",method:"post",data:o}).success(function(w){"ok"==w.status&&(m.requestSemDocuments(),l.success("Texto agregado correctamente"),m.newSDoc={id:null,title:"",content:""})})},m.deleteText=function(o){h.post("delete-semantic-document",{id:o}).success(function(x){"ok"==x.status&&(m.requestSemDocuments(),l.success("Texto eliminado correctamente"))})},m.startEditText=function(o){m.newSDoc={id:o.id,title:o.title,content:o.content},l.info("Edite el texto en el formulario")},m.updateSemDoc=function(){if(null==m.newSDoc.id)return void l.error("No hay texto a editar.");var o={id:m.newSDoc.id,sesid:m.selectedSes.id,title:m.newSDoc.title,content:m.newSDoc.content};h({url:"update-semantic-document",method:"post",data:o}).success(function(w){"ok"==w.status&&(m.requestSemDocuments(),l.success("Texto editado correctamente."),m.newSDoc={id:null,title:"",content:""})})}}),adpp.controller("QuestionsController",function(g,h,l,m,o,w){var x=g;x.qsLabels=["A","B","C","D","E"],x.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},x.newText={id:null,title:"",content:""},x.selectAnswer=function(A){x.newQuestion.answer=A},x.addQuestion=function(){if(-1==x.newQuestion.answer)return void l.error("Debe indicar la respuesta correcta a la pregunta");x.newQuestion.includesMap&&z();var A={content:x.newQuestion.content,options:x.newQuestion.alternatives.join("\n"),comment:x.newQuestion.comment,answer:x.newQuestion.answer,sesid:x.selectedSes.id,textid:x.newQuestion.textid,other:x.newQuestion.other,pluginData:x.newQuestion.pluginData};h({url:"add-question",method:"post",data:A}).success(function(B){"ok"==B.status&&(x.requestQuestions(),l.success("Pregunta agrgada correctamente"),x.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},x.shared.sendOverlayBuffer(B.id))})},x.updateQuestion=function(){if(null==x.newQuestion.id)return void l.error("No hay pregunta para editar");if(-1==x.newQuestion.answer)return void l.error("Debe indicar la respuesta correcta a la pregunta");x.newQuestion.includesMap&&z();var A={id:x.newQuestion.id,content:x.newQuestion.content,options:x.newQuestion.alternatives.join("\n"),comment:x.newQuestion.comment,answer:x.newQuestion.answer,sesid:x.selectedSes.id,textid:x.newQuestion.textid,other:x.newQuestion.other,pluginData:x.newQuestion.pluginData};h({url:"update-question",method:"post",data:A}).success(function(B){"ok"==B.status&&(x.requestQuestions(),l.success("Pregunta editada correctamente"),x.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},x.shared.clearOverlayBuffer&&x.shared.clearOverlayBuffer())})},x.startEditQuestion=function(A){x.newQuestion={id:A.id,content:A.content,alternatives:A.options,comment:A.comment,other:A.other,textid:A.textid,answer:A.answer,includesMap:A.plugin_data&&A.plugin_data.startsWith("MAP")},l.info("Edite la pregunta en el formulario."),x.newQuestion.includesMap&&(x.shared.clearOverlayBuffer&&x.shared.clearOverlayBuffer(),x.shared.processMapData(A.plugin_data,A.id),y())},x.startEditText=function(A){x.newText={id:A.id,title:A.title,content:A.content},l.info("Edite el texto en el formulario.")},x.addQuestionText=function(){var A={sesid:x.selectedSes.id,title:x.newText.title,content:x.newText.content};h({url:"add-question-text",method:"post",data:A}).success(function(B){"ok"==B.status&&(x.requestQuestions(),x.newText={id:null,title:"",content:""})})},x.updateQuestionText=function(){if(null==x.newText.id)return void l.error("No hay texto para editar");var A={id:x.newText.id,sesid:x.selectedSes.id,title:x.newText.title,content:x.newText.content};h({url:"update-question-text",method:"post",data:A}).success(function(B){"ok"==B.status&&(x.requestQuestions(),x.newText={title:"",content:""})})},x.deleteQuestion=function(A){h.post("delete-question",{id:A}).success(function(){x.requestQuestions(),l.success("Pregunta eliminada correctamente")})},x.deleteQuestionText=function(A){h.post("delete-question-text",{id:A}).success(function(){x.requestQuestions(),l.success("Texto eliminado correctamente")})},x.configQuillExtra=function(A){x.editor=A},x.toggleMapPlugin=function(){x.newQuestion.includesMap=!x.newQuestion.includesMap,x.newQuestion.includesMap&&y()};var y=function futureRefreshMap(){w(function(){var A=x.shared.getActiveMap();google.maps.event.trigger(A,"resize")},1e3)},z=function encodeMapPlugin(){var A=x.shared.getPluginMapOptions(),B=x.shared.getActiveMap();if(null==B)return void l.error("Ocurrio un error al cargar los datos del mapa, intente nuevamente.");var C=B.getCenter().lat(),D=B.getCenter().lng(),E=B.getZoom();x.newQuestion.pluginData="MAP "+C+" "+D+" "+E+(A.nav?" NAV":"")+(A.edit?" EDIT":"")}}),adpp.controller("DashboardController",function(g,h,l,m,o){var w=g;w.iterationIndicator=1,w.currentTimer=null,w.showCf=!1,w.shared.resetGraphs=function(){null!=w.selectedSes&&"L"==w.selectedSes.type?w.iterationIndicator=Math.max(Math.min(6,w.selectedSes.status-2),0):"S"==w.selectedSes.type?w.iterationIndicator=Math.max(Math.min(3,w.selectedSes.status-1),1):"M"==w.selectedSes.type&&(w.iterationIndicator=Math.max(Math.min(6,w.selectedSes.status-2),0)),w.alumState=null,w.barOpts={chart:{type:"multiBarChart",height:320,x:function(x){return x.label},y:function y(x){return x.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:w.flang("students")}}},w.barData=[{key:w.flang("students"),color:"#4d6b87",values:[]}],w.updateState(),9>w.selectedSes.status&&w.reload(!0)},w.reload=function(x){x||w.updateState(),null!=w.currentTimer&&l.cancel(w.currentTimer),w.currentTimer=l(w.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},w.updateState=function(){4>=w.iterationIndicator?w.updateStateIni():w.updateStateRub()},w.shared.updateState=w.updateState,w.updateStateIni=function(){w.alumTime={};var x={sesid:w.selectedSes.id,iteration:w.iterationIndicator};"S"==w.selectedSes.type?(h({url:"get-alum-full-state-sel",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.users)"A"==w.users[z].role&&(w.alumState[z]={});y.forEach(function(z){null==w.alumState[z.uid]?(w.alumState[z.uid]={},w.alumState[z.uid][z.qid]=z.correct):w.alumState[z.uid][z.qid]=z.correct}),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState}),h({url:"get-alum-state-sel",method:"post",data:x}).success(function(y){var z=y.map(function(A){return A.score/=w.questions.length,A});w.buildBarData(z)}),h({url:"get-alum-confidence",method:"post",data:x}).success(function(y){w.confidence={},y.forEach(function(z){w.confidence[z.qid]||(w.confidence[z.qid]={}),w.confidence[z.qid][z.conf]=z.freq})})):"L"==w.selectedSes.type?(h({url:"get-alum-state-lect",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.users)"A"==w.users[z].role&&(w.alumState[z]={});y.forEach(function(z){w.alumState[z.uid]=null==w.alumState[z.uid]?z:z}),w.buildBarData(y),w.getAlumDoneTime(x),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState}),h({url:"get-ideas-progress",method:"post",data:x}).success(function(y){w.numProgress=0,w.numUsers=Object.keys(w.users).length-1;var z=3*w.documents.length;0!=z&&(y.forEach(function(A){w.numProgress+=A.count/z}),w.numProgress*=100/w.numUsers)})):"M"==w.selectedSes.type&&h({url:"get-alum-state-semantic",method:"post",data:x}).success(function(y){for(var z in w.alumState={},w.numUsers=0,w.users)"A"==w.users[z].role&&(w.alumState[z]={},w.numUsers++);y.forEach(function(z){w.alumState[z.uid]=null==w.alumState[z.uid]?z:z}),w.buildBarData(y),w.getAlumDoneTime(x),3==w.iterationIndicator&&h({url:"get-original-leaders",method:"post",data:{sesid:w.selectedSes.id}}).success(function(z){var A=angular.copy(w.alumState);w.alumState={},w.leaderTeamStr={},z.forEach(function(B){w.alumState[B.leader]=A[B.leader],w.leaderTeamStr[B.leader]=B.team.map(function(C){return w.users[C]?w.users[C].name:"- "}).join(", ")})}),w.shared.alumState=w.alumState})},w.avgAlum=function(x){if(null!=w.alumState&&null!=w.alumState[x]){var y=0,z=0;for(var A in w.alumState[x])w.alumState[x][A]&&z++,y++;return 0<y?100*z/y:0}return 0},w.avgPreg=function(x){if(null!=w.alumState){var y=0,z=0;for(var A in w.alumState)null!=w.alumState[A]&&null!=w.alumState[A][x]&&(w.alumState[A][x]&&z++,y++);return 0<y?100*z/y:0}return 0},w.avgAll=function(){var x=0,y=0;if(null!=w.alumState)for(var z in w.alumState)for(var A in w.alumState[z])w.alumState[z][A]&&y++,x++;return 0<x?100*y/x:0},w.progress=function(){var x=0;if(null!=w.alumState){for(var y in w.alumState)for(var z in w.alumState[y])x++;return 100*x/(Object.keys(w.alumState).length*w.questions.length)}return 0},w.progressAlum=function(x){var y=0;if(null!=w.alumState&&null!=w.alumState[x]){for(var z in w.alumState[x])y++;return 100*y/w.questions.length}return 0},w.progressPreg=function(x){var y=0;if(null!=w.alumState){for(var z in w.alumState)null!=w.alumState[z][x]&&y++;return 100*y/Object.keys(w.alumState).length}return 0},w.lectPerformance=function(){var x=0,y=0;if(null!=w.alumState){for(var A in w.alumState){var z=w.alumState[A];x++,y+=z.score}return 100*y/x}return 0},w.getAlumDoneTime=function(x){h({url:"get-alum-done-time",method:"post",data:x}).success(function(y){w.numComplete=0,y.forEach(function(z){w.numComplete+=1,null==w.alumState[z.uid]?w.alumState[z.uid]=z:w.alumState[z.uid].dtime=~~z.dtime})})},w.buildBarData=function(x){var y=5;w.barData[0].values=[];for(var A,z=0;z<y;z++)A=20*z+"% - "+20*(z+1)+"%",w.barData[0].values.push({label:A,value:0});x.forEach(function(z){var A=Math.min(Math.floor(y*z.score),y-1);w.barData[0].values[A].value+=1}),w.barOpts.chart.xAxis.axisLabel=w.flang("performance")},w.updateStateRub=function(){5==w.iterationIndicator?w.computeDif():6==w.iterationIndicator&&w.getAllReportResult()},w.showName=function(x){return x.example?x.title+" - "+w.flang("exampleReport"):x.id+" - "+w.flang("reportOf")+" "+w.users[x.uid].name},w.shared.getReports=function(){var x={sesid:w.selectedSes.id};h({url:"get-report-list",method:"post",data:x}).success(function(y){w.reports=y,w.exampleReports=y.filter(function(z){return z.example})})},w.getReportResult=function(){var x={repid:w.selectedReport.id};h({url:"get-report-result",method:"post",data:x}).success(function(y){w.result=y,w.updateState()})},w.getAllReportResult=function(){var x={sesid:w.selectedSes.id};h({url:"get-report-result-all",method:"post",data:x}).success(function(y){for(var z in w.resultAll={},w.users)"A"==w.users[z].role&&(w.resultAll[z]=[]);y.forEach(function(z){if(null!=z&&0<z.length){var A=w.getReportAuthor(z[0].rid);-1!=A&&null==w.resultAll[A]?w.resultAll[A]=z:-1!=A&&(w.resultAll[A]=z)}}),w.pairArr=y[0]?Array(y[0].length):[],w.buildRubricaBarData(y)})},w.buildRubricaBarData=function(x){var y=3,z=["1 - 2","2 - 3","3 - 4"];w.barData[0].values=[];for(var B,A=0;A<y;A++)B=A+1+" - "+(A+2)+" ("+z[A]+")",w.barData[0].values.push({label:B,value:0});x.forEach(function(A){var B=A.reduce(function(D,E){return D+E.val},0)/A.length,C=Math.min(Math.floor(B-1),y-1);w.barData[0].values[C].value+=1}),w.barOpts.chart.xAxis.axisLabel=w.flang("scoreDist")},w.computeDif=function(){w.result&&function(){var x=w.result.findIndex(function(y){return"P"==w.users[y.uid].role});-1!=x&&function(){var y=w.result[x].val,z=[];w.result.forEach(function(A,B){B!=x&&z.push(Math.abs(y-A.val))}),w.buildRubricaDiffData(z)}()}()},w.buildRubricaDiffData=function(x){console.log("difs",x);var y=5,z=w.flang("high2lowScale").split(",");w.barData[0].values=[];for(var A=0;A<y;A++)w.barData[0].values.push({label:z[A],value:0});x.forEach(function(A){var B=Math.min(Math.floor(2*A),y-1);w.barData[0].values[B].value+=1}),w.barOpts.chart.xAxis.axisLabel=w.flang("correctDistance")},w.getReportAuthor=function(x){if(w.reports){var y=w.reports.find(function(z){return z.id==x});return y?y.uid:-1}return-1},w.getAvg=function(x){if(null==x||0==x.length)return"";var y=x.reduce(function(z,A){return z+A.val},0);return y/x.length},w.getInMax=function(x){if(null==x)return[];var y=0;for(var z in x)y=Math.max(y,x[z].length);return Array(y)},w.showReport=function(x){h({url:"get-report",method:"post",data:{rid:x}}).success(function(z){var A={report:z,criterios:w.shared.obtainCriterios()};A.report.author=w.users[z.uid];var B={repid:z.id};h({url:"get-report-result",method:"post",data:B}).success(function(C){A.answers=C,h.post("get-criteria-selection-by-report",B).success(function(D){A.answersRubrica={},D.forEach(function(E){null==A.answersRubrica[E.uid]&&(A.answersRubrica[E.uid]={}),A.answersRubrica[E.uid][E.cid]=E.selection}),h.post("get-report-evaluators",B).success(function(E){E.forEach(function(F){var G=A.answers.findIndex(function(H){return H.uid==F.uid});-1==G?A.answers.push({uid:F.uid,evaluatorName:w.users[F.uid].name}):A.answers[G].evaluatorName=w.users[F.uid].name}),m.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",size:"lg",scope:w,resolve:{data:function data(){return A}}})})})})})},w.showReportByUid=function(x){console.log(x);var y={uid:x,sesid:w.selectedSes.id};h({url:"get-report-uid",method:"post",data:y}).success(function(z){var A={report:z};A.report.author=w.users[x],m.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:w,resolve:{data:function data(){return A}}})})},w.broadcastReport=function(x){var y={sesid:w.selectedSes.id,rid:x};h({url:"set-eval-report",method:"post",data:y}).success(function(){o.success("Reporte enviado a alumnos")})},w.showDetailAnswer=function(x,y,z){var A=["A","B","C","D","E"];h({url:"get-selection-comment",method:"post",data:{uid:y,qid:x,iteration:z}}).success(function(C){var D=w.questions.reduce(function(G,H){return H.id==x?H:G},null);console.log(D);var E=A[C.answer]+". "+D.options[C.answer],F=D.content;m.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:w,resolve:{data:function data(){return C.title=w.flang("answerOf")+" "+w.users[y].name,C.content=w.flang("question")+":\n"+F+"\n\n"+w.flang("answer")+":\n"+E+"\n\n"+w.flang("comment")+":\n"+C.comment,C.confidence&&(C.content+="\n\n"+w.flang("confidenceLevel")+": "+C.confidence+"%"),C}}})})}}),adpp.controller("MapSelectionModalController",function(g,h){var l=this;l.nav=!0,l.edit=!1,l.cancel=function(){h.dismiss("cancel")},l.resolve=function(){h.close({nav:l.nav,edit:l.edit})}}),adpp.controller("ReportModalController",function(g,h,l){var m=this;m.data=l,m.cancel=function(){h.dismiss("cancel")}}),adpp.controller("ContentModalController",function(g,h,l){var m=this;m.data=l,m.cancel=function(){h.dismiss("cancel")}}),adpp.controller("DuplicateSesModalController",function(g,h,l,m){var o=this;o.data=m,o.nses={name:o.data.name,tipo:o.data.type,descr:o.data.descr,originalSesid:o.data.id,copyDocuments:!1,copyIdeas:!1,copyQuestions:!1,copyRubrica:!1,copyUsers:!1,copySemUnits:!1,copySemDocs:!1},o.cancel=function(){l.dismiss("cancel")},o.sendDuplicate=function(){console.log(o.nses),h({url:"duplicate-session",method:"post",data:o.nses}).success(function(w){console.log(w),window.location.replace("admin")})}}),adpp.controller("GroupController",function(g,h,l){var m=g;m.methods=[],m.lastI=-1,m.lastJ=-1,m.shared.verifyGroups=function(){m.methods=[o("random"),o("performance","homog"),o("performance","heterg"),o("knowledgeType","homog"),o("knowledgeType","heterg")],m.groupNum=3,m.groupMet=m.methods[0],m.groups=[],m.groupNames=[],null!=m.selectedSes&&m.selectedSes.grouped&&(m.groupNum=null,m.groupMet=null,m.generateGroups(!0))};var o=function klg(w,x){return{key:w+(null==x?"":" "+x),name:m.flang(w)+(null==x?"":" "+m.flang(x))}};m.generateGroups=function(w){if(m.selectedSes.grouped)return void h({url:"group-proposal-sel",method:"post",data:{sesid:m.selectedSes.id}}).success(function(z){m.groups=z,console.log(z)});if(null==w&&(1>m.groupNum||m.groupNum>m.users.length))return void l.error("Error en los par\xE1metros de formaci\xF3n de grupos");var x={sesid:m.selectedSes.id,gnum:m.groupNum,method:m.groupMet};console.log(x),console.log(m.shared.alumState);var y=Object.values(m.users).filter(function(z){return"A"==z.role});if(console.log(y),"knowledgeType homog"==m.groupMet||"knowledgeType heterg"==m.groupMet)m.groups=generateTeams(y,habMetric,m.groupNum,isDifferent(m.groupMet));else if("random"==m.groupMet){var z=y.map(function(A){return A.rnd=Math.random(),A});m.groups=generateTeams(z,function(A){return A.rnd},m.groupNum,!1)}else if("S"==m.selectedSes.type||"M"==m.selectedSes.type){var z=[];for(var A in m.shared.alumState){var B=0;for(var C in m.shared.alumState[A])B+=+C;z.push({uid:A,score:B})}m.groups=generateTeams(z,function(A){return A.score},m.groupNum,isDifferent(m.groupMet))}else"L"==m.selectedSes.type&&(m.groups=generateTeams(m.shared.alumState,function(z){return z.score},m.groupNum,isDifferent(m.groupMet)));null!=m.groups&&(m.groupsProp=angular.copy(m.groups),m.groupNames=[])},m.acceptGroups=function(){if(null==m.groupsProp)return void l.error("No hay propuesta de grupos para fijar");var w={sesid:m.selectedSes.id,groups:JSON.stringify(m.groups.map(function(x){return x.map(function(y){return y.uid||y.id})}))};console.log(w),h({url:"set-groups",method:"post",data:w}).success(function(x){"ok"==x.status&&(console.log("Groups accepted"),m.selectedSes.grouped=!0,m.shared.verifyGroups())})},m.swapTable=function(w,x){if(console.log(w,x,m.groups),-1==m.lastI&&-1==m.lastJ)return m.lastI=w,void(m.lastJ=x);if(m.lastI!=w||m.lastJ!=x){var y=angular.copy(m.groupsProp[w][x]);m.groupsProp[w][x]=angular.copy(m.groupsProp[m.lastI][m.lastJ]),m.groupsProp[m.lastI][m.lastJ]=y}m.lastI=-1,m.lastJ=-1}}),adpp.controller("RubricaController",function(g,h){var l=g;l.criterios=[],l.newCriterio={},l.editable=!1,l.exampleReports=[],l.newExampleReport="",l.pairNum=3,l.addCriterio=function(){l.criterios.push(l.newCriterio),l.newCriterio={}},l.removeCriterio=function(m){l.criterios.splice(m,1)},l.checkSum=function(){return 100==l.criterios.reduce(function(m,o){return m+o.pond},0)},l.shared.getRubrica=function(){l.criterios=[],l.newCriterio={},l.editable=!1;var m={sesid:l.selectedSes.id};h({url:"get-admin-rubrica",method:"post",data:m}).success(function(o){0==o.length?l.editable=!0:l.criterios=o})},l.saveRubrica=function(){var m={sesid:l.selectedSes.id};h({url:"send-rubrica",method:"post",data:m}).success(function(o){"ok"==o.status&&function(){var w=o.id;l.criterios.forEach(function(x){var y=angular.copy(x);y.rid=w,h({url:"send-criteria",method:"post",data:y}).success(function(z){"ok"==z.status&&console.log("Ok")})}),l.editable=!1}()})},l.shared.getExampleReports=function(){l.exampleReports=[];var m={sesid:l.selectedSes.id};h({url:"get-example-reports",method:"post",data:m}).success(function(o){l.exampleReports=o})},l.sendExampleReport=function(){var m={sesid:l.selectedSes.id,content:l.newExampleReport.text,title:l.newExampleReport.title};h({url:"send-example-report",method:"post",data:m}).success(function(){l.newExampleReport="",l.shared.getExampleReports()})},l.setActiveExampleReport=function(m){var o={sesid:l.selectedSes.id,rid:m.id};h({url:"set-active-example-report",method:"post",data:o}).success(function(w){"ok"==w.status&&(l.exampleReports.forEach(function(x){x.active=!1}),m.active=!0)})},l.goToReport=function(m){l.setActiveExampleReport(m),window.location.href="to-rubrica?sesid="+l.selectedSes.id},l.pairAssign=function(){var m={sesid:l.selectedSes.id,rnum:+l.pairNum||3};h({url:"assign-pairs",method:"post",data:m}).success(function(o){"ok"==o.status?(l.selectedSes.paired=!0,l.errPairMsg=""):l.errPairMsg=o.msg})},l.shared.obtainCriterios=function(){return l.criterios}}),adpp.controller("OptionsController",function(g,h,l){var m=g;m.conf={},m.sesidConfig=-1,m.options=[{name:"optCom",code:"J"},{name:"optConfLv",code:"C"},{name:"optHint",code:"H"}],m.saveConfs=function(){var o={sesid:m.selectedSes.id,options:m.buildConfStr()};h.post("update-ses-options",o).success(function(w){"ok"==w.status&&(l.success("Opciones actualizadas"),m.selectedSes.options=o.options)})},m.shared.saveConfs=m.saveConfs,m.shared.updateConf=function(){if(null==m.selectedSes.conf){m.selectedSes.conf={};for(var o=m.selectedSes.options||"",w=0;w<o.length;w++)m.selectedSes.conf[o[w]]=!0}return!0},m.buildConfStr=function(){var o="";for(var w in m.selectedSes.conf)m.selectedSes.conf[w]&&(o+=w);return o}}),adpp.controller("DashboardRubricaController",function(g){var l=g;l.reports=[],l.result=[],l.selectedReport=null,l.shared.resetRubricaGraphs=function(){l.alumState=null,l.barOpts={chart:{type:"multiBarChart",height:320,x:function x(m){return m.label},y:function y(m){return m.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},l.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},l.shared.resetRubricaGraphs()}),adpp.controller("GeoAdminController",["$scope","$http","NgMap",function(g,h,l){var m=g;m.openRight=!1,m.rightTab="",m.mOverlays=[],m.sOverlays=[],m.selectedOverlay=null,m.overlayBuffer=[];var w=function toOverlay(C){return{id:C.id,name:C.name,description:C.description,color:x(C),type:C.type,fullType:z(C.type),geom:JSON.parse(C.geom)}},x=function getColor(){return"blue"},y=function packOverlay(C){return{name:C.name,description:C.description,iteration:0,qid:null==m.questions[m.selectedQs]?-1:m.questions[m.selectedQs].id,type:C.type,geom:JSON.stringify(C.geom)}},z=function getFullType(C){return"M"===C?"marker":"P"===C?"polygon":"L"===C?"polyline":"R"===C?"rectangle":"C"===C?"circle":"I"===C?"image":void 0};m.shared.processMapData=function(C,D){var E=C.split(" ");console.log(E),m.map.setCenter(new google.maps.LatLng(+E[1],+E[2])),m.map.setZoom(+E[3]),m.nav="NAV"==E[4],m.edit="EDIT"==E[4]||"EDIT"==E[5],A(D),google.maps.event.trigger(m.map,"resize")};var A=function getPrevOverlays(C){h.post("list-default-overlay",{qid:C}).success(function(D){var E=D.map(w);m.mOverlays=m.mOverlays.concat(E.filter(function(F){return"M"==F.type})),m.sOverlays=m.sOverlays.concat(E.filter(function(F){return"M"!=F.type}))})};m.clearOverlay=function(){m.newOverlay={name:"",description:"",color:"blue",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},m.updateOverlayList=function(){var C={qid:null==m.questions[m.selectedQs]?-1:m.questions[m.selectedQs].id};h.post("list-overlay",C).success(function(D){var E=D.map(w);m.mOverlays=E.filter(function(F){return"M"==F.type}),m.sOverlays=E.filter(function(F){return"M"!=F.type})})},m.shared.updateOverlayList=m.updateOverlayList,m.onMapOverlayCompleted=function(C){m.map.mapDrawingManager[0].setDrawingMode(null),m.newOverlay.fullType=C.type,m.newOverlay.type="polyline"==C.type?"L":C.type[0].toUpperCase(),m.newOverlay.geom.position=C.overlay.getPosition?positionToArray(C.overlay.getPosition()):null,m.newOverlay.geom.radius=C.overlay.radius,m.newOverlay.geom.center=positionToArray(C.overlay.center),m.newOverlay.geom.path=C.overlay.getPath?mutiplePositionToArray(C.overlay.getPath()):null,m.newOverlay.geom.bounds=C.overlay.getBounds?boundsToArray(C.overlay.getBounds()):null,m.newOverlay.centroid=centroidAsLatLng(m.newOverlay.type,m.newOverlay.geom),m.map.showInfoWindow("iw2"),C.overlay.setMap(null)},m.colorizeShape=function(C){m.map.shapes&&m.map.shapes.nshp&&(m.map.shapes.nshp.set("fillColor",C),m.map.shapes.nshp.set("strokeColor","dark"+C))},m.closeOverlay=function(){m.clearOverlay(),m.map.infoWindows.iw2.close()};var B=function updateOverlay(){var C="M"==m.newOverlay.type?m.map.markers.nmkr:m.map.shapes.nshp;m.newOverlay.geom.position=C.getPosition?positionToArray(C.getPosition()):null,m.newOverlay.geom.radius=C.radius,m.newOverlay.geom.center=positionToArray(C.center),m.newOverlay.geom.path=C.getPath?mutiplePositionToArray(C.getPath()):null,m.newOverlay.geom.bounds=C.getBounds?boundsToArray(C.getBounds()):null,m.newOverlay.centroid=centroidAsLatLng(m.newOverlay.type,m.newOverlay.geom)};m.sendOverlay=function(){B(),m.overlayBuffer.push(y(m.newOverlay)),console.log(m.overlayBuffer),"M"==m.newOverlay.type?m.mOverlays.push(m.newOverlay):m.sOverlays.push(m.newOverlay),m.closeOverlay()},m.shared.clearOverlayBuffer=function(){m.mOverlays=[],m.sOverlays=[],m.overlayBuffer=[]},m.shared.sendOverlayBuffer=function(C){console.log(C,m.overlayBuffer),m.overlayBuffer.forEach(function(D){D.qid=C,h.post("add-overlay",D).success(function(){console.log("OK")})})},m.clickOverlay=function(){m.selectOverlay(this.id)},m.selectOverlay=function(C){m.selectedOverlay=m.mOverlays.find(function(D){return D.id==C})||m.sOverlays.find(function(D){return D.id==C}),m.selectedOverlay.centroid=centroidAsLatLng(m.selectedOverlay.type,m.selectedOverlay.geom),m.map.panTo(m.selectedOverlay.centroid),m.map.showInfoWindow("iw")},m.googleSearch=function(){var C=this.getPlace();null==C||null==C.geometry||null==C.geometry.location||(m.map.mapDrawingManager[0].setDrawingMode(null),m.newOverlay.fullType="marker",m.newOverlay.type="M",m.newOverlay.geom.position=positionToArray(C.geometry.location),m.newOverlay.centroid=centroidAsLatLng(m.newOverlay.type,m.newOverlay.geom),m.map.showInfoWindow("iw2"),m.map.panTo(C.geometry.location))},m.shared.getPluginMapOptions=function(){return{nav:m.nav,edit:m.edit}},m.shared.getActiveMap=function(){return m.map},function init(){m.updateOverlayList(),m.clearOverlay(),l.getMap().then(function(C){console.log("MAP cargado correctamente"),m.map=C,m.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),m.map.infoWindows.iw.close()})}()}]),adpp.filter("htmlExtractText",function(){return function(g){return g?(g+"").replace(/<[^>]+>/gm,""):""}}),adpp.filter("lang",function(){function g(h){if(null!=window.DIC)return window.DIC[h]?window.DIC[h]:(window.warnDIC[h]||(console.warn("Cannot find translation for ",h),window.warnDIC[h]=!0),h)}return g.$stateful=!0,g});var generateTeams=function(g,h,l,m){if(null==l||0==l)return[];console.log(g);var o=g;o.sort(function(A,B){return h(B)-h(A)});for(var w=[],x=g.length/l,A=0;A<x;A++)m?function(){for(var B=[],C=o.length/l,D=0;D<l;D++)B.push(~~(Math.random()*C+C*D));w.push(o.filter(function(D,E){return B.includes(E)})),o=o.filter(function(D,E){return!B.includes(E)})}():(w.push(o.filter(function(B,C){return C<l})),o=o.filter(function(B,C){return C>=l}));for(var y=[],z=0,A=0;A<w.length;A++)1<w[A].length||0==y.length?y.push(w[A]):(y[z%y.length].push(w[A][0]),z++);return y},isDifferent=function(g){return"performance homog"!==g&&(!("performance heterg"!==g)||"knowledgeType homog"!==g&&!("knowledgeType heterg"!==g))},habMetric=function(g){switch(g.aprendizaje){case"Teorico":return-2;case"Reflexivo":return-1;case"Activo":return 1;case"Pragmatico":return 2;}return 0},quillMapHandler=function(){alert("Mapa s\xF3lo disponible para preguntas")},positionToArray=function(g){return null==g?null:[g.lat(),g.lng()]},mutiplePositionToArray=function(g){for(var m,h=[],l=0;l<g.getLength();l++)m=g.getAt(l),h.push(positionToArray(m));return h},boundsToArray=function(g){return[positionToArray(g.getSouthWest()),positionToArray(g.getNorthEast())]},avgCoord=function(g){for(var h=0,l=0,m=0;m<g.length;m++)h+=g[m][0],l+=g[m][1];return[h/g.length,l/g.length]},centroidAsLatLng=function(g,h){var l=centroid(g,h);return new google.maps.LatLng(l[0],l[1])},centroid=function(g,h){return"M"==g?h.position:"C"==g?h.center:"R"==g?avgCoord(h.bounds):"P"==g||"L"==g?avgCoord(h.path):null};
