"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer"]);adpp.controller("AdminController",function(a,b,c,g,h){var k=a;h.NUMBER_FORMATS.GROUP_SEP="",k.shared={},k.sessions=[],k.selectedSes=null,k.documents=[],k.questions=[],k.newUsers=[],k.users={},k.selectedIndex=-1,k.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],k.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],k.init=function(){k.shared.updateSesData()},k.selectSession=function(l){k.selectedIndex=l,k.selectedSes=k.sessions[l],k.requestDocuments(),k.requestQuestions(),k.getNewUsers(),k.getMembers(),k.shared.verifyGroups(),k.shared.resetGraphs(),k.shared.verifyTabs(),k.shared.resetTab(),g.path(k.selectedSes.id)},k.shared.updateSesData=function(){b({url:"get-session-list",method:"post"}).success(function(l){console.log("Session data updated"),k.sessions=l,-1==k.selectedIndex?k.sesFromURL():k.selectSession(k.selectedIndex)})},k.sesFromURL=function(){var l=+g.path().substring(1),m=k.sessions.findIndex(function(o){return o.id==l});-1!=m&&k.selectSession(m)},k.requestDocuments=function(){var l={sesid:k.selectedSes.id};b({url:"documents-session",method:"post",data:l}).success(function(m){k.documents=m})},k.deleteDocument=function(l){b({url:"delete-document",method:"post",data:{docid:l}}).success(function(){k.requestDocuments()})},k.requestQuestions=function(){var l={sesid:k.selectedSes.id};b({url:"questions-session",method:"post",data:l}).success(function(m){k.questions=m})},k.getNewUsers=function(){var l={sesid:k.selectedSes.id};b({url:"get-new-users",method:"post",data:l}).success(function(m){k.newUsers=m})},k.getMembers=function(){var l={sesid:k.selectedSes.id};b({url:"get-ses-users",method:"post",data:l}).success(function(m){k.usersArr=m,m.forEach(function(o){k.users[o.id]=o})})},k.openNewSes=function(){c.open({templateUrl:"templ/new-ses.html"})},k.init()}),adpp.controller("TabsController",function(a){var c=a;c.tabOptions=["Descripci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos"],c.selectedTab=0,c.selectedTabConfig=-1,c.shared.resetTab=function(){c.selectedTab=0,null!=c.selectedSes&&1<c.selectedSes.status&&(c.selectedTab=1),c.selectedTabConfig=-1,7==c.selectedSes.status&&(c.selectedTab=0,c.selectedTabConfig=2)},c.shared.verifyTabs=function(){"L"==c.selectedSes.type?(c.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Calibraci\xF3n Rubrica",val:5},{name:"Evaluaci\xF3n de Pares",val:6}],c.tabOptions=["Configuraci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos","R\xFAbrica"],c.sesStatusses=["Configuraci\xF3n","Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],c.shared.getRubrica(),c.shared.getExampleReports(),c.shared.getReports()):(c.iterationNames=[{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],c.tabOptions=["Configuraci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos"],c.sesStatusses=["Configuraci\xF3n","Individual","An\xF3nimo","Grupal","Finalizada"]),1<c.selectedSes.status&&(c.selectedTab=1)},c.setTab=function(g){c.selectedTab=g},c.setTabConfig=function(g){c.selectedTabConfig=g}}),adpp.controller("SesEditorController",function(a,b){var c=a;c.updateSession=function(){if(!(3>c.selectedSes.name.length||5>c.selectedSes.descr.length)){var g={name:c.selectedSes.name,descr:c.selectedSes.descr,id:c.selectedSes.id};b({url:"update-session",method:"post",data:g}).success(function(){console.log("Session updated")})}},c.shared.changeState=function(){if(!(c.selectedSes.status>=c.sesStatusses.length)&&(!(3<=c.selectedSes.status)||c.selectedSes.grouped)&&(!(7<=c.selectedSes.status)||c.selectedSes.paired)){var g={sesid:c.selectedSes.id};b({url:"change-state-session",method:"post",data:g}).success(function(){c.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(a,b){var c=a;c.addToSession=function(){if(0!=c.newMembs.length){var h={users:c.newMembs.map(function(k){return k.id}),sesid:c.selectedSes.id};b({url:"add-ses-users",method:"post",data:h}).success(function(k){"ok"==k.status&&(c.getNewUsers(),c.getMembers())})}}}),adpp.controller("QuestionsController",function(a,b){var c=a;c.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",answer:-1},c.selectAnswer=function(g){c.newQuestion.answer=g},c.addQuestion=function(){if(-1!=c.newQuestion.answer){var g={content:c.newQuestion.content,options:c.newQuestion.alternatives.join("\n"),comment:c.newQuestion.comment,answer:c.newQuestion.answer,sesid:c.selectedSes.id,other:c.newQuestion.other};b({url:"add-question",method:"post",data:g}).success(function(h){"ok"==h.status&&c.requestQuestions()}),c.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",answer:-1}}}}),adpp.controller("DashboardController",function(a,b){var c=a;c.iterationIndicator=1,c.shared.resetGraphs=function(){null!=c.selectedSes&&"L"==c.selectedSes.type?c.iterationIndicator=Math.max(Math.min(6,c.selectedSes.status-2),0):"S"==c.selectedSes.type&&(c.iterationIndicator=Math.max(Math.min(3,c.selectedSes.status-1),1)),c.alumState=null,c.barOpts={chart:{type:"multiBarChart",height:320,x:function x(g){return g.label},y:function y(g){return g.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},c.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}],c.updateState()},c.updateState=function(){4>=c.iterationIndicator?c.updateStateIni():c.updateStateRub()},c.updateStateIni=function(){c.alumTime={};var g={sesid:c.selectedSes.id,iteration:c.iterationIndicator};"S"==c.selectedSes.type?(b({url:"get-alum-full-state-sel",method:"post",data:g}).success(function(h){c.alumState={},h.forEach(function(k){null==c.alumState[k.uid]?(c.alumState[k.uid]={},c.alumState[k.uid][k.qid]=k.correct):c.alumState[k.uid][k.qid]=k.correct})}),b({url:"get-alum-state-sel",method:"post",data:g}).success(function(h){var k=h.map(function(l){return l.score/=c.questions.length,l});c.buildBarData(k)})):"L"==c.selectedSes.type&&(b({url:"get-alum-state-lect",method:"post",data:g}).success(function(h){c.alumState=h,c.buildBarData(h),c.getAlumDoneTime(g)}),b({url:"get-ideas-progress",method:"post",data:g}).success(function(h){c.numProgress=0,c.numUsers=Object.keys(c.users).length-1;var k=3*c.documents.length;0!=k&&(h.forEach(function(l){c.numProgress+=l.count/k}),c.numProgress*=100/c.numUsers)}))},c.getAlumDoneTime=function(g){b({url:"get-alum-done-time",method:"post",data:g}).success(function(h){c.numComplete=0,h.forEach(function(k){c.numComplete+=1;var l=c.alumState.findIndex(function(m){return m.uid==k.uid});-1==l?c.alumState.push(k):c.alumState[l].dtime=~~k.dtime})})},c.buildBarData=function(g){var h=5;c.barData[0].values=[];for(var l,k=0;k<h;k++)l=20*k+"% - "+20*(k+1)+"%",c.barData[0].values.push({label:l,value:0});g.forEach(function(k){var l=Math.min(Math.floor(h*k.score),h-1);c.barData[0].values[l].value+=1}),c.barOpts.chart.xAxis.axisLabel="Rendimiento"},c.updateStateRub=function(){5==c.iterationIndicator?c.computeDif():6==c.iterationIndicator&&c.getAllReportResult()},c.showName=function(g){return g.example?g.title+" - Texto ejemplo":g.id+" - Reporte de Alumno "+c.users[g.uid].name},c.shared.getReports=function(){var g={sesid:c.selectedSes.id};b({url:"get-report-list",method:"post",data:g}).success(function(h){c.reports=h,c.exampleReports=h.filter(function(k){return k.example})})},c.getReportResult=function(){var g={repid:c.selectedReport.id};b({url:"get-report-result",method:"post",data:g}).success(function(h){c.result=h,c.updateState()})},c.getAllReportResult=function(){var g={sesid:c.selectedSes.id};b({url:"get-report-result-all",method:"post",data:g}).success(function(h){c.resultAll=h,c.pairArr=h[0]?Array(h[0].length):[],console.log(h),c.buildRubricaBarData(h)})},c.buildRubricaBarData=function(g){var h=3;c.barData[0].values=[];for(var l,k=0;k<h;k++)l=k+1+" - "+(k+2),c.barData[0].values.push({label:l,value:0});g.forEach(function(k){var l=k.reduce(function(o,q){return o+q.val},0)/k.length,m=Math.min(Math.floor(l-1),h-1);c.barData[0].values[m].value+=1}),c.barOpts.chart.xAxis.axisLabel="Puntaje"},c.computeDif=function(){c.result&&function(){var g=c.result.findIndex(function(h){return"P"==c.users[h.uid].role});-1!=g&&function(){var h=c.result[g].val,k=[];c.result.forEach(function(l,m){m!=g&&k.push(Math.abs(h-l.val))}),c.buildRubricaDiffData(k)}()}()},c.buildRubricaDiffData=function(g){console.log("difs",g);var h=6;c.barData[0].values=[];for(var l,k=0;k<h;k++)l=0.5*k+" - "+0.5*(k+1),c.barData[0].values.push({label:l,value:0});g.forEach(function(k){var l=Math.min(Math.floor(2*k),h-1);c.barData[0].values[l].value+=1}),c.barOpts.chart.xAxis.axisLabel="Diferencia de Puntaje"},c.getReportAuthor=function(g){if(c.reports){var h=c.reports.find(function(k){return k.id==g});if(h)return c.users[h.uid]?c.users[h.uid].name:null}}}),adpp.controller("GroupController",function(a,b){var c=a;c.methods=["Aleatorio","Rendimiento Homogeneo","Rendimiento Heterogeneo","Tipo Aprendizaje Homogeneo","Tipo Aprendizaje Heterogeoneo"],c.lastI=-1,c.lastJ=-1,c.shared.verifyGroups=function(){c.groupNum=3,c.groupMet=c.methods[0],c.groups=[],c.groupNames=[],null!=c.selectedSes&&c.selectedSes.grouped&&(c.groupNum=null,c.groupMet=null,c.generateGroups(!0))},c.generateGroups=function(g){if(!(null==g&&(1>c.groupNum||c.groupNum>c.users.length))){var h={sesid:c.selectedSes.id,gnum:c.groupNum,method:c.groupMet},k="";"S"==c.selectedSes.type?k="group-proposal-sel":"L"==c.selectedSes.type&&(k="group-proposal-lect"),"Tipo Aprendizaje Homogeneo"==c.groupMet||"Tipo Aprendizaje Heterogeoneo"==c.groupMet?k="group-proposal-hab":"Aleatorio"==c.groupMet&&(k="group-proposal-rand"),""!=k&&b({url:k,method:"post",data:h}).success(function(l){c.groups=l,c.groupsProp=angular.copy(c.groups),console.log(l),c.groupNames=[]})}},c.acceptGroups=function(){if(null!=c.groupsProp){var g={sesid:c.selectedSes.id,groups:JSON.stringify(c.groupsProp.map(function(h){return h.map(function(k){return k.uid})}))};console.log(g),b({url:"set-groups",method:"post",data:g}).success(function(h){"ok"==h.status&&(console.log("Groups accepted"),c.selectedSes.grouped=!0,c.shared.verifyGroups())})}},c.swapTable=function(g,h){if(console.log(g,h,c.groups),-1==c.lastI&&-1==c.lastJ)return c.lastI=g,void(c.lastJ=h);if(c.lastI!=g||c.lastJ!=h){var k=angular.copy(c.groupsProp[g][h]);c.groupsProp[g][h]=angular.copy(c.groupsProp[c.lastI][c.lastJ]),c.groupsProp[c.lastI][c.lastJ]=k}c.lastI=-1,c.lastJ=-1}}),adpp.controller("RubricaController",function(a,b){var c=a;c.criterios=[],c.newCriterio={},c.editable=!1,c.exampleReports=[],c.newExampleReport="",c.addCriterio=function(){c.criterios.push(c.newCriterio),c.newCriterio={}},c.removeCriterio=function(g){c.criterios.splice(g,1)},c.checkSum=function(){return 100==c.criterios.reduce(function(g,h){return g+h.pond},0)},c.shared.getRubrica=function(){c.criterios=[],c.newCriterio={},c.editable=!1;var g={sesid:c.selectedSes.id};b({url:"get-admin-rubrica",method:"post",data:g}).success(function(h){0==h.length?c.editable=!0:c.criterios=h})},c.saveRubrica=function(){var g={sesid:c.selectedSes.id};b({url:"send-rubrica",method:"post",data:g}).success(function(h){"ok"==h.status&&function(){var k=h.id;c.criterios.forEach(function(l){var m=angular.copy(l);m.rid=k,b({url:"send-criteria",method:"post",data:m}).success(function(o){"ok"==o.status&&console.log("Ok")})}),c.editable=!1}()})},c.shared.getExampleReports=function(){c.exampleReports=[];var g={sesid:c.selectedSes.id};b({url:"get-example-reports",method:"post",data:g}).success(function(h){c.exampleReports=h})},c.sendExampleReport=function(){var g={sesid:c.selectedSes.id,content:c.newExampleReport.text,title:c.newExampleReport.title};b({url:"send-example-report",method:"post",data:g}).success(function(){c.newExampleReport="",c.shared.getExampleReports()})},c.setActiveExampleReport=function(g){var h={sesid:c.selectedSes.id,rid:g.id};b({url:"set-active-example-report",method:"post",data:h}).success(function(k){"ok"==k.status&&(c.exampleReports.forEach(function(l){l.active=!1}),g.active=!0)})},c.goToReport=function(g){c.setActiveExampleReport(g),window.location.href="to-rubrica?sesid="+c.selectedSes.id},c.pairAssign=function(){var g={sesid:c.selectedSes.id,rnum:2};b({url:"assign-pairs",method:"post",data:g}).success(function(h){"ok"==h.status?c.selectedSes.paired=!0:c.errPairMsg=h.msg})}}),adpp.controller("DashboardRubricaController",function(a){var c=a;c.reports=[],c.result=[],c.selectedReport=null,c.shared.resetRubricaGraphs=function(){c.alumState=null,c.barOpts={chart:{type:"multiBarChart",height:320,x:function x(g){return g.label},y:function y(g){return g.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},c.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},c.shared.resetRubricaGraphs()});
