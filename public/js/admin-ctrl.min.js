"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification","ngQuill","ngMap"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;window.DIC=null,window.warnDIC={},adpp.config(["ngQuillConfigProvider",function(a){a.set({modules:{formula:!0,toolbar:{container:[["bold","italic","underline","strike"],// toggled buttons
[{color:[]},{background:[]}],// dropdown with defaults from theme
[{font:[]}],[{align:[]}],//[{ 'header': 1 }, { 'header': 2 }],               // custom button values
[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],// superscript/subscript
//[{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
//[{ 'direction': 'rtl' }],                         // text direction
//['blockquote', 'code-block'],
[{size:["small",!1,"large","huge"]}],// custom dropdown
//[{ 'header': [1, 2, 3, 4, 5, 6, false] }],
["clean"],// remove formatting button
["image","link","video"],// remove formatting button
["formula"]//['map']
],handlers:{map:quillMapHandler}}}})}]),adpp.controller("AdminController",function(a,e,h,b,c,d){var f=a;f.temp="",c.NUMBER_FORMATS.GROUP_SEP="",f.shared={},f.sessions=[],f.selectedSes=null,f.documents=[],f.questions=[],f.questionTexts=[],f.newUsers=[],f.users={},f.selectedId=-1,f.sesStatusses=["notPublicada","reading","personal","anon","teamWork","finished"],f.optConfidence=[0,25,50,75,100],f.iterationNames=[],f.showSeslist=!0,f.lang="english",f.secIcons={configuration:"cog",editor:"edit",dashboard:"bar-chart",users:"male",rubrica:"check-square",groups:"users",options:"sliders"},f.typeNames={L:"readComp",S:"multSel",M:"semUnits",E:"ethics"},f.misc={},f.init=function(){f.shared.updateSesData(),f.updateLang(f.lang)},f.selectSession=function(c,d){f.selectedId=d,f.selectedSes=c,f.requestDocuments(),f.requestSemDocuments(),f.requestQuestions(),f.getNewUsers(),f.getMembers(),f.shared.verifyGroups(),f.shared.resetGraphs(),f.shared.verifyTabs(),f.shared.resetTab(),f.shared.updateConf(),b.path(f.selectedSes.id)},f.shared.updateSesData=function(){e({url:"get-session-list",method:"post"}).success(function(b){if(console.log("Session data updated"),f.sessions=b,-1!=f.selectedId){var c=f.sessions.find(function(a){return a.id==f.selectedId});null!=c&&f.selectSession(c,f.selectedId)}else f.sesFromURL()})},f.sesFromURL=function(){var c=+b.path().substring(1),d=f.sessions.find(function(b){return b.id==c});null!=d&&f.selectSession(d,c)},f.requestDocuments=function(){var a={sesid:f.selectedSes.id};e({url:"documents-session",method:"post",data:a}).success(function(a){f.documents=a})},f.shared.updateDocuments=f.requestDocuments,f.deleteDocument=function(a){e({url:"delete-document",method:"post",data:{docid:a}}).success(function(){f.requestDocuments()})},f.requestQuestions=function(){var a={sesid:f.selectedSes.id};e({url:"questions-session",method:"post",data:a}).success(function(a){f.questions=a.map(function(a){return a.options=a.options.split("\n"),a})}),e({url:"get-question-text",method:"post",data:a}).success(function(a){f.questionTexts=a})},f.requestSemDocuments=function(){var a={sesid:f.selectedSes.id};e({url:"semantic-documents",method:"post",data:a}).success(function(a){f.semDocs=a})},f.getNewUsers=function(){var a={sesid:f.selectedSes.id};e({url:"get-new-users",method:"post",data:a}).success(function(a){f.newUsers=a})},f.getMembers=function(){var a={sesid:f.selectedSes.id};e({url:"get-ses-users",method:"post",data:a}).success(function(a){f.usersArr=a,f.users={},a.forEach(function(a){f.users[a.id]=a})})},f.openNewSes=function(){h.open({templateUrl:"templ/new-ses.html"})},f.openDuplicateSes=function(){if(null!=f.selectedSes){var a=angular.copy(f.selectedSes);h.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:f,resolve:{data:function b(){return a}}})}},f.openDuplicateSesSpec=function(d,a){a.stopPropagation();var b=angular.copy(d);h.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:f,resolve:{data:function a(){return b}}})},f.toggleSidebar=function(){f.openSidebar=!f.openSidebar,f.shared.updateState()},f.updateLang=function(a){e.get("data/"+a+".json").success(function(a){window.DIC=a})},f.shared.resetSesId=function(){f.selectedId=-1},f.changeLang=function(){f.lang="english"==f.lang?"spanish":"english",f.updateLang(f.lang)},f.generateCode=function(){var a={id:f.selectedSes.id};e.post("generate-session-code",a).success(function(a){null!=a.code&&(f.selectedSes.code=a.code)})},f.flang=function(a){return d("lang")(a)},f.init()}),adpp.controller("TabsController",function(a){var c=a;c.tabOptions=[],c.tabConfig=["users","groups"],c.selectedTab="",c.shared.resetTab=function(){c.selectedTab="editor",null!=c.selectedSes&&1<c.selectedSes.status&&(c.selectedTab="dashboard"),c.selectedTabConfig=-1,7==c.selectedSes.status&&c.shared.gotoRubrica()},c.shared.verifyTabs=function(){"L"==c.selectedSes.type?(c.iterationNames=[{name:"reading",val:0},{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3},{name:"report",val:4},{name:"rubricCalib",val:5},{name:"pairEval",val:6}],c.tabOptions=["editor","users","groups","rubrica","dashboard"],c.sesStatusses=["configuration","reading","individual","anon","teamWork","report","rubricCalib","pairEval","finished"],c.shared.getRubrica(),c.shared.getExampleReports(),c.shared.getReports()):"S"==c.selectedSes.type?(c.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],c.tabOptions=["editor","users","groups","dashboard"],c.sesStatusses=["configuration","individual","anon","teamWork","finished"]):"M"==c.selectedSes.type?(c.iterationNames=[{name:"individual",val:1},{name:"teamWork",val:3},{name:"report",val:4},{name:"pairEval",val:6}],c.tabOptions=["editor","users","groups","rubrica","dashboard"],c.sesStatusses=[{i:-1,name:"configuration"},{i:1,name:"individual"},{i:3,name:"teamWork"},{i:4,name:"report"},{i:6,name:"pairEval"},{i:7,name:"finished"}],c.shared.getRubrica(),c.shared.getExampleReports(),c.shared.getReports()):"E"==c.selectedSes.type?(c.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],c.tabOptions=["editor","users","groups","dashboard"],c.sesStatusses=["configuration","individual","anon","teamWork","finished"]):"R"==c.selectedSes.type&&(c.iterationNames=[],c.tabOptions=["editor","users","dashboard"],c.sesStatusses=["configuration"]),1<c.selectedSes.status&&(c.selectedTab="dashboard")},c.setTab=function(a){c.selectedTab=a},c.setTabConfig=function(a){c.selectedTabConfig=a},c.backToList=function(){c.shared.resetSesId(),c.tabOptions=[],c.selectedTab=""},c.shared.gotoGrupos=function(){c.selectedTab="groups"},c.shared.gotoRubrica=function(){c.selectedTab="rubrica"}}),adpp.controller("DocumentsController",function(e,f,a,b){var h=e;h.busy=!1,h.dfs=[],h.shared.dfs=h.dfs,h.getDifferentials=function(){f.post("differentials",{sesid:h.selectedSes.id}).success(function(a){a.forEach(function(a){a.name=a.title,h.dfs[a.orden]=a})})},h.uploadDocument=function(c){h.busy=!0;var d=new FormData(c.target);f.post("upload-file",d,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(d){"ok"==d.status&&b(function(){a.success("Documento cargado correctamente"),c.target.reset(),h.busy=!1,h.shared.updateDocuments()},2e3)})},h.sendDFS=function(){var b=0;h.misc.dfSending=!0,h.dfs.forEach(function(c,d){var g=c.id?"update-differential":"add-differential";c.orden=d,c.sesid=h.selectedSes.id,f.post(g,c).success(function(){b+=1,b==h.dfs.length-1&&(a.success("Diferenciales guardados correctamente"),h.misc.dfSending=!1,h.getDifferentials())})})},h.shared.sendDFS=h.sendDFS,h.getDifferentials()}),adpp.controller("SesEditorController",function(b,e,g){var c=b;c.mTransition={1:3,3:5,5:6,6:8,8:9},c.splitDescr=!1,c.splDes1="",c.splDes2="",c.toggleSplit=function(){c.splitDescr=!c.splitDescr,c.splitDescr?(c.splDes1=c.selectedSes.descr.split("\n")[0],c.splDes2=c.selectedSes.descr.split("\n")[1]||""):c.selectedSes.descr=c.splDes1+"\n"+c.splDes2},c.updateSession=function(){if(c.splitDescr&&(c.selectedSes.descr=c.splDes1+"\n"+c.splDes2),3>c.selectedSes.name.length||5>c.selectedSes.descr.length)return void g.error("Datos de la sesi\xF3n incorrectos o incompletos");var a={name:c.selectedSes.name,descr:c.selectedSes.descr,id:c.selectedSes.id};e({url:"update-session",method:"post",data:a}).success(function(){console.log("Session updated")})},c.shared.changeState=function(){if("M"!=c.selectedSes.type&&c.selectedSes.status>=c.sesStatusses.length)return void g.error("La sesi\xF3n est\xE1 finalizada");if("M"==c.selectedSes.type&&9<=c.selectedSes.status)return void g.error("La sesi\xF3n est\xE1 finalizada");if("L"==c.selectedSes.type&&3<=c.selectedSes.status&&!c.selectedSes.grouped||"M"==c.selectedSes.type&&3<=c.selectedSes.status&&!c.selectedSes.grouped||"E"==c.selectedSes.type&&2<=c.selectedSes.status&&!c.selectedSes.grouped||"S"==c.selectedSes.type&&2<=c.selectedSes.status&&!c.selectedSes.grouped)return c.shared.gotoGrupos(),void g.error("Los grupos no han sido generados");if("L"==c.selectedSes.type&&6<=c.selectedSes.status&&c.shared.isRubricaSet&&!c.shared.isRubricaSet()||"M"==c.selectedSes.type&&5<=c.selectedSes.status&&c.shared.isRubricaSet&&!c.shared.isRubricaSet())return c.shared.gotoRubrica(),void g.error("La r\xFAbrica no ha sido asignada");if("L"==c.selectedSes.type&&7<=c.selectedSes.status&&(null==c.selectedSes.paired||0==c.selectedSes.paired)||"M"==c.selectedSes.type&&6<=c.selectedSes.status&&(null==c.selectedSes.paired||0==c.selectedSes.paired))return c.shared.gotoRubrica(),void g.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");"E"==c.selectedSes.type&&0==c.selectedSes.status&&c.shared.sendDFS();var d=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(d)if("M"==c.selectedSes.type){var f={sesid:c.selectedSes.id,state:c.mTransition[c.selectedSes.status]||c.selectedSes.status};e({url:"force-state-session",method:"post",data:f}).success(function(){c.shared.updateSesData()})}else{1==c.selectedSes.status&&(c.updateSession(),"S"==c.selectedSes.type&&c.shared.saveConfs());var a={sesid:c.selectedSes.id};e({url:"change-state-session",method:"post",data:a}).success(function(){c.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(d,f,a){var e=d;e.addToSession=function(){if(0==e.newMembs.length)return void a.error("No hay usuarios seleccionados para agregar");var b={users:e.newMembs.map(function(a){return a.id}),sesid:e.selectedSes.id};f({url:"add-ses-users",method:"post",data:b}).success(function(a){"ok"==a.status&&e.refreshUsers()})},e.removeUser=function(b){if(2>=e.selectedSes.status){var c={uid:b,sesid:e.selectedSes.id};f({url:"delete-ses-user",method:"post",data:c}).success(function(a){"ok"==a.status&&e.refreshUsers()})}},e.refreshUsers=function(){e.getNewUsers(),e.getMembers()},e.shared.refreshUsers=e.refreshUsers}),adpp.controller("SemDocController",function(e,a,f){var c=e;c.newSDoc={id:null,title:"",content:""},c.addSemDoc=function(){var b={sesid:c.selectedSes.id,title:c.newSDoc.title,content:c.newSDoc.content};a({url:"add-semantic-document",method:"post",data:b}).success(function(a){"ok"==a.status&&(c.requestSemDocuments(),f.success("Texto agregado correctamente"),c.newSDoc={id:null,title:"",content:""})})},c.deleteText=function(b){a.post("delete-semantic-document",{id:b}).success(function(a){"ok"==a.status&&(c.requestSemDocuments(),f.success("Texto eliminado correctamente"))})},c.startEditText=function(a){c.newSDoc={id:a.id,title:a.title,content:a.content},f.info("Edite el texto en el formulario")},c.updateSemDoc=function(){if(null==c.newSDoc.id)return void f.error("No hay texto a editar.");var b={id:c.newSDoc.id,sesid:c.selectedSes.id,title:c.newSDoc.title,content:c.newSDoc.content};a({url:"update-semantic-document",method:"post",data:b}).success(function(a){"ok"==a.status&&(c.requestSemDocuments(),f.success("Texto editado correctamente."),c.newSDoc={id:null,title:"",content:""})})}}),adpp.controller("QuestionsController",function(h,i,j,b,c,e){var k=h;k.qsLabels=["A","B","C","D","E"],k.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},k.newText={id:null,title:"",content:""},k.newQsExp=!1,k.startNewQuestion=function(){k.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},k.newQsExp=!0,k.shared.closePrevMapData()},k.selectAnswer=function(a){k.newQuestion.answer=a},k.addQuestion=function(){if(-1==k.newQuestion.answer)return void j.error("Debe indicar la respuesta correcta a la pregunta");if(""==k.newQuestion.alternatives[0]||""==k.newQuestion.alternatives[1])return void j.error("Debe ingresar al menos 2 alternativas");if(k.newQuestion.alternatives.some(function(b,c){return k.newQuestion.alternatives.indexOf(b)!=c}))return void j.error("Hay alternativas duplicadas");if(""==k.newQuestion.comment)return void j.error("Debe ingresar un comentario para la pregunta");k.newQuestion.includesMap&&f();var a={content:k.newQuestion.content,options:k.newQuestion.alternatives.join("\n"),comment:k.newQuestion.comment,answer:k.newQuestion.answer,sesid:k.selectedSes.id,textid:k.newQuestion.textid,other:k.newQuestion.other,pluginData:k.newQuestion.pluginData};i({url:"add-question",method:"post",data:a}).success(function(a){"ok"==a.status&&(k.requestQuestions(),j.success("Pregunta agrgada correctamente"),k.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},k.shared.sendOverlayBuffer&&k.shared.sendOverlayBuffer(a.id),k.newQsExp=!1)})},k.updateQuestion=function(){if(null==k.newQuestion.id)return void j.error("No hay pregunta para editar");if(-1==k.newQuestion.answer)return void j.error("Debe indicar la respuesta correcta a la pregunta");k.newQuestion.includesMap&&f();var b={id:k.newQuestion.id,content:k.newQuestion.content,options:k.newQuestion.alternatives.join("\n"),comment:k.newQuestion.comment,answer:k.newQuestion.answer,sesid:k.selectedSes.id,textid:k.newQuestion.textid,other:k.newQuestion.other,pluginData:k.newQuestion.pluginData};i({url:"update-question",method:"post",data:b}).success(function(c){"ok"==c.status&&(k.requestQuestions(),j.success("Pregunta editada correctamente"),k.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},k.shared.sendOverlayBuffer&&k.shared.sendOverlayBuffer(b.id),k.newQsExp=!1)})},k.startEditQuestion=function(c){k.questions.forEach(function(a){return a.expanded=!1}),k.newQuestion={id:c.id,content:c.content,alternatives:c.options,comment:c.comment,other:c.other,textid:c.textid,answer:c.answer,includesMap:c.plugin_data&&c.plugin_data.startsWith("MAP")},j.info("Edite la pregunta en el formulario."),k.newQuestion.includesMap&&(k.shared.clearOverlayBuffer&&k.shared.clearOverlayBuffer(),k.shared.processMapData(c.plugin_data,c.id),a()),k.newQsExp=!0},k.startEditText=function(a){k.newText={id:a.id,title:a.title,content:a.content},j.info("Edite el texto en el formulario."),k.newTextExp=!0},k.addQuestionText=function(){var a={sesid:k.selectedSes.id,title:k.newText.title,content:k.newText.content};i({url:"add-question-text",method:"post",data:a}).success(function(a){"ok"==a.status&&(k.requestQuestions(),k.newText={id:null,title:"",content:""},k.newTextExp=!1)})},k.updateQuestionText=function(){if(null==k.newText.id)return void j.error("No hay texto para editar");var a={id:k.newText.id,sesid:k.selectedSes.id,title:k.newText.title,content:k.newText.content};i({url:"update-question-text",method:"post",data:a}).success(function(a){"ok"==a.status&&(k.requestQuestions(),k.newText={title:"",content:""},k.newTextExp=!1)})},k.deleteQuestion=function(a){i.post("delete-question",{id:a}).success(function(){k.requestQuestions(),k.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},j.success("Pregunta eliminada correctamente")})},k.deleteQuestionText=function(a){i.post("delete-question-text",{id:a}).success(function(){k.requestQuestions(),j.success("Texto eliminado correctamente")})},k.configQuillExtra=function(a){k.editor=a},k.toggleMapPlugin=function(){k.newQuestion.includesMap=!k.newQuestion.includesMap,k.newQuestion.includesMap&&a()},k.expandQuestion=function(a){a.expanded?(a.expanded=!1,k.shared.closePrevMapData()):(k.questions.forEach(function(a){return a.expanded=!1}),a.expanded=!0,a.plugin_data&&a.plugin_data.startsWith("MAP")&&k.shared.processPrevMapData(a.plugin_data,a.id))};var a=function(){e(function(){var a=k.shared.getActiveMap();google.maps.event.trigger(a,"resize")},1e3)},f=function(){var e=k.shared.getPluginMapOptions(),f=k.shared.getActiveMap();if(null==f)//});
return void j.error("Ocurrio un error al cargar los datos del mapa, intente nuevamente.");var b=f.getCenter().lat(),c=f.getCenter().lng(),d=f.getZoom();k.newQuestion.pluginData="MAP "+b+" "+c+" "+d+(e.nav?" NAV":"")+(e.edit?" EDIT":"")}}),adpp.controller("DashboardController",function(a,k,d,l,m){var e=Math.floor,b=Math.max,f=Math.min,o=a;o.iterationIndicator=1,o.currentTimer=null,o.showCf=!1,o.dataDF=[],o.dataChatCount={},o.shared.resetGraphs=function(){null!=o.selectedSes&&"L"==o.selectedSes.type?o.iterationIndicator=b(f(6,o.selectedSes.status-2),0):"S"==o.selectedSes.type?o.iterationIndicator=b(f(3,o.selectedSes.status-1),1):"M"==o.selectedSes.type&&(o.iterationIndicator=b(f(6,o.selectedSes.status-2),0)),o.alumState=null,o.barOpts={chart:{type:"multiBarChart",height:320,x:function b(a){return a.label},y:function b(a){return a.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:o.flang("students")}}},o.barData=[{key:o.flang("students"),color:"#0077c1",values:[]}],o.updateState(),DASHBOARD_AUTOREALOD&&9>o.selectedSes.status&&o.reload(!0)},o.reload=function(a){a||o.updateState(),null!=o.currentTimer&&d.cancel(o.currentTimer),o.currentTimer=d(o.reload,15e3)},o.updateState=function(){1==o.selectedSes.status?o.shared.refreshUsers():4>=o.iterationIndicator?o.updateStateIni():o.updateStateRub()},o.shared.updateState=o.updateState,o.updateStateIni=function(){o.alumTime={};var d={sesid:o.selectedSes.id,iteration:o.iterationIndicator};if("S"==o.selectedSes.type)k({url:"get-alum-full-state-sel",method:"post",data:d}).success(function(b){for(var c in o.alumState={},o.users)"A"==o.users[c].role&&(o.alumState[c]={});b.forEach(function(a){null==o.alumState[a.uid]?(o.alumState[a.uid]={},o.alumState[a.uid][a.qid]=a.correct):o.alumState[a.uid][a.qid]=a.correct}),3==o.iterationIndicator&&k({url:"get-original-leaders",method:"post",data:{sesid:o.selectedSes.id}}).success(function(a){var c=angular.copy(o.alumState);o.alumState={},o.leaderTeamStr={},o.leaderTeamId={},a.forEach(function(a){o.alumState[a.leader]=c[a.leader],o.leaderTeamStr[a.leader]=a.team.map(function(a){return o.users[a]?o.users[a].name:"- "}).join(", "),o.leaderTeamId[a.leader]=a.id})}),o.shared.alumState=o.alumState}),k({url:"get-alum-state-sel",method:"post",data:d}).success(function(b){var c=b.map(function(a){return a.score/=o.questions.length,a});o.buildBarData(c)}),k({url:"get-alum-confidence",method:"post",data:d}).success(function(a){o.confidence={},a.forEach(function(a){o.confidence[a.qid]||(o.confidence[a.qid]={}),o.confidence[a.qid][a.conf]=a.freq})});else if("L"==o.selectedSes.type)k({url:"get-alum-state-lect",method:"post",data:d}).success(function(a){for(var b in o.alumState={},o.users)"A"==o.users[b].role&&(o.alumState[b]={});a.forEach(function(a){o.alumState[a.uid]=null==o.alumState[a.uid]?a:a}),o.buildBarData(a),o.getAlumDoneTime(d),3==o.iterationIndicator&&k({url:"get-original-leaders",method:"post",data:{sesid:o.selectedSes.id}}).success(function(a){var c=angular.copy(o.alumState);o.alumState={},o.leaderTeamStr={},a.forEach(function(a){o.alumState[a.leader]=c[a.leader],o.leaderTeamStr[a.leader]=a.team.map(function(a){return o.users[a]?o.users[a].name:"- "}).join(", ")})}),o.shared.alumState=o.alumState}),k({url:"get-ideas-progress",method:"post",data:d}).success(function(a){o.numProgress=0,o.numUsers=Object.keys(o.users).length-1;var c=3*o.documents.length;0!=c&&(a.forEach(function(a){o.numProgress+=a.count/c}),o.numProgress*=100/o.numUsers)});else if("M"==o.selectedSes.type)k({url:"get-alum-state-semantic",method:"post",data:d}).success(function(a){for(var b in o.alumState={},o.numUsers=0,o.users)"A"==o.users[b].role&&(o.alumState[b]={},o.numUsers++);a.forEach(function(a){o.alumState[a.uid]=null==o.alumState[a.uid]?a:a}),o.buildBarData(a),o.getAlumDoneTime(d),3==o.iterationIndicator&&k({url:"get-original-leaders",method:"post",data:{sesid:o.selectedSes.id}}).success(function(a){var c=angular.copy(o.alumState);o.alumState={},o.leaderTeamStr={},a.forEach(function(a){o.alumState[a.leader]=c[a.leader],o.leaderTeamStr[a.leader]=a.team.map(function(a){return o.users[a]?o.users[a].name:"- "}).join(", ")})}),o.shared.alumState=o.alumState});else if("E"==o.selectedSes.type){var e={sesid:o.selectedSes.id},a=o.selectedSes.grouped?"get-differential-all":"get-differential-indv";k.post(a,e).success(function(b){o.dataDF=[],console.log("SELF"),console.log(o);var c=-1,h=-1,l=["","ind","anon","team"];b.forEach(function(d){if(d.tmid!=c){h+=1,c=d.tmid;var e=d.uid,f=1;if(o.shared.groups){var g=o.shared.groups.find(function(a){return a.some(function(a){return a.uid==e})});f=g?g.length:1}o.dataDF.push({tmid:c,ind:[],anon:[],team:[],glen:f})}o.dataDF[h][l[d.iteration]].push(d)}),k.post("get-chat-count",e).success(function(a){o.dataChatCount={},a.forEach(function(a){o.dataChatCount[a.tmid]||(o.dataChatCount[a.tmid]={}),o.dataChatCount[a.tmid][a.orden]=a.count})}),o.shared.dataDF=o.dataDF})}},o.avgAlum=function(c){if(null!=o.alumState&&null!=o.alumState[c]){var a=0,d=0;for(var e in o.alumState[c])o.alumState[c][e]&&d++,a++;return 0<a?100*d/a:0}return 0},o.avgPreg=function(c){if(null!=o.alumState){var a=0,d=0;for(var e in o.alumState)null!=o.alumState[e]&&null!=o.alumState[e][c]&&(o.alumState[e][c]&&d++,a++);return 0<a?100*d/a:0}return 0},o.avgAll=function(){var a=0,b=0;if(null!=o.alumState)for(var c in o.alumState)for(var g in o.alumState[c])o.alumState[c][g]&&b++,a++;return 0<a?100*b/a:0},o.progress=function(){var b=0;if(null!=o.alumState){for(var d in o.alumState)for(var e in o.alumState[d])b++;return 100*b/(Object.keys(o.alumState).length*o.questions.length)}return 0},o.progressAlum=function(c){var a=0;if(null!=o.alumState&&null!=o.alumState[c]){for(var d in o.alumState[c])a++;return 100*a/o.questions.length}return 0},o.progressPreg=function(c){var a=0;if(null!=o.alumState){for(var d in o.alumState)null!=o.alumState[d][c]&&a++;return 100*a/Object.keys(o.alumState).length}return 0},o.lectPerformance=function(){var a=0,b=0;if(null!=o.alumState){for(var d in o.alumState){var g=o.alumState[d];a++,b+=g.score}return 100*b/a}return 0},o.DFAll=function(a,c){return a.filter(function(a){return a.orden==c}).map(function(a){return a.sel})},o.DFL=function(a,c){return a.filter(function(a){return a.orden==c}).length},o.DFAvg=function(b,c){var d=b.filter(function(a){return a.orden==c}).map(function(a){return a.sel});return 0<d.length?d.reduce(function(b,c){return b+c},0)/d.length:0},o.DFMinMax=function(e,a){var b=e.filter(function(b){return b.orden==a}).map(function(a){return a.sel});b.sort();var c=b.length-1;return b[c]-b[0]},o.DFColor=function(a,f){var g=o.DFAvg(a,f),c=0,b=a.filter(function(a){return a.orden==f}).map(function(a){return a.sel});b.forEach(function(a){c+=(a-g)*(a-g)});var h=Math.sqrt(c/b.length);return 1>=h?"bg-darkgreen":2.8<h?"bg-red":"bg-yellow"},o.getAlumDoneTime=function(a){k({url:"get-alum-done-time",method:"post",data:a}).success(function(a){o.numComplete=0,a.forEach(function(a){o.numComplete+=1,null==o.alumState[a.uid]?o.alumState[a.uid]=a:o.alumState[a.uid].dtime=~~a.dtime})})},o.buildBarData=function(b){o.barData[0].values=[];for(var c,d=0;5>d;d++)c=20*d+"% - "+20*(d+1)+"%",o.barData[0].values.push({label:c,value:0});b.forEach(function(b){var c=f(e(5*b.score),4);o.barData[0].values[c].value+=1}),o.barOpts.chart.xAxis.axisLabel=o.flang("performance")},o.updateStateRub=function(){5==o.iterationIndicator?o.computeDif():6==o.iterationIndicator&&o.getAllReportResult()},o.showName=function(a){return a.example?a.title+" - "+o.flang("exampleReport"):a.id+" - "+o.flang("reportOf")+" "+o.users[a.uid].name},o.shared.getReports=function(){var a={sesid:o.selectedSes.id};k({url:"get-report-list",method:"post",data:a}).success(function(a){o.reports=a,o.exampleReports=a.filter(function(a){return a.example})})},o.getReportResult=function(){var a={repid:o.selectedReport.id};k({url:"get-report-result",method:"post",data:a}).success(function(a){o.result=a,o.updateState()})},o.getAllReportResult=function(){var a={sesid:o.selectedSes.id};k({url:"get-report-result-all",method:"post",data:a}).success(function(b){o.resultAll={};var c=b.length;for(var d in o.users)"A"==o.users[d].role&&(o.resultAll[d]={reviews:0,data:[]});//console.log(self.resul);
b.forEach(function(d){if(null!=d&&0<d.length){var b=o.getReportAuthor(d[0].rid);-1!=b&&null==o.resultAll[b].data?o.resultAll[b].data=d:-1!=b&&(o.resultAll[b].data=d),d.forEach(function(a){o.resultAll[a.uid].reviews+=c})}}),o.pairArr=b[0]?Array(b[0].length):[],o.buildRubricaBarData(b)})},o.buildRubricaBarData=function(g){var a=["1 - 2","2 - 3","3 - 4"];//let rubnms = [self.flang("") + "-" + self.flang(""), "Proceso-Competente", "Competente-Avanzado"];
o.barData[0].values=[];for(var b,h=0;3>h;h++)b=h+1+" - "+(h+2)+" ("+a[h]+")",o.barData[0].values.push({label:b,value:0});g.forEach(function(c){var d=c.reduce(function(b,c){return b+c.val},0)/c.length,a=f(e(d-1),2);o.barData[0].values[a].value+=1}),o.barOpts.chart.xAxis.axisLabel=o.flang("scoreDist")},o.computeDif=function(){if(o.result){var f=o.result.findIndex(function(a){return"P"==o.users[a.uid].role});if(-1!=f){var e=o.result[f].val,b=[];o.result.forEach(function(c,d){d!=f&&b.push(Math.abs(e-c.val))}),o.buildRubricaDiffData(b)}}},o.buildRubricaDiffData=function(c){console.log("difs",c);var d=o.flang("high2lowScale").split(",");o.barData[0].values=[];for(var a=0;5>a;a++)// let lbl = (i * 0.5) + " - " + (i + 1) * 0.5;
o.barData[0].values.push({label:d[a],value:0});c.forEach(function(b){var c=f(e(2*b),4);o.barData[0].values[c].value+=1}),o.barOpts.chart.xAxis.axisLabel=o.flang("correctDistance")},o.getReportAuthor=function(b){if(o.reports){var c=o.reports.find(function(c){return c.id==b});return c?c.uid:-1}return-1},o.getAvg=function(b){if(null==b||0==b.length)return"";var c=b.reduce(function(b,c){return b+c.val},0);return c/b.length},o.getInMax=function(c){if(null==c)return[];var d=0;for(var f in c)d=b(d,c[f].data.length);return Array(d)},o.showReport=function(a){k({url:"get-report",method:"post",data:{rid:a}}).success(function(a){var d={report:a,criterios:o.shared.obtainCriterios()};d.report.author=o.users[a.uid];var e={repid:a.id};k({url:"get-report-result",method:"post",data:e}).success(function(a){d.answers=a,k.post("get-criteria-selection-by-report",e).success(function(a){d.answersRubrica={},a.forEach(function(a){null==d.answersRubrica[a.uid]&&(d.answersRubrica[a.uid]={}),d.answersRubrica[a.uid][a.cid]=a.selection}),k.post("get-report-evaluators",e).success(function(a){a.forEach(function(e){var b=d.answers.findIndex(function(a){return a.uid==e.uid});-1==b?d.answers.push({uid:e.uid,evaluatorName:o.users[e.uid].name}):d.answers[b].evaluatorName=o.users[e.uid].name}),l.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",size:"lg",scope:o,resolve:{data:function a(){return d}}})})})})})},o.showReportByUid=function(c){console.log(c);var b={uid:c,sesid:o.selectedSes.id};k({url:"get-report-uid",method:"post",data:b}).success(function(d){var a={report:d};a.report.author=o.users[c],l.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:o,resolve:{data:function b(){return a}}})})},o.broadcastReport=function(c){var a={sesid:o.selectedSes.id,rid:c};k({url:"set-eval-report",method:"post",data:a}).success(function(){m.success("Reporte enviado a alumnos")})},o.showDetailAnswer=function(c,g,e){var h=["A","B","C","D","E"],a={uid:g,qid:c,iteration:e},f=o.questions.reduce(function(d,b){return b.id==c?b:d},null);3>e?k({url:"get-selection-comment",method:"post",data:a}).success(function(d){if(null==d||null==d.answer)return void m.warning("No hay respuesta registrada para el alumno");var a=h[d.answer]+". "+f.options[d.answer],b=f.content;l.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:o,resolve:{data:function c(){return d.title=o.flang("answerOf")+" "+o.users[g].name,d.content=o.flang("question")+":\n"+b+"\n\n"+o.flang("answer")+":\n"+a+"\n\n"+o.flang("comment")+":\n"+(d.comment?d.comment:""),d.confidence&&(d.content+="\n\n"+o.flang("confidenceLevel")+": "+d.confidence+"%"),d}}})}):(a.tmid=o.leaderTeamId[g],k({url:"get-selection-team-comment",method:"post",data:a}).success(function(a){if(null==a||0==a.length)return void m.warning("No hay respuesta registrada para el grupo");var e=h[a[0].answer]+". "+f.options[a[0].answer],b=f.content;l.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:o,resolve:{data:function d(){var c={};return c.title=o.flang("answerOf")+" "+o.leaderTeamStr[g],c.content=o.flang("question")+":\n"+b+"\n\n"+o.flang("answer")+":\n"+e+"\n\n",a.forEach(function(b){c.content+=o.flang("comment")+" "+b.uname+":\n"+(null==b.comment?"":b.comment)+"\n",null!=b.confidence&&(c.content+=o.flang("confidenceLevel")+": "+b.confidence+"%\n"),c.content+="\n"}),c}}})}))},o.openDFDetails=function(a,d){var b={sesid:o.selectedSes.id,tmid:a,orden:d};k.post("get-team-chat",b).success(function(b){l.open({templateUrl:"templ/differential-group.html",controller:"EthicsModalController",controllerAs:"vm",scope:o,resolve:{data:function h(){var f={names:[o.flang("individual"),o.flang("anon"),o.flang("teamWork")],orden:d,group:a,users:o.users},c=o.dataDF.find(function(c){return c.tmid==a});// console.log(self.shared);
if(c.ind.some(function(a){return a.orden==d})){var e=c.ind.find(function(a){return a.orden==d});f.master=o.shared.dfs.filter(function(a){return a.id}).find(function(b){return b.id==e.did})}f.dfIters=[],f.dfIters.push(c.ind.filter(function(a){return a.orden==d})),f.dfIters.push(c.anon.filter(function(a){return a.orden==d})),f.dfIters.push(c.team.filter(function(a){return a.orden==d})),f.anonNames={},f.sesid=o.selectedSes.id;var g=0;return f.dfIters.flat().forEach(function(a){f.anonNames[a.uid]||(f.anonNames[a.uid]="ABCD"[g],g++)}),f.chat=b,f.chat.forEach(function(b){b.parent_id&&(b.parent=f.chat.find(function(c){return c.id==b.parent_id}))}),console.log(f),f}}})})},o.exportCSV=function(){console.log("Exporting CSV");var a={sesid:o.selectedSes.id};k.post("get-sel-data-csv",a).success(function(a){null!=a&&0<a.length&&saveCsv(a,{filename:"seleccion_"+o.selectedSes.id+".csv",formatter:function(a){return null==a?"":""+a}})}),k.post("get-chat-data-csv",a).success(function(a){null!=a&&0<a.length&&saveCsv(a,{filename:"chat_"+o.selectedSes.id+".csv",formatter:function(a){return null==a?"":""+a}})})}}),adpp.controller("MapSelectionModalController",function(c,d){var a=this;a.nav=!0,a.edit=!1,a.cancel=function(){d.dismiss("cancel")},a.resolve=function(){d.close({nav:a.nav,edit:a.edit})}}),adpp.controller("ReportModalController",function(e,a,b){var c=this;c.data=b,c.cancel=function(){a.dismiss("cancel")}}),adpp.controller("ContentModalController",function(e,a,b){var c=this;c.data=b,c.cancel=function(){a.dismiss("cancel")}}),adpp.controller("EthicsModalController",function(a,e,g,b,c){var h=this;h.data=c,h.isAnon=!0,h.cancel=function(){g.dismiss("cancel")},h.shareDetails=function(){if(!h.isAnon)return void b.error("S\xF3lo se pueden enviar diferenciales en forma an\xF3nima");var c=document.getElementById("details-modal").innerHTML.replace(/<\!--.*?-->/g,""),d={sesid:h.data.sesid,content:c};e({url:"broadcast-diff",method:"post",data:d}).success(function(){b.success("Diferencial enviado exitosamente")})}}),adpp.controller("DuplicateSesModalController",function(a,f,b,c){var d=this;d.data=c,d.nses={name:d.data.name,tipo:d.data.type,descr:d.data.descr,originalSesid:d.data.id,copyDocuments:!1,copyIdeas:!1,copyQuestions:!1,copyRubrica:!1,copyUsers:!1,copySemUnits:!1,copySemDocs:!1,copyDifferentials:!1},d.cancel=function(){b.dismiss("cancel")},d.sendDuplicate=function(){console.log(d.nses),f({url:"duplicate-session",method:"post",data:d.nses}).success(function(a){console.log(a),window.location.replace("admin")})}}),adpp.controller("GroupController",function(b,c,k){var f=b;f.methods=[],f.lastI=-1,f.lastJ=-1,f.groupMet="random",f.shared.verifyGroups=function(){f.methods=[d("random"),d("performance","homog"),d("performance","heterg"),d("knowledgeType","homog"),d("knowledgeType","heterg")],f.groupNum=3,f.groupMet=f.methods[0].key,f.groups=[],f.groupNames=[],null!=f.selectedSes&&f.selectedSes.grouped&&(f.groupNum=null,f.groupMet=null,f.generateGroups(!0))};var d=function(a,c){return{key:a+(null==c?"":" "+c),name:f.flang(a)+(null==c?"":" "+f.flang(c))}};f.generateGroups=function(g){if(f.selectedSes.grouped)return void c({url:"group-proposal-sel",method:"post",data:{sesid:f.selectedSes.id}}).success(function(b){f.groups=b,f.shared.groups=f.groups,console.log("G",b)});if(null==g&&(1>f.groupNum||f.groupNum>f.users.length))return void k.error("Error en los par\xE1metros de formaci\xF3n de grupos");var a={sesid:f.selectedSes.id,gnum:f.groupNum,method:f.groupMet};console.log(a),console.log(f.shared.alumState);var b=Object.values(f.users).filter(function(a){return"A"==a.role});if(console.log(b),"knowledgeType homog"==f.groupMet||"knowledgeType heterg"==f.groupMet)f.groups=generateTeams(b,habMetric,f.groupNum,isDifferent(f.groupMet));else if("random"==f.groupMet){var e=b.map(function(a){return a.rnd=Math.random(),a});f.groups=generateTeams(e,function(a){return a.rnd},f.groupNum,!1)}else if("S"==f.selectedSes.type||"M"==f.selectedSes.type){console.log(f.shared.alumState);var h=[];for(var d in f.shared.alumState){var j=0;for(var m in f.shared.alumState[d])j+=+m;h.push({uid:d,score:j})}f.groups=generateTeams(h,function(a){return a.score},f.groupNum,isDifferent(f.groupMet))}else if("L"==f.selectedSes.type)f.groups=generateTeams(f.shared.alumState,function(a){return a.score},f.groupNum,isDifferent(f.groupMet));else if("E"==f.selectedSes.type){console.log("AAAAA");var n=b.map(function(c){var d=f.shared.dataDF||[],a=d.find(function(a){return a.tmid==c.id});return console.log(a),{uid:c.id,score:a&&a.ind&&0<a.ind.length?a.ind.reduce(function(b,c){return b+c.sel},0)/a.ind.length:0}});console.log(n),f.groups=generateTeams(n,function(a){return a.score},f.groupNum,isDifferent(f.groupMet))}null!=f.groups&&(f.groupsProp=angular.copy(f.groups),f.groupNames=[])},f.acceptGroups=function(){if(null==f.groupsProp)return void k.error("No hay propuesta de grupos para fijar");var b={sesid:f.selectedSes.id,groups:JSON.stringify(f.groups.map(function(a){return a.map(function(a){return a.uid||a.id})}))};console.log(b),c({url:"set-groups",method:"post",data:b}).success(function(b){"ok"==b.status&&(console.log("Groups accepted"),f.selectedSes.grouped=!0,f.shared.verifyGroups())})},f.swapTable=function(d,a){if(console.log(d,a,f.groups),-1==f.lastI&&-1==f.lastJ)return f.lastI=d,void(f.lastJ=a);if(f.lastI!=d||f.lastJ!=a){var b=angular.copy(f.groupsProp[d][a]);f.groupsProp[d][a]=angular.copy(f.groupsProp[f.lastI][f.lastJ]),f.groupsProp[f.lastI][f.lastJ]=b}f.lastI=-1,f.lastJ=-1}}),adpp.controller("RubricaController",function(a,e){var f=a;f.criterios=[],f.newCriterio={},f.editable=!1,f.exampleReports=[],f.newExampleReport="",f.pairNum=3,f.rid=-1,f.addCriterio=function(){f.criterios.push({})},f.removeCriterio=function(a){f.criterios.splice(a,1)},f.checkSum=function(){return 100==f.criterios.reduce(function(b,c){return b+c.pond},0)},f.shared.getRubrica=function(){f.criterios=[],f.newCriterio={},f.editable=!1;var a={sesid:f.selectedSes.id};e({url:"get-admin-rubrica",method:"post",data:a}).success(function(a){0==a.length?f.editable=!0:(f.criterios=a,f.rid=a[0].rid)})},f.startEditing=function(){f.editable=!0},f.saveRubrica=function(){if(-1!=f.rid)return void f.saveEditRubrica();var a={sesid:f.selectedSes.id};e({url:"send-rubrica",method:"post",data:a}).success(function(b){if("ok"==b.status){var c=b.id;f.criterios.forEach(function(d){var b=angular.copy(d);b.rid=c,e({url:"send-criteria",method:"post",data:b}).success(function(a){"ok"==a.status&&console.log("Ok")})}),f.editable=!1}})},f.saveEditRubrica=function(){if(-1!=f.rid){var a={rid:f.rid};e({url:"delete-criterias",method:"post",data:a}).success(function(b){if("ok"==b.status){var c=f.rid;f.criterios.forEach(function(d){var b=angular.copy(d);b.rid=c,e({url:"send-criteria",method:"post",data:b}).success(function(a){"ok"==a.status&&console.log("Ok")})}),f.editable=!1}})}},f.shared.getExampleReports=function(){f.exampleReports=[];var a={sesid:f.selectedSes.id};e({url:"get-example-reports",method:"post",data:a}).success(function(a){f.exampleReports=a})},f.sendExampleReport=function(){var a={sesid:f.selectedSes.id,content:f.newExampleReport.text,title:f.newExampleReport.title};e({url:"send-example-report",method:"post",data:a}).success(function(){f.newExampleReport="",f.shared.getExampleReports()})},f.setActiveExampleReport=function(b){var c={sesid:f.selectedSes.id,rid:b.id};e({url:"set-active-example-report",method:"post",data:c}).success(function(a){"ok"==a.status&&(f.exampleReports.forEach(function(a){a.active=!1}),b.active=!0)})},f.goToReport=function(a){f.setActiveExampleReport(a),window.location.href="to-rubrica?sesid="+f.selectedSes.id},f.pairAssign=function(){var a={sesid:f.selectedSes.id,rnum:+f.pairNum||3};e({url:"assign-pairs",method:"post",data:a}).success(function(a){"ok"==a.status?(f.selectedSes.paired=f.pairNum,f.errPairMsg=""):f.errPairMsg=a.msg})},f.shared.obtainCriterios=function(){return f.criterios},f.shared.isRubricaSet=function(){return!f.editable}}),adpp.controller("OptionsController",function(e,a,b){var f=e;f.conf={},f.sesidConfig=-1,f.options=[{name:"optCom",code:"J"},{name:"optConfLv",code:"C"},{name:"optHint",code:"H"}],f.saveConfs=function(){var c={sesid:f.selectedSes.id,options:f.buildConfStr()};a.post("update-ses-options",c).success(function(d){"ok"==d.status&&(b.success("Opciones actualizadas"),f.selectedSes.options=c.options,f.selectedSes.conf=null,f.shared.updateConf())})},f.shared.saveConfs=f.saveConfs,f.shared.updateConf=function(){if(null==f.selectedSes.conf){f.selectedSes.conf={};for(var b=f.selectedSes.options||"",c=0;c<b.length;c++)f.selectedSes.conf[b[c]]=!0;console.log(f.selectedSes)}return!0},f.buildConfStr=function(){var a="";for(var b in f.selectedSes.conf)f.selectedSes.conf[b]&&(a+=b);return a}}),adpp.controller("DashboardRubricaController",function(b){var c=b;c.reports=[],c.result=[],c.selectedReport=null,c.shared.resetRubricaGraphs=function(){c.alumState=null,c.barOpts={chart:{type:"multiBarChart",height:320,x:function b(a){return a.label},y:function b(a){return a.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},c.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},c.shared.resetRubricaGraphs()}),adpp.controller("GeoAdminController",["$scope","$http","NgMap",function(i,j,k){var l=i;l.openRight=!1,l.rightTab="",l.mOverlays=[],l.sOverlays=[],l.selectedOverlay=null,l.overlayBuffer=[];var e=function(a){return{id:a.id,name:a.name,description:a.description,color:f(a),type:a.type,fullType:c(a.type),geom:JSON.parse(a.geom)}},f=function(){return"blue"},a=function(a){return{name:a.name,description:a.description,iteration:0,qid:null==l.questions[l.selectedQs]?-1:l.questions[l.selectedQs].id,type:a.type,geom:JSON.stringify(a.geom)}},c=function(a){return"M"===a?"marker":"P"===a?"polygon":"L"===a?"polyline":"R"===a?"rectangle":"C"===a?"circle":"I"===a?"image":void 0};l.shared.processPrevMapData=function(b,c){l.shared.closePrevMapData(),l.shared.processMapData(b,c),l.misc.mapHasVisData=!0,console.log(l.misc)},l.shared.processMapData=function(c,d){l.shared.closePrevMapData();var a=c.split(" ");console.log(a),l.map.setCenter(new google.maps.LatLng(+a[1],+a[2])),l.map.setZoom(+a[3]),l.misc.mapNav="NAV"==a[4],l.misc.mapEdit="EDIT"==a[4]||"EDIT"==a[5],g(d),google.maps.event.trigger(l.map,"resize"),l.misc.mapHasVisData=!1},l.shared.closePrevMapData=function(){l.shared.clearOverlayBuffer(),l.misc.mapHasVisData=!1};var g=function(b){j.post("list-default-overlay",{qid:b}).success(function(c){var a=c.map(e);l.mOverlays=l.mOverlays.concat(a.filter(function(a){return"M"==a.type})),l.sOverlays=l.sOverlays.concat(a.filter(function(a){return"M"!=a.type}))})};l.clearOverlay=function(){l.newOverlay={name:"",description:"",color:"blue",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},l.updateOverlayList=function(){var b={qid:null==l.questions[l.selectedQs]?-1:l.questions[l.selectedQs].id};j.post("list-overlay",b).success(function(c){var a=c.map(e);l.mOverlays=a.filter(function(a){return"M"==a.type}),l.sOverlays=a.filter(function(a){return"M"!=a.type})})},l.shared.updateOverlayList=l.updateOverlayList,l.onMapOverlayCompleted=function(a){l.map.mapDrawingManager[0].setDrawingMode(null),l.newOverlay.fullType=a.type,l.newOverlay.type="polyline"==a.type?"L":a.type[0].toUpperCase(),l.newOverlay.geom.position=a.overlay.getPosition?positionToArray(a.overlay.getPosition()):null,l.newOverlay.geom.radius=a.overlay.radius,l.newOverlay.geom.center=positionToArray(a.overlay.center),l.newOverlay.geom.path=a.overlay.getPath?mutiplePositionToArray(a.overlay.getPath()):null,l.newOverlay.geom.bounds=a.overlay.getBounds?boundsToArray(a.overlay.getBounds()):null,l.newOverlay.centroid=centroidAsLatLng(l.newOverlay.type,l.newOverlay.geom),l.map.showInfoWindow("iw2"),a.overlay.setMap(null)},l.colorizeShape=function(a){l.map.shapes&&l.map.shapes.nshp&&(l.map.shapes.nshp.set("fillColor",a),l.map.shapes.nshp.set("strokeColor","dark"+a))},l.closeOverlay=function(){l.clearOverlay(),l.map.infoWindows.iw2.close()};var b=function(){var a="M"==l.newOverlay.type?l.map.markers.nmkr:l.map.shapes.nshp;l.newOverlay.geom.position=a.getPosition?positionToArray(a.getPosition()):null,l.newOverlay.geom.radius=a.radius,l.newOverlay.geom.center=positionToArray(a.center),l.newOverlay.geom.path=a.getPath?mutiplePositionToArray(a.getPath()):null,l.newOverlay.geom.bounds=a.getBounds?boundsToArray(a.getBounds()):null,l.newOverlay.centroid=centroidAsLatLng(l.newOverlay.type,l.newOverlay.geom)};l.sendOverlay=function(){b(),l.overlayBuffer.push(a(l.newOverlay)),console.log(l.overlayBuffer),"M"==l.newOverlay.type?l.mOverlays.push(l.newOverlay):l.sOverlays.push(l.newOverlay),l.closeOverlay()},l.shared.clearOverlayBuffer=function(){l.mOverlays=[],l.sOverlays=[],l.overlayBuffer=[]},l.shared.sendOverlayBuffer=function(b){console.log(b,l.overlayBuffer),l.overlayBuffer.forEach(function(c){c.qid=b,j.post("add-overlay",c).success(function(){console.log("OK")})}),l.shared.closePrevMapData()},l.clickOverlay=function(){l.selectOverlay(this.id)},l.selectOverlay=function(b){l.selectedOverlay=l.mOverlays.find(function(c){return c.id==b})||l.sOverlays.find(function(c){return c.id==b}),l.selectedOverlay.centroid=centroidAsLatLng(l.selectedOverlay.type,l.selectedOverlay.geom),l.map.panTo(l.selectedOverlay.centroid),l.map.showInfoWindow("iw")},l.googleSearch=function(){var a=this.getPlace();null==a||null==a.geometry||null==a.geometry.location||(l.map.mapDrawingManager[0].setDrawingMode(null),l.newOverlay.fullType="marker",l.newOverlay.type="M",l.newOverlay.geom.position=positionToArray(a.geometry.location),l.newOverlay.centroid=centroidAsLatLng(l.newOverlay.type,l.newOverlay.geom),l.map.showInfoWindow("iw2"),l.map.panTo(a.geometry.location))},l.shared.getPluginMapOptions=function(){return{nav:l.misc.mapNav,edit:l.misc.mapEdit}},l.shared.getActiveMap=function(){return l.map},function(){l.updateOverlayList(),l.clearOverlay(),k.getMap().then(function(a){console.log("MAP cargado correctamente"),l.map=a,l.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),l.map.infoWindows.iw.close()}),l.misc.mapHasVisData=!1}()}]),adpp.filter("htmlExtractText",function(){return function(a){return a?(a+"").replace(/<[^>]+>/gm,""):""}}),adpp.filter("trustHtml",["$sce",function(b){return function(c){return b.trustAsHtml(c)}}]),adpp.filter("lang",function(){function a(a){if(null!=window.DIC)return window.DIC[a]?window.DIC[a]:(window.warnDIC[a]||(console.warn("Cannot find translation for ",a),window.warnDIC[a]=!0),a)}return a.$stateful=!0,a});var generateTeams=function(h,j,l,c,b){if(null==l||0==l)return[];console.log(h);var f=h;b?f.sort(j):f.sort(function(b,c){return j(c)-j(b)});for(var m=[],e=h.length/l,g=0;g<e;g++)c?function(){for(var d=[],a=f.length/l,b=0;b<l;b++)d.push(~~(Math.random()*a+a*b));m.push(f.filter(function(c,b){return d.includes(b)})),f=f.filter(function(c,b){return!d.includes(b)})}():(m.push(f.filter(function(b,c){return c<l})),f=f.filter(function(b,c){return c>=l}));for(var i=[],n=0,o=0;o<m.length;o++)1<m[o].length||0==i.length?i.push(m[o]):(i[n%i.length].push(m[o][0]),n++);return i},isDifferent=function(a){return"performance homog"!==a&&("performance heterg"===a||"knowledgeType homog"!==a&&"knowledgeType heterg"===a)},habMetric=function(a){switch(a.aprendizaje){case"Teorico":return-2;case"Reflexivo":return-1;case"Activo":return 1;case"Pragmatico":return 2;}return 0},quillMapHandler=function(){alert("Mapa s\xF3lo disponible para preguntas")},positionToArray=function(a){return null==a?null:[a.lat(),a.lng()]},mutiplePositionToArray=function(c){for(var a,e=[],f=0;f<c.getLength();f++)a=c.getAt(f),e.push(positionToArray(a));return e},boundsToArray=function(a){return[positionToArray(a.getSouthWest()),positionToArray(a.getNorthEast())]},avgCoord=function(c){for(var a=0,d=0,e=0;e<c.length;e++)a+=c[e][0],d+=c[e][1];return[a/c.length,d/c.length]},centroidAsLatLng=function(c,d){var a=centroid(c,d);return new google.maps.LatLng(a[0],a[1])},centroid=function(b,c){return"M"==b?c.position:"C"==b?c.center:"R"==b?avgCoord(c.bounds):"P"==b||"L"==b?avgCoord(c.path):null};
