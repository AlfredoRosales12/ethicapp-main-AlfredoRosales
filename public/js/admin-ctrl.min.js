"use strict";var app=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3"]);app.controller("AdminController",function(a,b,c){var g=a;g.shared={},g.sessions=[],g.selectedSes=null,g.documents=[],g.questions=[],g.newUsers=[],g.users={},g.selectedIndex=-1,g.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],g.init=function(){g.shared.updateSesData()},g.selectSession=function(h){g.selectedIndex=h,g.selectedSes=g.sessions[h],g.requestDocuments(),g.requestQuestions(),g.getNewUsers(),g.getMembers(),g.shared.verifyGroups(),g.shared.resetGraphs(),g.shared.verifyTabs(),g.shared.resetTab()},g.shared.updateSesData=function(){b({url:"get-session-list",method:"post"}).success(function(h){console.log("Session data updated"),g.sessions=h})},g.requestDocuments=function(){var h={sesid:g.selectedSes.id};b({url:"documents-session",method:"post",data:h}).success(function(j){g.documents=j})},g.requestQuestions=function(){var h={sesid:g.selectedSes.id};b({url:"questions-session",method:"post",data:h}).success(function(j){g.questions=j})},g.getNewUsers=function(){var h={sesid:g.selectedSes.id};b({url:"get-new-users",method:"post",data:h}).success(function(j){g.newUsers=j})},g.getMembers=function(){var h={sesid:g.selectedSes.id};b({url:"get-ses-users",method:"post",data:h}).success(function(j){j.forEach(function(k){g.users[k.id]=k})})},g.openNewSes=function(){c.open({templateUrl:"templ/new-ses.html"})},g.init()}),app.controller("TabsController",function(a){var c=a;c.tabOptions=["Editar","Usuarios","Dashboard","Grupos"],c.selectedTab=0,c.shared.resetTab=function(){c.selectedTab=0},c.shared.verifyTabs=function(){"L"==c.selectedSes.type?(c.tabOptions=["Editar","Usuarios","Dashboard","Grupos","R\xFAbrica"],c.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Reporte","Rubrica Ejemplo","Evaluaci\xF3n de Pares","Finalizada"],c.shared.getRubrica(),c.shared.getExampleReports()):(c.tabOptions=["Editar","Usuarios","Dashboard","Grupos"],c.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"])},c.setTab=function(g){c.selectedTab=g}}),app.controller("SesEditorController",function(a,b){var c=a;c.updateSession=function(){if(!(3>c.selectedSes.name.length||5>c.selectedSes.descr.length)){var g={name:c.selectedSes.name,descr:c.selectedSes.descr,id:c.selectedSes.id};b({url:"update-session",method:"post",data:g}).success(function(){console.log("Session updated")})}},c.changeState=function(){if(!(6<c.selectedSes.status)&&(!(3<=c.selectedSes.status)||c.selectedSes.grouped)){var g={sesid:c.selectedSes.id};b({url:"change-state-session",method:"post",data:g}).success(function(){window.location=window.location.href})}}}),app.controller("NewUsersController",function(a,b){var c=a;c.addToSession=function(){if(0!=c.newMembs.length){var h={users:c.newMembs.map(function(j){return j.id}),sesid:c.selectedSes.id};b({url:"add-ses-users",method:"post",data:h}).success(function(j){"ok"==j.status&&(c.getNewUsers(),c.getMembers())})}}}),app.controller("QuestionsController",function(a,b){var c=a;c.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",answer:-1},c.selectAnswer=function(g){c.newQuestion.answer=g},c.addQuestion=function(){if(-1!=c.newQuestion.answer){var g={content:c.newQuestion.content,options:c.newQuestion.alternatives.join("\n"),comment:c.newQuestion.comment,answer:c.newQuestion.answer,sesid:c.selectedSes.id,other:c.newQuestion.other};b({url:"add-question",method:"post",data:g}).success(function(h){"ok"==h.status&&c.requestQuestions()}),c.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",answer:-1}}}}),app.controller("DashboardController",function(a,b){var c=a;c.iterationIndicator=1,c.shared.resetGraphs=function(){c.alumState=null,c.barOpts={chart:{type:"multiBarChart",height:320,x:function x(g){return g.label},y:function y(g){return g.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},c.barData=[{key:"Alumnos",color:"#1f77b4",values:[]}]},c.updateState=function(){var g={sesid:c.selectedSes.id,iteration:c.iterationIndicator};"S"==c.selectedSes.type?(b({url:"get-alum-full-state-sel",method:"post",data:g}).success(function(h){c.alumState={},h.forEach(function(j){null==c.alumState[j.uid]?(c.alumState[j.uid]={},c.alumState[j.uid][j.qid]=j.correct):c.alumState[j.uid][j.qid]=j.correct})}),b({url:"get-alum-state-sel",method:"post",data:g}).success(function(h){var j=h.map(function(k){return k.score/=c.questions.length,k});c.buildBarData(j)})):"L"==c.selectedSes.type&&b({url:"get-alum-state-lect",method:"post",data:g}).success(function(h){c.alumState=h,c.buildBarData(h)})},c.buildBarData=function(g){var h=5;c.barData[0].values=[];for(var k,j=0;j<h;j++)k=20*j+"% - "+20*(j+1)+"%",c.barData[0].values.push({label:k,value:0});g.forEach(function(j){var k=Math.min(Math.floor(h*j.score),h-1);c.barData[0].values[k].value+=1})}}),app.controller("GroupController",function(a,b){var c=a;c.methods=["Aleatorio","Puntaje Homogeneo","Puntaje Heterogeneo","Habilidad Homogeneo","Habilidad Heterogeoneo"],c.shared.verifyGroups=function(){c.groupNum=3,c.groupMet=c.methods[0],c.groups=[],c.groupNames=[],null!=c.selectedSes&&c.selectedSes.grouped&&(c.groupNum=null,c.groupMet=null,c.generateGroups(!0))},c.generateGroups=function(g){if(!(null==g&&(1>c.groupNum||c.groupNum>c.users.length))){var h={sesid:c.selectedSes.id,gnum:c.groupNum,method:c.groupMet},j="";"S"==c.selectedSes.type?j="group-proposal-sel":"L"==c.selectedSes.type&&(j="group-proposal-lect"),"Habilidad Homogeneo"==c.groupMet||"Habilidad Heterogeoneo"==c.groupMet?j="group-proposal-hab":"Aleatorio"==c.groupMet&&(j="group-proposal-rand"),""!=j&&b({url:j,method:"post",data:h}).success(function(k){c.groups=k,console.log(k),c.groupNames=[],k.forEach(function(l){c.groupNames.push(l.map(function(m){return c.users[m.uid].name}).join(", "))})})}},c.acceptGroups=function(){if(null!=c.groups){var g={sesid:c.selectedSes.id,groups:c.groups.map(function(h){return h.map(function(j){return j.uid})})};console.log(g),b({url:"send-groups",method:"post",data:g}).success(function(h){"ok"==h.status&&(console.log("Groups accepted"),c.selectedSes.grouped=!0,c.shared.verifyGroups())})}}}),app.controller("RubricaController",function(a,b){var c=a;c.criterios=[],c.newCriterio={},c.editable=!1,c.exampleReports=[],c.newExampleReport="",c.addCriterio=function(){c.criterios.push(c.newCriterio),c.newCriterio={}},c.removeCriterio=function(g){c.criterios.splice(g,1)},c.checkSum=function(){return 100==c.criterios.reduce(function(g,h){return g+h.pond},0)},c.shared.getRubrica=function(){c.criterios=[],c.newCriterio={},c.editable=!1;var g={sesid:c.selectedSes.id};b({url:"get-rubrica",method:"post",data:g}).success(function(h){0==h.length?c.editable=!0:c.criterios=h})},c.saveRubrica=function(){var g={sesid:c.selectedSes.id};b({url:"send-rubrica",method:"post",data:g}).success(function(h){"ok"==h.status&&function(){var j=h.id;c.criterios.forEach(function(k){var l=angular.copy(k);l.rid=j,b({url:"send-criteria",method:"post",data:l}).success(function(m){"ok"==m.status&&console.log("Ok")})}),c.editable=!1}()})},c.shared.getExampleReports=function(){c.exampleReports=[];var g={sesid:c.selectedSes.id};b({url:"get-example-reports",method:"post",data:g}).success(function(h){c.exampleReports=h})},c.sendExampleReport=function(){var g={sesid:c.selectedSes.id,content:c.newExampleReport};b({url:"send-example-report",method:"post",data:g}).success(function(){c.newExampleReport="",c.shared.getExampleReports()})},c.setActiveExampleReport=function(g){var h={sesid:c.selectedSes.id,rid:g.id};b({url:"set-active-example-report",method:"post",data:h}).success(function(j){"ok"==j.status&&(c.exampleReports.forEach(function(k){k.active=!1}),g.active=!0)})}});
