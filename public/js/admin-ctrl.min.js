"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;adpp.controller("AdminController",function(b,g,h,l,m){var o=b;m.NUMBER_FORMATS.GROUP_SEP="",o.shared={},o.sessions=[],o.selectedSes=null,o.documents=[],o.questions=[],o.questionTexts=[],o.newUsers=[],o.users={},o.selectedIndex=-1,o.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],o.iterationNames=[],o.openSidebar=!0,o.init=function(){o.shared.updateSesData()},o.selectSession=function(q){o.selectedIndex=q,o.selectedSes=o.sessions[q],o.requestDocuments(),o.requestQuestions(),o.getNewUsers(),o.getMembers(),o.shared.verifyGroups(),o.shared.resetGraphs(),o.shared.verifyTabs(),o.shared.resetTab(),l.path(o.selectedSes.id)},o.shared.updateSesData=function(){g({url:"get-session-list",method:"post"}).success(function(q){console.log("Session data updated"),o.sessions=q,-1==o.selectedIndex?o.sesFromURL():o.selectSession(o.selectedIndex)})},o.sesFromURL=function(){var q=+l.path().substring(1),w=o.sessions.findIndex(function(x){return x.id==q});-1!=w&&o.selectSession(w)},o.requestDocuments=function(){var q={sesid:o.selectedSes.id};g({url:"documents-session",method:"post",data:q}).success(function(w){o.documents=w})},o.shared.updateDocuments=o.requestDocuments,o.deleteDocument=function(q){g({url:"delete-document",method:"post",data:{docid:q}}).success(function(){o.requestDocuments()})},o.requestQuestions=function(){var q={sesid:o.selectedSes.id};g({url:"questions-session",method:"post",data:q}).success(function(w){o.questions=w.map(function(x){return x.options=x.options.split("\n"),x})}),g({url:"get-question-text",method:"post",data:q}).success(function(w){o.questionTexts=w})},o.getNewUsers=function(){var q={sesid:o.selectedSes.id};g({url:"get-new-users",method:"post",data:q}).success(function(w){o.newUsers=w})},o.getMembers=function(){var q={sesid:o.selectedSes.id};g({url:"get-ses-users",method:"post",data:q}).success(function(w){o.usersArr=w,o.users={},w.forEach(function(x){o.users[x.id]=x})})},o.openNewSes=function(){h.open({templateUrl:"templ/new-ses.html"})},o.toggleSidebar=function(){o.openSidebar=!o.openSidebar,o.shared.updateState()},o.init()}),adpp.controller("TabsController",function(b){var h=b;h.tabOptions=["Descripci\xF3n","Dashboard"],h.tabConfig=["Usuarios","Grupos"],h.selectedTab=0,h.selectedTabConfig=-1,h.shared.resetTab=function(){h.selectedTab=0,null!=h.selectedSes&&1<h.selectedSes.status&&(h.selectedTab=1),h.selectedTabConfig=-1,7==h.selectedSes.status&&h.shared.gotoRubrica()},h.shared.verifyTabs=function(){"L"==h.selectedSes.type?(h.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Calibraci\xF3n Rubrica",val:5},{name:"Evaluaci\xF3n de Pares",val:6}],h.tabOptions=["Configuraci\xF3n","Dashboard"],h.tabConfig=["Usuarios","Grupos","R\xFAbrica"],h.sesStatusses=["Configuraci\xF3n","Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],h.shared.getRubrica(),h.shared.getExampleReports(),h.shared.getReports()):(h.iterationNames=[{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],h.tabOptions=["Configuraci\xF3n","Dashboard"],h.tabConfig=["Usuarios","Grupos"],h.sesStatusses=["Configuraci\xF3n","Individual","An\xF3nimo","Grupal","Finalizada"]),1<h.selectedSes.status&&(h.selectedTab=1)},h.setTab=function(l){h.selectedTab=l},h.setTabConfig=function(l){h.selectedTabConfig=l},h.shared.gotoGrupos=function(){h.selectedTab=0,h.selectedTabConfig=1},h.shared.gotoRubrica=function(){h.selectedTab=0,h.selectedTabConfig=2}}),adpp.controller("DocumentsController",function(b,g,h){var l=b;l.busy=!1,l.uploadDocument=function(m){l.busy=!0;var o=new FormData(m.target);g.post("upload-file",o,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(q){"ok"==q.status&&(h.success("Documento cargado correctamente"),m.target.reset(),l.busy=!1,l.shared.updateDocuments())})}}),adpp.controller("SesEditorController",function(b,g,h){var l=b;l.updateSession=function(){if(3>l.selectedSes.name.length||5>l.selectedSes.descr.length)return void h.error("Datos de la sesi\xF3n incorrectos o incompletos");var m={name:l.selectedSes.name,descr:l.selectedSes.descr,id:l.selectedSes.id};g({url:"update-session",method:"post",data:m}).success(function(){console.log("Session updated")})},l.shared.changeState=function(){if(l.selectedSes.status>=l.sesStatusses.length)return void h.error("La sesi\xF3n est\xE1 finalizada");if("L"==l.selectedSes.type&&3<=l.selectedSes.status&&!l.selectedSes.grouped||"S"==l.selectedSes.type&&2<=l.selectedSes.status&&!l.selectedSes.grouped)return l.shared.gotoGrupos(),void h.error("Los grupos no han sido generados");if(7<=l.selectedSes.status&&!l.selectedSes.paired)return l.shared.gotoRubrica(),void h.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var m=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(m){var o={sesid:l.selectedSes.id};g({url:"change-state-session",method:"post",data:o}).success(function(){l.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(b,g,h){var l=b;l.addToSession=function(){if(0==l.newMembs.length)return void h.error("No hay usuarios seleccionados para agregar");var o={users:l.newMembs.map(function(q){return q.id}),sesid:l.selectedSes.id};g({url:"add-ses-users",method:"post",data:o}).success(function(q){"ok"==q.status&&(l.getNewUsers(),l.getMembers())})},l.removeUser=function(o){if(1==l.selectedSes.status){var q={uid:o,sesid:l.selectedSes.id};g({url:"delete-ses-user",method:"post",data:q}).success(function(w){"ok"==w.status&&(l.getNewUsers(),l.getMembers())})}}}),adpp.controller("QuestionsController",function(b,g,h){var l=b;l.qsLabels=["A","B","C","D","E"],l.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},l.newText={title:"",content:""},l.selectAnswer=function(m){l.newQuestion.answer=m},l.addQuestion=function(){if(-1==l.newQuestion.answer)return void h.error("Debe indicar la respuesta correcta a la pregunta");var m={content:l.newQuestion.content,options:l.newQuestion.alternatives.join("\n"),comment:l.newQuestion.comment,answer:l.newQuestion.answer,sesid:l.selectedSes.id,textid:l.newQuestion.textid,other:l.newQuestion.other};g({url:"add-question",method:"post",data:m}).success(function(o){"ok"==o.status&&(l.requestQuestions(),h.success("Pregunta agrgada correctamente"),l.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1})})},l.addQuestionText=function(){var m={sesid:l.selectedSes.id,title:l.newText.title,content:l.newText.content};g({url:"add-question-text",method:"post",data:m}).success(function(o){"ok"==o.status&&(l.requestQuestions(),l.newText={title:"",content:""})})}}),adpp.controller("DashboardController",function(b,g,h,l,m){var o=b;o.iterationIndicator=1,o.currentTimer=null,o.shared.resetGraphs=function(){null!=o.selectedSes&&"L"==o.selectedSes.type?o.iterationIndicator=Math.max(Math.min(6,o.selectedSes.status-2),0):"S"==o.selectedSes.type&&(o.iterationIndicator=Math.max(Math.min(3,o.selectedSes.status-1),1)),o.alumState=null,o.barOpts={chart:{type:"multiBarChart",height:320,x:function x(q){return q.label},y:function y(q){return q.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},o.barData=[{key:"Alumnos",color:"#6d97bc",values:[]}],o.updateState(),9>o.selectedSes.status&&o.reload(!0)},o.reload=function(q){q||o.updateState(),null!=o.currentTimer&&h.cancel(o.currentTimer),o.currentTimer=h(o.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},o.updateState=function(){4>=o.iterationIndicator?o.updateStateIni():o.updateStateRub()},o.shared.updateState=o.updateState,o.updateStateIni=function(){o.alumTime={};var q={sesid:o.selectedSes.id,iteration:o.iterationIndicator};"S"==o.selectedSes.type?(g({url:"get-alum-full-state-sel",method:"post",data:q}).success(function(w){for(var x in o.alumState={},o.users)"A"==o.users[x].role&&(o.alumState[x]={});w.forEach(function(x){null==o.alumState[x.uid]?(o.alumState[x.uid]={},o.alumState[x.uid][x.qid]=x.correct):o.alumState[x.uid][x.qid]=x.correct}),3==o.iterationIndicator&&g({url:"get-original-leaders",method:"post",data:{sesid:o.selectedSes.id}}).success(function(x){var y=angular.copy(o.alumState);o.alumState={},o.leaderTeamStr={},x.forEach(function(z){o.alumState[z.leader]=y[z.leader],o.leaderTeamStr[z.leader]=z.team.map(function(A){return o.users[A].name}).join(", ")})})}),g({url:"get-alum-state-sel",method:"post",data:q}).success(function(w){var x=w.map(function(y){return y.score/=o.questions.length,y});o.buildBarData(x)})):"L"==o.selectedSes.type&&(g({url:"get-alum-state-lect",method:"post",data:q}).success(function(w){o.alumState=w,o.buildBarData(w),o.getAlumDoneTime(q)}),g({url:"get-ideas-progress",method:"post",data:q}).success(function(w){o.numProgress=0,o.numUsers=Object.keys(o.users).length-1;var x=3*o.documents.length;0!=x&&(w.forEach(function(y){o.numProgress+=y.count/x}),o.numProgress*=100/o.numUsers)}))},o.avgAlum=function(q){if(null!=o.alumState&&null!=o.alumState[q]){var w=0,x=0;for(var y in o.alumState[q])o.alumState[q][y]&&x++,w++;return 0<w?100*x/w:0}return 0},o.avgPreg=function(q){if(null!=o.alumState){var w=0,x=0;for(var y in o.alumState)null!=o.alumState[y][q]&&(o.alumState[y][q]&&x++,w++);return 0<w?100*x/w:0}return 0},o.avgAll=function(){var q=0,w=0;if(null!=o.alumState)for(var x in o.alumState)for(var y in o.alumState[x])o.alumState[x][y]&&w++,q++;return 0<q?100*w/q:0},o.progress=function(){var q=0;if(null!=o.alumState){for(var w in o.alumState)for(var x in o.alumState[w])q++;return 100*q/(Object.keys(o.alumState).length*o.questions.length)}return 0},o.progressAlum=function(q){var w=0;if(null!=o.alumState&&null!=o.alumState[q]){for(var x in o.alumState[q])w++;return 100*w/o.questions.length}return 0},o.progressPreg=function(q){var w=0;if(null!=o.alumState){for(var x in o.alumState)null!=o.alumState[x][q]&&w++;return 100*w/Object.keys(o.alumState).length}return 0},o.lectPerformance=function(){var q=0,w=0;if(null!=o.alumState){for(var y,x=0;x<o.alumState.length;x++)y=o.alumState[x],q++,w+=y.score;return 100*w/q}return 0},o.getAlumDoneTime=function(q){g({url:"get-alum-done-time",method:"post",data:q}).success(function(w){o.numComplete=0,w.forEach(function(x){o.numComplete+=1;var y=o.alumState.findIndex(function(z){return z.uid==x.uid});-1==y?o.alumState.push(x):o.alumState[y].dtime=~~x.dtime})})},o.buildBarData=function(q){var w=5;o.barData[0].values=[];for(var y,x=0;x<w;x++)y=20*x+"% - "+20*(x+1)+"%",o.barData[0].values.push({label:y,value:0});q.forEach(function(x){var y=Math.min(Math.floor(w*x.score),w-1);o.barData[0].values[y].value+=1}),o.barOpts.chart.xAxis.axisLabel="Rendimiento"},o.updateStateRub=function(){5==o.iterationIndicator?o.computeDif():6==o.iterationIndicator&&o.getAllReportResult()},o.showName=function(q){return q.example?q.title+" - Texto ejemplo":q.id+" - Reporte de Alumno "+o.users[q.uid].name},o.shared.getReports=function(){var q={sesid:o.selectedSes.id};g({url:"get-report-list",method:"post",data:q}).success(function(w){o.reports=w,o.exampleReports=w.filter(function(x){return x.example})})},o.getReportResult=function(){var q={repid:o.selectedReport.id};g({url:"get-report-result",method:"post",data:q}).success(function(w){o.result=w,o.updateState()})},o.getAllReportResult=function(){var q={sesid:o.selectedSes.id};g({url:"get-report-result-all",method:"post",data:q}).success(function(w){o.resultAll=w,o.pairArr=w[0]?Array(w[0].length):[],console.log(w),o.buildRubricaBarData(w)})},o.buildRubricaBarData=function(q){var w=3,x=["Inicio-Proceso","Proceso-Competente","Competente-Avanzado"];o.barData[0].values=[];for(var z,y=0;y<w;y++)z=y+1+" - "+(y+2)+" ("+x[y]+")",o.barData[0].values.push({label:z,value:0});q.forEach(function(y){var z=y.reduce(function(B,C){return B+C.val},0)/y.length,A=Math.min(Math.floor(z-1),w-1);o.barData[0].values[A].value+=1}),o.barOpts.chart.xAxis.axisLabel="Distribuci\xF3n de Puntaje (Nivel)"},o.computeDif=function(){o.result&&function(){var q=o.result.findIndex(function(w){return"P"==o.users[w.uid].role});-1!=q&&function(){var w=o.result[q].val,x=[];o.result.forEach(function(y,z){z!=q&&x.push(Math.abs(w-y.val))}),o.buildRubricaDiffData(x)}()}()},o.buildRubricaDiffData=function(q){console.log("difs",q);var w=5,x=["Alto","Medio Alto","Medio","Medio Bajo","Bajo"];o.barData[0].values=[];for(var y=0;y<w;y++)o.barData[0].values.push({label:x[y],value:0});q.forEach(function(y){var z=Math.min(Math.floor(2*y),w-1);o.barData[0].values[z].value+=1}),o.barOpts.chart.xAxis.axisLabel="Cercan\xEDa a evaluaci\xF3n correcta"},o.getReportAuthor=function(q){if(o.reports){var w=o.reports.find(function(x){return x.id==q});if(w)return o.users[w.uid]?o.users[w.uid].name:null}},o.getAvg=function(q){if(null==q||0==q.length)return"";var w=q.reduce(function(x,y){return x+y.val},0);return w/q.length},o.getInMax=function(q){if(null==q||0==q.length)return[];var w=q.reduce(function(x,y){return Math.max(x,y.length)},0);return Array(w)},o.showReport=function(q){g({url:"get-report",method:"post",data:{rid:q}}).success(function(x){l.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:o,resolve:{report:function report(){return x.author=o.users[x.uid],x}}})})},o.broadcastReport=function(q){var w={sesid:o.selectedSes.id,rid:q};g({url:"set-eval-report",method:"post",data:w}).success(function(){m.success("Reporte enviado a alumnos")})},o.showDetailAnswer=function(q,w,x){var y=["A","B","C","D","E"];g({url:"get-selection-comment",method:"post",data:{uid:w,qid:q,iteration:x}}).success(function(A){var B=o.questions.reduce(function(E,F){return F.id==q?F:E},null);console.log(B);var C=y[A.answer]+". "+B.options[A.answer],D=B.content;l.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:o,resolve:{data:function data(){return A.title="Respuesta de "+o.users[w].name,A.content=D+"\n\nAlternativa: "+C+"\n\nComentario:\n"+A.comment,A}}})})}}),adpp.controller("ReportModalController",function(b,g,h){var l=this;l.report=h,l.cancel=function(){g.dismiss("cancel")}}),adpp.controller("ContentModalController",function(b,g,h){var l=this;l.data=h,l.cancel=function(){g.dismiss("cancel")}}),adpp.controller("GroupController",function(b,g,h){var l=b;l.methods=["Aleatorio","Rendimiento Homogeneo","Rendimiento Heterogeneo","Tipo Aprendizaje Homogeneo","Tipo Aprendizaje Heterogeoneo"],l.lastI=-1,l.lastJ=-1,l.shared.verifyGroups=function(){l.groupNum=3,l.groupMet=l.methods[0],l.groups=[],l.groupNames=[],null!=l.selectedSes&&l.selectedSes.grouped&&(l.groupNum=null,l.groupMet=null,l.generateGroups(!0))},l.generateGroups=function(m){if(null==m&&(1>l.groupNum||l.groupNum>l.users.length))return void h.error("Error en los par\xE1metros de formaci\xF3n de grupos");var o={sesid:l.selectedSes.id,gnum:l.groupNum,method:l.groupMet},q="";"S"==l.selectedSes.type?q="group-proposal-sel":"L"==l.selectedSes.type&&(q="group-proposal-lect"),"Tipo Aprendizaje Homogeneo"==l.groupMet||"Tipo Aprendizaje Heterogeoneo"==l.groupMet?q="group-proposal-hab":"Aleatorio"==l.groupMet&&(q="group-proposal-rand"),""!=q&&g({url:q,method:"post",data:o}).success(function(w){l.groups=w,l.groupsProp=angular.copy(l.groups),console.log(w),l.groupNames=[]})},l.acceptGroups=function(){if(null==l.groupsProp)return void h.error("No hay propuesta de grupos para fijar");var m={sesid:l.selectedSes.id,groups:JSON.stringify(l.groupsProp.map(function(o){return o.map(function(q){return q.uid})}))};console.log(m),g({url:"set-groups",method:"post",data:m}).success(function(o){"ok"==o.status&&(console.log("Groups accepted"),l.selectedSes.grouped=!0,l.shared.verifyGroups())})},l.swapTable=function(m,o){if(console.log(m,o,l.groups),-1==l.lastI&&-1==l.lastJ)return l.lastI=m,void(l.lastJ=o);if(l.lastI!=m||l.lastJ!=o){var q=angular.copy(l.groupsProp[m][o]);l.groupsProp[m][o]=angular.copy(l.groupsProp[l.lastI][l.lastJ]),l.groupsProp[l.lastI][l.lastJ]=q}l.lastI=-1,l.lastJ=-1}}),adpp.controller("RubricaController",function(b,g){var h=b;h.criterios=[],h.newCriterio={},h.editable=!1,h.exampleReports=[],h.newExampleReport="",h.addCriterio=function(){h.criterios.push(h.newCriterio),h.newCriterio={}},h.removeCriterio=function(l){h.criterios.splice(l,1)},h.checkSum=function(){return 100==h.criterios.reduce(function(l,m){return l+m.pond},0)},h.shared.getRubrica=function(){h.criterios=[],h.newCriterio={},h.editable=!1;var l={sesid:h.selectedSes.id};g({url:"get-admin-rubrica",method:"post",data:l}).success(function(m){0==m.length?h.editable=!0:h.criterios=m})},h.saveRubrica=function(){var l={sesid:h.selectedSes.id};g({url:"send-rubrica",method:"post",data:l}).success(function(m){"ok"==m.status&&function(){var o=m.id;h.criterios.forEach(function(q){var w=angular.copy(q);w.rid=o,g({url:"send-criteria",method:"post",data:w}).success(function(x){"ok"==x.status&&console.log("Ok")})}),h.editable=!1}()})},h.shared.getExampleReports=function(){h.exampleReports=[];var l={sesid:h.selectedSes.id};g({url:"get-example-reports",method:"post",data:l}).success(function(m){h.exampleReports=m})},h.sendExampleReport=function(){var l={sesid:h.selectedSes.id,content:h.newExampleReport.text,title:h.newExampleReport.title};g({url:"send-example-report",method:"post",data:l}).success(function(){h.newExampleReport="",h.shared.getExampleReports()})},h.setActiveExampleReport=function(l){var m={sesid:h.selectedSes.id,rid:l.id};g({url:"set-active-example-report",method:"post",data:m}).success(function(o){"ok"==o.status&&(h.exampleReports.forEach(function(q){q.active=!1}),l.active=!0)})},h.goToReport=function(l){h.setActiveExampleReport(l),window.location.href="to-rubrica?sesid="+h.selectedSes.id},h.pairAssign=function(){var l={sesid:h.selectedSes.id,rnum:2};g({url:"assign-pairs",method:"post",data:l}).success(function(m){"ok"==m.status?(h.selectedSes.paired=!0,h.errPairMsg=""):h.errPairMsg=m.msg})}}),adpp.controller("DashboardRubricaController",function(b){var h=b;h.reports=[],h.result=[],h.selectedReport=null,h.shared.resetRubricaGraphs=function(){h.alumState=null,h.barOpts={chart:{type:"multiBarChart",height:320,x:function x(l){return l.label},y:function y(l){return l.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},h.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},h.shared.resetRubricaGraphs()});
