"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification","ngQuill","ngMap"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;window.DIC=null,window.warnDIC={},adpp.config(["ngQuillConfigProvider",function(o){o.set({modules:{formula:!0,toolbar:{container:[["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{size:["small",!1,"large","huge"]}],["clean"],["image","link","video"],["formula"]],handlers:{map:quillMapHandler}}}})}]),adpp.controller("AdminController",function(o,l,m,g,h,S){var y=o;y.temp="",h.NUMBER_FORMATS.GROUP_SEP="",y.shared={},y.sessions=[],y.selectedSes=null,y.documents=[],y.questions=[],y.questionTexts=[],y.newUsers=[],y.users={},y.selectedId=-1,y.sesStatusses=["notPublicada","reading","personal","anon","teamWork","finished"],y.optConfidence=[0,25,50,75,100],y.iterationNames=[],y.showSeslist=!0,y.lang="english",y.secIcons={configuration:"cog",editor:"edit",dashboard:"bar-chart",users:"male",rubrica:"check-square",groups:"users",options:"sliders"},y.typeNames={L:"readComp",S:"multSel",M:"semUnits"},y.misc={},y.init=function(){y.shared.updateSesData(),y.updateLang(y.lang)},y.selectSession=function(w,D){y.selectedId=D,y.selectedSes=w,y.requestDocuments(),y.requestSemDocuments(),y.requestQuestions(),y.getNewUsers(),y.getMembers(),y.shared.verifyGroups(),y.shared.resetGraphs(),y.shared.verifyTabs(),y.shared.resetTab(),y.shared.updateConf(),g.path(y.selectedSes.id)},y.shared.updateSesData=function(){l({url:"get-session-list",method:"post"}).success(function(w){if(console.log("Session data updated"),y.sessions=w,-1!=y.selectedId){var D=y.sessions.find(function(x){return x.id==y.selectedId});null!=D&&y.selectSession(D,y.selectedId)}else y.sesFromURL()})},y.sesFromURL=function(){var w=+g.path().substring(1),D=y.sessions.find(function(x){return x.id==w});null!=D&&y.selectSession(D,w)},y.requestDocuments=function(){var w={sesid:y.selectedSes.id};l({url:"documents-session",method:"post",data:w}).success(function(D){y.documents=D})},y.shared.updateDocuments=y.requestDocuments,y.deleteDocument=function(w){l({url:"delete-document",method:"post",data:{docid:w}}).success(function(){y.requestDocuments()})},y.requestQuestions=function(){var w={sesid:y.selectedSes.id};l({url:"questions-session",method:"post",data:w}).success(function(D){y.questions=D.map(function(x){return x.options=x.options.split("\n"),x})}),l({url:"get-question-text",method:"post",data:w}).success(function(D){y.questionTexts=D})},y.requestSemDocuments=function(){var w={sesid:y.selectedSes.id};l({url:"semantic-documents",method:"post",data:w}).success(function(D){y.semDocs=D})},y.getNewUsers=function(){var w={sesid:y.selectedSes.id};l({url:"get-new-users",method:"post",data:w}).success(function(D){y.newUsers=D})},y.getMembers=function(){var w={sesid:y.selectedSes.id};l({url:"get-ses-users",method:"post",data:w}).success(function(D){y.usersArr=D,y.users={},D.forEach(function(x){y.users[x.id]=x})})},y.openNewSes=function(){m.open({templateUrl:"templ/new-ses.html"})},y.openDuplicateSes=function(){if(null!=y.selectedSes){var w=angular.copy(y.selectedSes);m.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:y,resolve:{data:function data(){return w}}})}},y.openDuplicateSesSpec=function(w,D){D.stopPropagation();var x=angular.copy(w);m.open({templateUrl:"templ/duplicate-ses.html",controller:"DuplicateSesModalController",controllerAs:"vm",scope:y,resolve:{data:function data(){return x}}})},y.toggleSidebar=function(){y.openSidebar=!y.openSidebar,y.shared.updateState()},y.updateLang=function(w){l.get("data/"+w+".json").success(function(D){window.DIC=D})},y.shared.resetSesId=function(){y.selectedId=-1},y.changeLang=function(){y.lang="english"==y.lang?"spanish":"english",y.updateLang(y.lang)},y.generateCode=function(){var w={id:y.selectedSes.id};l.post("generate-session-code",w).success(function(D){null!=D.code&&(y.selectedSes.code=D.code)})},y.flang=function(w){return S("lang")(w)},y.init()}),adpp.controller("TabsController",function(o){var m=o;m.tabOptions=[],m.tabConfig=["users","groups"],m.selectedTab="",m.shared.resetTab=function(){m.selectedTab="editor",null!=m.selectedSes&&1<m.selectedSes.status&&(m.selectedTab="dashboard"),m.selectedTabConfig=-1,7==m.selectedSes.status&&m.shared.gotoRubrica()},m.shared.verifyTabs=function(){"L"==m.selectedSes.type?(m.iterationNames=[{name:"reading",val:0},{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3},{name:"report",val:4},{name:"rubricCalib",val:5},{name:"pairEval",val:6}],m.tabOptions=["editor","users","groups","rubrica","dashboard"],m.sesStatusses=["configuration","reading","individual","anon","teamWork","report","rubricCalib","pairEval","finished"],m.shared.getRubrica(),m.shared.getExampleReports(),m.shared.getReports()):"S"==m.selectedSes.type?(m.iterationNames=[{name:"individual",val:1},{name:"anon",val:2},{name:"teamWork",val:3}],m.tabOptions=["editor","users","groups","dashboard"],m.sesStatusses=["configuration","individual","anon","teamWork","finished"]):"M"==m.selectedSes.type&&(m.iterationNames=[{name:"individual",val:1},{name:"teamWork",val:3},{name:"report",val:4},{name:"pairEval",val:6}],m.tabOptions=["editor","users","groups","rubrica","dashboard"],m.sesStatusses=[{i:-1,name:"configuration"},{i:1,name:"individual"},{i:3,name:"teamWork"},{i:4,name:"report"},{i:6,name:"pairEval"},{i:7,name:"finished"}],m.shared.getRubrica(),m.shared.getExampleReports(),m.shared.getReports()),1<m.selectedSes.status&&(m.selectedTab="dashboard")},m.setTab=function(g){m.selectedTab=g},m.setTabConfig=function(g){m.selectedTabConfig=g},m.backToList=function(){m.shared.resetSesId(),m.tabOptions=[],m.selectedTab=""},m.shared.gotoGrupos=function(){m.selectedTab="groups"},m.shared.gotoRubrica=function(){m.selectedTab="rubrica"}}),adpp.controller("DocumentsController",function(o,l,m,g){var h=o;h.busy=!1,h.uploadDocument=function(S){h.busy=!0;var y=new FormData(S.target);l.post("upload-file",y,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(w){"ok"==w.status&&g(function(){m.success("Documento cargado correctamente"),S.target.reset(),h.busy=!1,h.shared.updateDocuments()},2e3)})}}),adpp.controller("SesEditorController",function(o,l,m){var g=o;g.mTransition={1:3,3:5,5:6,6:8,8:9},g.splitDescr=!1,g.splDes1="",g.splDes2="",g.toggleSplit=function(){g.splitDescr=!g.splitDescr,g.splitDescr?(g.splDes1=g.selectedSes.descr.split("\n")[0],g.splDes2=g.selectedSes.descr.split("\n")[1]||""):g.selectedSes.descr=g.splDes1+"\n"+g.splDes2},g.updateSession=function(){if(g.splitDescr&&(g.selectedSes.descr=g.splDes1+"\n"+g.splDes2),3>g.selectedSes.name.length||5>g.selectedSes.descr.length)return void m.error("Datos de la sesi\xF3n incorrectos o incompletos");var h={name:g.selectedSes.name,descr:g.selectedSes.descr,id:g.selectedSes.id};l({url:"update-session",method:"post",data:h}).success(function(){console.log("Session updated")})},g.shared.changeState=function(){if("M"!=g.selectedSes.type&&g.selectedSes.status>=g.sesStatusses.length)return void m.error("La sesi\xF3n est\xE1 finalizada");if("M"==g.selectedSes.type&&9<=g.selectedSes.status)return void m.error("La sesi\xF3n est\xE1 finalizada");if("L"==g.selectedSes.type&&3<=g.selectedSes.status&&!g.selectedSes.grouped||"M"==g.selectedSes.type&&3<=g.selectedSes.status&&!g.selectedSes.grouped||"S"==g.selectedSes.type&&2<=g.selectedSes.status&&!g.selectedSes.grouped)return g.shared.gotoGrupos(),void m.error("Los grupos no han sido generados");if("L"==g.selectedSes.type&&6<=g.selectedSes.status&&g.shared.isRubricaSet&&!g.shared.isRubricaSet()||"M"==g.selectedSes.type&&5<=g.selectedSes.status&&g.shared.isRubricaSet&&!g.shared.isRubricaSet())return g.shared.gotoRubrica(),void m.error("La r\xFAbrica no ha sido asignada");if("L"==g.selectedSes.type&&7<=g.selectedSes.status&&!g.selectedSes.paired||"M"==g.selectedSes.type&&6<=g.selectedSes.status&&!g.selectedSes.paired)return g.shared.gotoRubrica(),void m.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var h=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(h)if("M"==g.selectedSes.type){var S={sesid:g.selectedSes.id,state:g.mTransition[g.selectedSes.status]||g.selectedSes.status};l({url:"force-state-session",method:"post",data:S}).success(function(){g.shared.updateSesData()})}else{1==g.selectedSes.status&&(g.updateSession(),"S"==g.selectedSes.type&&g.shared.saveConfs());var S={sesid:g.selectedSes.id};l({url:"change-state-session",method:"post",data:S}).success(function(){g.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(o,l,m){var g=o;g.addToSession=function(){if(0==g.newMembs.length)return void m.error("No hay usuarios seleccionados para agregar");var S={users:g.newMembs.map(function(y){return y.id}),sesid:g.selectedSes.id};l({url:"add-ses-users",method:"post",data:S}).success(function(y){"ok"==y.status&&g.refreshUsers()})},g.removeUser=function(S){if(2>=g.selectedSes.status){var y={uid:S,sesid:g.selectedSes.id};l({url:"delete-ses-user",method:"post",data:y}).success(function(w){"ok"==w.status&&g.refreshUsers()})}},g.refreshUsers=function(){g.getNewUsers(),g.getMembers()}}),adpp.controller("SemDocController",function(o,l,m){var g=o;g.newSDoc={id:null,title:"",content:""},g.addSemDoc=function(){var h={sesid:g.selectedSes.id,title:g.newSDoc.title,content:g.newSDoc.content};l({url:"add-semantic-document",method:"post",data:h}).success(function(S){"ok"==S.status&&(g.requestSemDocuments(),m.success("Texto agregado correctamente"),g.newSDoc={id:null,title:"",content:""})})},g.deleteText=function(h){l.post("delete-semantic-document",{id:h}).success(function(y){"ok"==y.status&&(g.requestSemDocuments(),m.success("Texto eliminado correctamente"))})},g.startEditText=function(h){g.newSDoc={id:h.id,title:h.title,content:h.content},m.info("Edite el texto en el formulario")},g.updateSemDoc=function(){if(null==g.newSDoc.id)return void m.error("No hay texto a editar.");var h={id:g.newSDoc.id,sesid:g.selectedSes.id,title:g.newSDoc.title,content:g.newSDoc.content};l({url:"update-semantic-document",method:"post",data:h}).success(function(S){"ok"==S.status&&(g.requestSemDocuments(),m.success("Texto editado correctamente."),g.newSDoc={id:null,title:"",content:""})})}}),adpp.controller("QuestionsController",function(o,l,m,g,h,S){var y=o;y.qsLabels=["A","B","C","D","E"],y.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},y.newText={id:null,title:"",content:""},y.selectAnswer=function(x){y.newQuestion.answer=x},y.addQuestion=function(){if(-1==y.newQuestion.answer)return void m.error("Debe indicar la respuesta correcta a la pregunta");y.newQuestion.includesMap&&D();var x={content:y.newQuestion.content,options:y.newQuestion.alternatives.join("\n"),comment:y.newQuestion.comment,answer:y.newQuestion.answer,sesid:y.selectedSes.id,textid:y.newQuestion.textid,other:y.newQuestion.other,pluginData:y.newQuestion.pluginData};l({url:"add-question",method:"post",data:x}).success(function(O){"ok"==O.status&&(y.requestQuestions(),m.success("Pregunta agrgada correctamente"),y.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},y.shared.sendOverlayBuffer&&y.shared.sendOverlayBuffer(O.id))})},y.updateQuestion=function(){if(null==y.newQuestion.id)return void m.error("No hay pregunta para editar");if(-1==y.newQuestion.answer)return void m.error("Debe indicar la respuesta correcta a la pregunta");y.newQuestion.includesMap&&D();var x={id:y.newQuestion.id,content:y.newQuestion.content,options:y.newQuestion.alternatives.join("\n"),comment:y.newQuestion.comment,answer:y.newQuestion.answer,sesid:y.selectedSes.id,textid:y.newQuestion.textid,other:y.newQuestion.other,pluginData:y.newQuestion.pluginData};l({url:"update-question",method:"post",data:x}).success(function(O){"ok"==O.status&&(y.requestQuestions(),m.success("Pregunta editada correctamente"),y.newQuestion={id:null,content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},y.shared.sendOverlayBuffer&&y.shared.sendOverlayBuffer(x.id))})},y.startEditQuestion=function(x){y.newQuestion={id:x.id,content:x.content,alternatives:x.options,comment:x.comment,other:x.other,textid:x.textid,answer:x.answer,includesMap:x.plugin_data&&x.plugin_data.startsWith("MAP")},m.info("Edite la pregunta en el formulario."),y.newQuestion.includesMap&&(y.shared.clearOverlayBuffer&&y.shared.clearOverlayBuffer(),y.shared.processMapData(x.plugin_data,x.id),w())},y.startEditText=function(x){y.newText={id:x.id,title:x.title,content:x.content},m.info("Edite el texto en el formulario.")},y.addQuestionText=function(){var x={sesid:y.selectedSes.id,title:y.newText.title,content:y.newText.content};l({url:"add-question-text",method:"post",data:x}).success(function(O){"ok"==O.status&&(y.requestQuestions(),y.newText={id:null,title:"",content:""})})},y.updateQuestionText=function(){if(null==y.newText.id)return void m.error("No hay texto para editar");var x={id:y.newText.id,sesid:y.selectedSes.id,title:y.newText.title,content:y.newText.content};l({url:"update-question-text",method:"post",data:x}).success(function(O){"ok"==O.status&&(y.requestQuestions(),y.newText={title:"",content:""})})},y.deleteQuestion=function(x){l.post("delete-question",{id:x}).success(function(){y.requestQuestions(),m.success("Pregunta eliminada correctamente")})},y.deleteQuestionText=function(x){l.post("delete-question-text",{id:x}).success(function(){y.requestQuestions(),m.success("Texto eliminado correctamente")})},y.configQuillExtra=function(x){y.editor=x},y.toggleMapPlugin=function(){y.newQuestion.includesMap=!y.newQuestion.includesMap,y.newQuestion.includesMap&&w()},y.expandQuestion=function(x){x.expanded?(x.expanded=!1,y.shared.closePrevMapData()):(y.questions.forEach(function(O){return O.expanded=!1}),x.expanded=!0,x.plugin_data&&x.plugin_data.startsWith("MAP")&&y.shared.processPrevMapData(x.plugin_data,x.id))};var w=function futureRefreshMap(){S(function(){var x=y.shared.getActiveMap();google.maps.event.trigger(x,"resize")},1e3)},D=function encodeMapPlugin(){var x=y.shared.getPluginMapOptions(),O=y.shared.getActiveMap();if(null==O)return void m.error("Ocurrio un error al cargar los datos del mapa, intente nuevamente.");var M=O.getCenter().lat(),C=O.getCenter().lng(),T=O.getZoom();y.newQuestion.pluginData="MAP "+M+" "+C+" "+T+(x.nav?" NAV":"")+(x.edit?" EDIT":"")}}),adpp.controller("DashboardController",function(o,l,m,g,h){var S=o;S.iterationIndicator=1,S.currentTimer=null,S.showCf=!1,S.shared.resetGraphs=function(){null!=S.selectedSes&&"L"==S.selectedSes.type?S.iterationIndicator=Math.max(Math.min(6,S.selectedSes.status-2),0):"S"==S.selectedSes.type?S.iterationIndicator=Math.max(Math.min(3,S.selectedSes.status-1),1):"M"==S.selectedSes.type&&(S.iterationIndicator=Math.max(Math.min(6,S.selectedSes.status-2),0)),S.alumState=null,S.barOpts={chart:{type:"multiBarChart",height:320,x:function x(y){return y.label},y:function(y){return y.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:S.flang("students")}}},S.barData=[{key:S.flang("students"),color:"#4d6b87",values:[]}],S.updateState(),9>S.selectedSes.status&&S.reload(!0)},S.reload=function(y){y||S.updateState(),null!=S.currentTimer&&m.cancel(S.currentTimer),S.currentTimer=m(S.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},S.updateState=function(){4>=S.iterationIndicator?S.updateStateIni():S.updateStateRub()},S.shared.updateState=S.updateState,S.updateStateIni=function(){S.alumTime={};var y={sesid:S.selectedSes.id,iteration:S.iterationIndicator};"S"==S.selectedSes.type?(l({url:"get-alum-full-state-sel",method:"post",data:y}).success(function(w){for(var D in S.alumState={},S.users)"A"==S.users[D].role&&(S.alumState[D]={});w.forEach(function(D){null==S.alumState[D.uid]?(S.alumState[D.uid]={},S.alumState[D.uid][D.qid]=D.correct):S.alumState[D.uid][D.qid]=D.correct}),3==S.iterationIndicator&&l({url:"get-original-leaders",method:"post",data:{sesid:S.selectedSes.id}}).success(function(D){var x=angular.copy(S.alumState);S.alumState={},S.leaderTeamStr={},S.leaderTeamId={},D.forEach(function(O){S.alumState[O.leader]=x[O.leader],S.leaderTeamStr[O.leader]=O.team.map(function(M){return S.users[M]?S.users[M].name:"- "}).join(", "),S.leaderTeamId[O.leader]=O.id})}),S.shared.alumState=S.alumState}),l({url:"get-alum-state-sel",method:"post",data:y}).success(function(w){var D=w.map(function(x){return x.score/=S.questions.length,x});S.buildBarData(D)}),l({url:"get-alum-confidence",method:"post",data:y}).success(function(w){S.confidence={},w.forEach(function(D){S.confidence[D.qid]||(S.confidence[D.qid]={}),S.confidence[D.qid][D.conf]=D.freq})})):"L"==S.selectedSes.type?(l({url:"get-alum-state-lect",method:"post",data:y}).success(function(w){for(var D in S.alumState={},S.users)"A"==S.users[D].role&&(S.alumState[D]={});w.forEach(function(D){S.alumState[D.uid]=null==S.alumState[D.uid]?D:D}),S.buildBarData(w),S.getAlumDoneTime(y),3==S.iterationIndicator&&l({url:"get-original-leaders",method:"post",data:{sesid:S.selectedSes.id}}).success(function(D){var x=angular.copy(S.alumState);S.alumState={},S.leaderTeamStr={},D.forEach(function(O){S.alumState[O.leader]=x[O.leader],S.leaderTeamStr[O.leader]=O.team.map(function(M){return S.users[M]?S.users[M].name:"- "}).join(", ")})}),S.shared.alumState=S.alumState}),l({url:"get-ideas-progress",method:"post",data:y}).success(function(w){S.numProgress=0,S.numUsers=Object.keys(S.users).length-1;var D=3*S.documents.length;0!=D&&(w.forEach(function(x){S.numProgress+=x.count/D}),S.numProgress*=100/S.numUsers)})):"M"==S.selectedSes.type&&l({url:"get-alum-state-semantic",method:"post",data:y}).success(function(w){for(var D in S.alumState={},S.numUsers=0,S.users)"A"==S.users[D].role&&(S.alumState[D]={},S.numUsers++);w.forEach(function(D){S.alumState[D.uid]=null==S.alumState[D.uid]?D:D}),S.buildBarData(w),S.getAlumDoneTime(y),3==S.iterationIndicator&&l({url:"get-original-leaders",method:"post",data:{sesid:S.selectedSes.id}}).success(function(D){var x=angular.copy(S.alumState);S.alumState={},S.leaderTeamStr={},D.forEach(function(O){S.alumState[O.leader]=x[O.leader],S.leaderTeamStr[O.leader]=O.team.map(function(M){return S.users[M]?S.users[M].name:"- "}).join(", ")})}),S.shared.alumState=S.alumState})},S.avgAlum=function(y){if(null!=S.alumState&&null!=S.alumState[y]){var w=0,D=0;for(var x in S.alumState[y])S.alumState[y][x]&&D++,w++;return 0<w?100*D/w:0}return 0},S.avgPreg=function(y){if(null!=S.alumState){var w=0,D=0;for(var x in S.alumState)null!=S.alumState[x]&&null!=S.alumState[x][y]&&(S.alumState[x][y]&&D++,w++);return 0<w?100*D/w:0}return 0},S.avgAll=function(){var y=0,w=0;if(null!=S.alumState)for(var D in S.alumState)for(var x in S.alumState[D])S.alumState[D][x]&&w++,y++;return 0<y?100*w/y:0},S.progress=function(){var y=0;if(null!=S.alumState){for(var w in S.alumState)for(var D in S.alumState[w])y++;return 100*y/(Object.keys(S.alumState).length*S.questions.length)}return 0},S.progressAlum=function(y){var w=0;if(null!=S.alumState&&null!=S.alumState[y]){for(var D in S.alumState[y])w++;return 100*w/S.questions.length}return 0},S.progressPreg=function(y){var w=0;if(null!=S.alumState){for(var D in S.alumState)null!=S.alumState[D][y]&&w++;return 100*w/Object.keys(S.alumState).length}return 0},S.lectPerformance=function(){var y=0,w=0;if(null!=S.alumState){for(var x in S.alumState){var D=S.alumState[x];y++,w+=D.score}return 100*w/y}return 0},S.getAlumDoneTime=function(y){l({url:"get-alum-done-time",method:"post",data:y}).success(function(w){S.numComplete=0,w.forEach(function(D){S.numComplete+=1,null==S.alumState[D.uid]?S.alumState[D.uid]=D:S.alumState[D.uid].dtime=~~D.dtime})})},S.buildBarData=function(y){var w=5;S.barData[0].values=[];for(var x,D=0;D<w;D++)x=20*D+"% - "+20*(D+1)+"%",S.barData[0].values.push({label:x,value:0});y.forEach(function(D){var x=Math.min(Math.floor(w*D.score),w-1);S.barData[0].values[x].value+=1}),S.barOpts.chart.xAxis.axisLabel=S.flang("performance")},S.updateStateRub=function(){5==S.iterationIndicator?S.computeDif():6==S.iterationIndicator&&S.getAllReportResult()},S.showName=function(y){return y.example?y.title+" - "+S.flang("exampleReport"):y.id+" - "+S.flang("reportOf")+" "+S.users[y.uid].name},S.shared.getReports=function(){var y={sesid:S.selectedSes.id};l({url:"get-report-list",method:"post",data:y}).success(function(w){S.reports=w,S.exampleReports=w.filter(function(D){return D.example})})},S.getReportResult=function(){var y={repid:S.selectedReport.id};l({url:"get-report-result",method:"post",data:y}).success(function(w){S.result=w,S.updateState()})},S.getAllReportResult=function(){var y={sesid:S.selectedSes.id};l({url:"get-report-result-all",method:"post",data:y}).success(function(w){for(var D in S.resultAll={},S.users)"A"==S.users[D].role&&(S.resultAll[D]=[]);w.forEach(function(D){if(null!=D&&0<D.length){var x=S.getReportAuthor(D[0].rid);-1!=x&&null==S.resultAll[x]?S.resultAll[x]=D:-1!=x&&(S.resultAll[x]=D)}}),S.pairArr=w[0]?Array(w[0].length):[],S.buildRubricaBarData(w)})},S.buildRubricaBarData=function(y){var w=3,D=["1 - 2","2 - 3","3 - 4"];S.barData[0].values=[];for(var O,x=0;x<w;x++)O=x+1+" - "+(x+2)+" ("+D[x]+")",S.barData[0].values.push({label:O,value:0});y.forEach(function(x){var O=x.reduce(function(C,T){return C+T.val},0)/x.length,M=Math.min(Math.floor(O-1),w-1);S.barData[0].values[M].value+=1}),S.barOpts.chart.xAxis.axisLabel=S.flang("scoreDist")},S.computeDif=function(){S.result&&function(){var y=S.result.findIndex(function(w){return"P"==S.users[w.uid].role});-1!=y&&function(){var w=S.result[y].val,D=[];S.result.forEach(function(x,O){O!=y&&D.push(Math.abs(w-x.val))}),S.buildRubricaDiffData(D)}()}()},S.buildRubricaDiffData=function(y){console.log("difs",y);var w=5,D=S.flang("high2lowScale").split(",");S.barData[0].values=[];for(var x=0;x<w;x++)S.barData[0].values.push({label:D[x],value:0});y.forEach(function(x){var O=Math.min(Math.floor(2*x),w-1);S.barData[0].values[O].value+=1}),S.barOpts.chart.xAxis.axisLabel=S.flang("correctDistance")},S.getReportAuthor=function(y){if(S.reports){var w=S.reports.find(function(D){return D.id==y});return w?w.uid:-1}return-1},S.getAvg=function(y){if(null==y||0==y.length)return"";var w=y.reduce(function(D,x){return D+x.val},0);return w/y.length},S.getInMax=function(y){if(null==y)return[];var w=0;for(var D in y)w=Math.max(w,y[D].length);return Array(w)},S.showReport=function(y){l({url:"get-report",method:"post",data:{rid:y}}).success(function(D){var x={report:D,criterios:S.shared.obtainCriterios()};x.report.author=S.users[D.uid];var O={repid:D.id};l({url:"get-report-result",method:"post",data:O}).success(function(M){x.answers=M,l.post("get-criteria-selection-by-report",O).success(function(C){x.answersRubrica={},C.forEach(function(T){null==x.answersRubrica[T.uid]&&(x.answersRubrica[T.uid]={}),x.answersRubrica[T.uid][T.cid]=T.selection}),l.post("get-report-evaluators",O).success(function(T){T.forEach(function(R){var E=x.answers.findIndex(function(A){return A.uid==R.uid});-1==E?x.answers.push({uid:R.uid,evaluatorName:S.users[R.uid].name}):x.answers[E].evaluatorName=S.users[R.uid].name}),g.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",size:"lg",scope:S,resolve:{data:function data(){return x}}})})})})})},S.showReportByUid=function(y){console.log(y);var w={uid:y,sesid:S.selectedSes.id};l({url:"get-report-uid",method:"post",data:w}).success(function(D){var x={report:D};x.report.author=S.users[y],g.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:S,resolve:{data:function data(){return x}}})})},S.broadcastReport=function(y){var w={sesid:S.selectedSes.id,rid:y};l({url:"set-eval-report",method:"post",data:w}).success(function(){h.success("Reporte enviado a alumnos")})},S.showDetailAnswer=function(y,w,D){var x=["A","B","C","D","E"],O={uid:w,qid:y,iteration:D},M=S.questions.reduce(function(C,T){return T.id==y?T:C},null);3>D?l({url:"get-selection-comment",method:"post",data:O}).success(function(C){if(null==C||null==C.answer)return void h.warning("No hay respuesta registrada para el alumno");var T=x[C.answer]+". "+M.options[C.answer],R=M.content;g.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:S,resolve:{data:function data(){return C.title=S.flang("answerOf")+" "+S.users[w].name,C.content=S.flang("question")+":\n"+R+"\n\n"+S.flang("answer")+":\n"+T+"\n\n"+S.flang("comment")+":\n"+C.comment?C.comment:"",C.confidence&&(C.content+="\n\n"+S.flang("confidenceLevel")+": "+C.confidence+"%"),C}}})}):(O.tmid=S.leaderTeamId[w],l({url:"get-selection-team-comment",method:"post",data:O}).success(function(C){if(null==C||0==C.length)return void h.warning("No hay respuesta registrada para el grupo");var T=x[C[0].answer]+". "+M.options[C[0].answer],R=M.content;g.open({templateUrl:"templ/content-dialog.html",controller:"ContentModalController",controllerAs:"vm",scope:S,resolve:{data:function data(){var E={};return E.title=S.flang("answerOf")+" "+S.leaderTeamStr[w],E.content=S.flang("question")+":\n"+R+"\n\n"+S.flang("answer")+":\n"+T+"\n\n",C.forEach(function(A){E.content+=S.flang("comment")+" "+A.uname+":\n"+A.comment+"\n",E.confidence&&(E.content+=S.flang("confidenceLevel")+": "+A.confidence+"%\n"),E.content+="\n"}),E}}})}))}}),adpp.controller("MapSelectionModalController",function(o,l){var m=this;m.nav=!0,m.edit=!1,m.cancel=function(){l.dismiss("cancel")},m.resolve=function(){l.close({nav:m.nav,edit:m.edit})}}),adpp.controller("ReportModalController",function(o,l,m){var g=this;g.data=m,g.cancel=function(){l.dismiss("cancel")}}),adpp.controller("ContentModalController",function(o,l,m){var g=this;g.data=m,g.cancel=function(){l.dismiss("cancel")}}),adpp.controller("DuplicateSesModalController",function(o,l,m,g){var h=this;h.data=g,h.nses={name:h.data.name,tipo:h.data.type,descr:h.data.descr,originalSesid:h.data.id,copyDocuments:!1,copyIdeas:!1,copyQuestions:!1,copyRubrica:!1,copyUsers:!1,copySemUnits:!1,copySemDocs:!1},h.cancel=function(){m.dismiss("cancel")},h.sendDuplicate=function(){console.log(h.nses),l({url:"duplicate-session",method:"post",data:h.nses}).success(function(S){console.log(S),window.location.replace("admin")})}}),adpp.controller("GroupController",function(o,l,m){var g=o;g.methods=[],g.lastI=-1,g.lastJ=-1,g.groupMet="random",g.shared.verifyGroups=function(){g.methods=[h("random"),h("performance","homog"),h("performance","heterg"),h("knowledgeType","homog"),h("knowledgeType","heterg")],g.groupNum=3,g.groupMet=g.methods[0],g.groups=[],g.groupNames=[],null!=g.selectedSes&&g.selectedSes.grouped&&(g.groupNum=null,g.groupMet=null,g.generateGroups(!0))};var h=function klg(S,y){return{key:S+(null==y?"":" "+y),name:g.flang(S)+(null==y?"":" "+g.flang(y))}};g.generateGroups=function(S){if(g.selectedSes.grouped)return void l({url:"group-proposal-sel",method:"post",data:{sesid:g.selectedSes.id}}).success(function(D){g.groups=D,console.log(D)});if(null==S&&(1>g.groupNum||g.groupNum>g.users.length))return void m.error("Error en los par\xE1metros de formaci\xF3n de grupos");var y={sesid:g.selectedSes.id,gnum:g.groupNum,method:g.groupMet};console.log(y),console.log(g.shared.alumState);var w=Object.values(g.users).filter(function(D){return"A"==D.role});if(console.log(w),"knowledgeType homog"==g.groupMet||"knowledgeType heterg"==g.groupMet)g.groups=generateTeams(w,habMetric,g.groupNum,isDifferent(g.groupMet));else if("random"==g.groupMet){var D=w.map(function(x){return x.rnd=Math.random(),x});g.groups=generateTeams(D,function(x){return x.rnd},g.groupNum,!1)}else if("S"==g.selectedSes.type||"M"==g.selectedSes.type){var D=[];for(var x in g.shared.alumState){var O=0;for(var M in g.shared.alumState[x])O+=+M;D.push({uid:x,score:O})}g.groups=generateTeams(D,function(x){return x.score},g.groupNum,isDifferent(g.groupMet))}else"L"==g.selectedSes.type&&(g.groups=generateTeams(g.shared.alumState,function(D){return D.score},g.groupNum,isDifferent(g.groupMet)));null!=g.groups&&(g.groupsProp=angular.copy(g.groups),g.groupNames=[])},g.acceptGroups=function(){if(null==g.groupsProp)return void m.error("No hay propuesta de grupos para fijar");var S={sesid:g.selectedSes.id,groups:JSON.stringify(g.groups.map(function(y){return y.map(function(w){return w.uid||w.id})}))};console.log(S),l({url:"set-groups",method:"post",data:S}).success(function(y){"ok"==y.status&&(console.log("Groups accepted"),g.selectedSes.grouped=!0,g.shared.verifyGroups())})},g.swapTable=function(S,y){if(console.log(S,y,g.groups),-1==g.lastI&&-1==g.lastJ)return g.lastI=S,void(g.lastJ=y);if(g.lastI!=S||g.lastJ!=y){var w=angular.copy(g.groupsProp[S][y]);g.groupsProp[S][y]=angular.copy(g.groupsProp[g.lastI][g.lastJ]),g.groupsProp[g.lastI][g.lastJ]=w}g.lastI=-1,g.lastJ=-1}}),adpp.controller("RubricaController",function(o,l){var m=o;m.criterios=[],m.newCriterio={},m.editable=!1,m.exampleReports=[],m.newExampleReport="",m.pairNum=3,m.rid=-1,m.addCriterio=function(){m.criterios.push({})},m.removeCriterio=function(g){m.criterios.splice(g,1)},m.checkSum=function(){return 100==m.criterios.reduce(function(g,h){return g+h.pond},0)},m.shared.getRubrica=function(){m.criterios=[],m.newCriterio={},m.editable=!1;var g={sesid:m.selectedSes.id};l({url:"get-admin-rubrica",method:"post",data:g}).success(function(h){0==h.length?m.editable=!0:(m.criterios=h,m.rid=h[0].rid)})},m.startEditing=function(){m.editable=!0},m.saveRubrica=function(){if(-1!=m.rid)return void m.saveEditRubrica();var g={sesid:m.selectedSes.id};l({url:"send-rubrica",method:"post",data:g}).success(function(h){"ok"==h.status&&function(){var S=h.id;m.criterios.forEach(function(y){var w=angular.copy(y);w.rid=S,l({url:"send-criteria",method:"post",data:w}).success(function(D){"ok"==D.status&&console.log("Ok")})}),m.editable=!1}()})},m.saveEditRubrica=function(){if(-1!=m.rid){var g={rid:m.rid};l({url:"delete-criterias",method:"post",data:g}).success(function(h){"ok"==h.status&&function(){var S=m.rid;m.criterios.forEach(function(y){var w=angular.copy(y);w.rid=S,l({url:"send-criteria",method:"post",data:w}).success(function(D){"ok"==D.status&&console.log("Ok")})}),m.editable=!1}()})}},m.shared.getExampleReports=function(){m.exampleReports=[];var g={sesid:m.selectedSes.id};l({url:"get-example-reports",method:"post",data:g}).success(function(h){m.exampleReports=h})},m.sendExampleReport=function(){var g={sesid:m.selectedSes.id,content:m.newExampleReport.text,title:m.newExampleReport.title};l({url:"send-example-report",method:"post",data:g}).success(function(){m.newExampleReport="",m.shared.getExampleReports()})},m.setActiveExampleReport=function(g){var h={sesid:m.selectedSes.id,rid:g.id};l({url:"set-active-example-report",method:"post",data:h}).success(function(S){"ok"==S.status&&(m.exampleReports.forEach(function(y){y.active=!1}),g.active=!0)})},m.goToReport=function(g){m.setActiveExampleReport(g),window.location.href="to-rubrica?sesid="+m.selectedSes.id},m.pairAssign=function(){var g={sesid:m.selectedSes.id,rnum:+m.pairNum||3};l({url:"assign-pairs",method:"post",data:g}).success(function(h){"ok"==h.status?(m.selectedSes.paired=!0,m.errPairMsg=""):m.errPairMsg=h.msg})},m.shared.obtainCriterios=function(){return m.criterios},m.shared.isRubricaSet=function(){return!m.editable}}),adpp.controller("OptionsController",function(o,l,m){var g=o;g.conf={},g.sesidConfig=-1,g.options=[{name:"optCom",code:"J"},{name:"optConfLv",code:"C"},{name:"optHint",code:"H"}],g.saveConfs=function(){var h={sesid:g.selectedSes.id,options:g.buildConfStr()};l.post("update-ses-options",h).success(function(S){"ok"==S.status&&(m.success("Opciones actualizadas"),g.selectedSes.options=h.options,g.selectedSes.conf=null,g.shared.updateConf())})},g.shared.saveConfs=g.saveConfs,g.shared.updateConf=function(){if(null==g.selectedSes.conf){g.selectedSes.conf={};for(var h=g.selectedSes.options||"",S=0;S<h.length;S++)g.selectedSes.conf[h[S]]=!0;console.log(g.selectedSes)}return!0},g.buildConfStr=function(){var h="";for(var S in g.selectedSes.conf)g.selectedSes.conf[S]&&(h+=S);return h}}),adpp.controller("DashboardRubricaController",function(o){var m=o;m.reports=[],m.result=[],m.selectedReport=null,m.shared.resetRubricaGraphs=function(){m.alumState=null,m.barOpts={chart:{type:"multiBarChart",height:320,x:function x(g){return g.label},y:function y(g){return g.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},m.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},m.shared.resetRubricaGraphs()}),adpp.controller("GeoAdminController",["$scope","$http","NgMap",function(o,l,m){var g=o;g.openRight=!1,g.rightTab="",g.mOverlays=[],g.sOverlays=[],g.selectedOverlay=null,g.overlayBuffer=[];var S=function toOverlay(M){return{id:M.id,name:M.name,description:M.description,color:y(M),type:M.type,fullType:D(M.type),geom:JSON.parse(M.geom)}},y=function getColor(){return"blue"},w=function packOverlay(M){return{name:M.name,description:M.description,iteration:0,qid:null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id,type:M.type,geom:JSON.stringify(M.geom)}},D=function getFullType(M){return"M"===M?"marker":"P"===M?"polygon":"L"===M?"polyline":"R"===M?"rectangle":"C"===M?"circle":"I"===M?"image":void 0};g.shared.processPrevMapData=function(M,C){g.shared.closePrevMapData(),g.shared.processMapData(M,C),g.misc.mapHasVisData=!0,console.log(g.misc)},g.shared.processMapData=function(M,C){g.shared.closePrevMapData();var T=M.split(" ");console.log(T),g.map.setCenter(new google.maps.LatLng(+T[1],+T[2])),g.map.setZoom(+T[3]),g.misc.mapNav="NAV"==T[4],g.misc.mapEdit="EDIT"==T[4]||"EDIT"==T[5],x(C),google.maps.event.trigger(g.map,"resize"),g.misc.mapHasVisData=!1},g.shared.closePrevMapData=function(){g.shared.clearOverlayBuffer(),g.misc.mapHasVisData=!1};var x=function getPrevOverlays(M){l.post("list-default-overlay",{qid:M}).success(function(C){var T=C.map(S);g.mOverlays=g.mOverlays.concat(T.filter(function(R){return"M"==R.type})),g.sOverlays=g.sOverlays.concat(T.filter(function(R){return"M"!=R.type}))})};g.clearOverlay=function(){g.newOverlay={name:"",description:"",color:"blue",type:"M",fullType:"marker",geom:{position:null,radius:null,center:null,path:null,bounds:null}}},g.updateOverlayList=function(){var M={qid:null==g.questions[g.selectedQs]?-1:g.questions[g.selectedQs].id};l.post("list-overlay",M).success(function(C){var T=C.map(S);g.mOverlays=T.filter(function(R){return"M"==R.type}),g.sOverlays=T.filter(function(R){return"M"!=R.type})})},g.shared.updateOverlayList=g.updateOverlayList,g.onMapOverlayCompleted=function(M){g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType=M.type,g.newOverlay.type="polyline"==M.type?"L":M.type[0].toUpperCase(),g.newOverlay.geom.position=M.overlay.getPosition?positionToArray(M.overlay.getPosition()):null,g.newOverlay.geom.radius=M.overlay.radius,g.newOverlay.geom.center=positionToArray(M.overlay.center),g.newOverlay.geom.path=M.overlay.getPath?mutiplePositionToArray(M.overlay.getPath()):null,g.newOverlay.geom.bounds=M.overlay.getBounds?boundsToArray(M.overlay.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2"),M.overlay.setMap(null)},g.colorizeShape=function(M){g.map.shapes&&g.map.shapes.nshp&&(g.map.shapes.nshp.set("fillColor",M),g.map.shapes.nshp.set("strokeColor","dark"+M))},g.closeOverlay=function(){g.clearOverlay(),g.map.infoWindows.iw2.close()};var O=function updateOverlay(){var M="M"==g.newOverlay.type?g.map.markers.nmkr:g.map.shapes.nshp;g.newOverlay.geom.position=M.getPosition?positionToArray(M.getPosition()):null,g.newOverlay.geom.radius=M.radius,g.newOverlay.geom.center=positionToArray(M.center),g.newOverlay.geom.path=M.getPath?mutiplePositionToArray(M.getPath()):null,g.newOverlay.geom.bounds=M.getBounds?boundsToArray(M.getBounds()):null,g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom)};g.sendOverlay=function(){O(),g.overlayBuffer.push(w(g.newOverlay)),console.log(g.overlayBuffer),"M"==g.newOverlay.type?g.mOverlays.push(g.newOverlay):g.sOverlays.push(g.newOverlay),g.closeOverlay()},g.shared.clearOverlayBuffer=function(){g.mOverlays=[],g.sOverlays=[],g.overlayBuffer=[]},g.shared.sendOverlayBuffer=function(M){console.log(M,g.overlayBuffer),g.overlayBuffer.forEach(function(C){C.qid=M,l.post("add-overlay",C).success(function(){console.log("OK")})}),g.shared.closePrevMapData()},g.clickOverlay=function(){g.selectOverlay(this.id)},g.selectOverlay=function(M){g.selectedOverlay=g.mOverlays.find(function(C){return C.id==M})||g.sOverlays.find(function(C){return C.id==M}),g.selectedOverlay.centroid=centroidAsLatLng(g.selectedOverlay.type,g.selectedOverlay.geom),g.map.panTo(g.selectedOverlay.centroid),g.map.showInfoWindow("iw")},g.googleSearch=function(){var M=this.getPlace();null==M||null==M.geometry||null==M.geometry.location||(g.map.mapDrawingManager[0].setDrawingMode(null),g.newOverlay.fullType="marker",g.newOverlay.type="M",g.newOverlay.geom.position=positionToArray(M.geometry.location),g.newOverlay.centroid=centroidAsLatLng(g.newOverlay.type,g.newOverlay.geom),g.map.showInfoWindow("iw2"),g.map.panTo(M.geometry.location))},g.shared.getPluginMapOptions=function(){return{nav:g.misc.mapNav,edit:g.misc.mapEdit}},g.shared.getActiveMap=function(){return g.map},function init(){g.updateOverlayList(),g.clearOverlay(),m.getMap().then(function(M){console.log("MAP cargado correctamente"),g.map=M,g.map.streetView.setOptions({addressControlOptions:{position:google.maps.ControlPosition.TOP_CENTER}}),g.map.infoWindows.iw.close()}),g.misc.mapHasVisData=!1}()}]),adpp.filter("htmlExtractText",function(){return function(o){return o?(o+"").replace(/<[^>]+>/gm,""):""}}),adpp.filter("trustHtml",["$sce",function(o){return function(l){return o.trustAsHtml(l)}}]),adpp.filter("lang",function(){function o(l){if(null!=window.DIC)return window.DIC[l]?window.DIC[l]:(window.warnDIC[l]||(console.warn("Cannot find translation for ",l),window.warnDIC[l]=!0),l)}return o.$stateful=!0,o});var generateTeams=function(o,l,m,g){if(null==m||0==m)return[];console.log(o);var h=o;h.sort(function(x,O){return l(O)-l(x)});for(var S=[],y=o.length/m,x=0;x<y;x++)g?function(){for(var O=[],M=h.length/m,C=0;C<m;C++)O.push(~~(Math.random()*M+M*C));S.push(h.filter(function(C,T){return O.includes(T)})),h=h.filter(function(C,T){return!O.includes(T)})}():(S.push(h.filter(function(O,M){return M<m})),h=h.filter(function(O,M){return M>=m}));for(var w=[],D=0,x=0;x<S.length;x++)1<S[x].length||0==w.length?w.push(S[x]):(w[D%w.length].push(S[x][0]),D++);return w},isDifferent=function(o){return"performance homog"!==o&&(!("performance heterg"!==o)||"knowledgeType homog"!==o&&!("knowledgeType heterg"!==o))},habMetric=function(o){switch(o.aprendizaje){case"Teorico":return-2;case"Reflexivo":return-1;case"Activo":return 1;case"Pragmatico":return 2;}return 0},quillMapHandler=function(){alert("Mapa s\xF3lo disponible para preguntas")},positionToArray=function(o){return null==o?null:[o.lat(),o.lng()]},mutiplePositionToArray=function(o){for(var g,l=[],m=0;m<o.getLength();m++)g=o.getAt(m),l.push(positionToArray(g));return l},boundsToArray=function(o){return[positionToArray(o.getSouthWest()),positionToArray(o.getNorthEast())]},avgCoord=function(o){for(var l=0,m=0,g=0;g<o.length;g++)l+=o[g][0],m+=o[g][1];return[l/o.length,m/o.length]},centroidAsLatLng=function(o,l){var m=centroid(o,l);return new google.maps.LatLng(m[0],m[1])},centroid=function(o,l){return"M"==o?l.position:"C"==o?l.center:"R"==o?avgCoord(l.bounds):"P"==o||"L"==o?avgCoord(l.path):null};
