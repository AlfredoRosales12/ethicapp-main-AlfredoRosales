"use strict";var adpp=angular.module("Admin",["ui.bootstrap","ui.multiselect","nvd3","timer","ui-notification"]),DASHBOARD_AUTOREALOD=!0,DASHBOARD_AUTOREALOD_TIME=15;adpp.controller("AdminController",function(a,b,c,g,h){var l=a;h.NUMBER_FORMATS.GROUP_SEP="",l.shared={},l.sessions=[],l.selectedSes=null,l.documents=[],l.questions=[],l.questionTexts=[],l.newUsers=[],l.users={},l.selectedIndex=-1,l.sesStatusses=["No Publicada","Lectura","Personal","An\xF3nimo","Grupal","Finalizada"],l.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],l.openSidebar=!0,l.init=function(){l.shared.updateSesData()},l.selectSession=function(m){l.selectedIndex=m,l.selectedSes=l.sessions[m],l.requestDocuments(),l.requestQuestions(),l.getNewUsers(),l.getMembers(),l.shared.verifyGroups(),l.shared.resetGraphs(),l.shared.verifyTabs(),l.shared.resetTab(),g.path(l.selectedSes.id)},l.shared.updateSesData=function(){b({url:"get-session-list",method:"post"}).success(function(m){console.log("Session data updated"),l.sessions=m,-1==l.selectedIndex?l.sesFromURL():l.selectSession(l.selectedIndex)})},l.sesFromURL=function(){var m=+g.path().substring(1),o=l.sessions.findIndex(function(q){return q.id==m});-1!=o&&l.selectSession(o)},l.requestDocuments=function(){var m={sesid:l.selectedSes.id};b({url:"documents-session",method:"post",data:m}).success(function(o){l.documents=o})},l.shared.updateDocuments=l.requestDocuments,l.deleteDocument=function(m){b({url:"delete-document",method:"post",data:{docid:m}}).success(function(){l.requestDocuments()})},l.requestQuestions=function(){var m={sesid:l.selectedSes.id};b({url:"questions-session",method:"post",data:m}).success(function(o){l.questions=o.map(function(q){return q.options=q.options.split("\n"),q})}),b({url:"get-question-text",method:"post",data:m}).success(function(o){l.questionTexts=o})},l.getNewUsers=function(){var m={sesid:l.selectedSes.id};b({url:"get-new-users",method:"post",data:m}).success(function(o){l.newUsers=o})},l.getMembers=function(){var m={sesid:l.selectedSes.id};b({url:"get-ses-users",method:"post",data:m}).success(function(o){l.usersArr=o,o.forEach(function(q){l.users[q.id]=q})})},l.openNewSes=function(){c.open({templateUrl:"templ/new-ses.html"})},l.init()}),adpp.controller("TabsController",function(a){var c=a;c.tabOptions=["Descripci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos"],c.selectedTab=0,c.selectedTabConfig=-1,c.shared.resetTab=function(){c.selectedTab=0,null!=c.selectedSes&&1<c.selectedSes.status&&(c.selectedTab=1),c.selectedTabConfig=-1,7==c.selectedSes.status&&c.shared.gotoRubrica()},c.shared.verifyTabs=function(){"L"==c.selectedSes.type?(c.iterationNames=[{name:"Lectura",val:0},{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3},{name:"Reporte",val:4},{name:"Calibraci\xF3n Rubrica",val:5},{name:"Evaluaci\xF3n de Pares",val:6}],c.tabOptions=["Configuraci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos","R\xFAbrica"],c.sesStatusses=["Configuraci\xF3n","Lectura","Individual","An\xF3nimo","Grupal","Reporte","Rubrica Calibraci\xF3n","Evaluaci\xF3n de Pares","Finalizada"],c.shared.getRubrica(),c.shared.getExampleReports(),c.shared.getReports()):(c.iterationNames=[{name:"Individual",val:1},{name:"Grupal an\xF3nimo",val:2},{name:"Grupal",val:3}],c.tabOptions=["Configuraci\xF3n","Dashboard"],c.tabConfig=["Usuarios","Grupos"],c.sesStatusses=["Configuraci\xF3n","Individual","An\xF3nimo","Grupal","Finalizada"]),1<c.selectedSes.status&&(c.selectedTab=1)},c.setTab=function(g){c.selectedTab=g},c.setTabConfig=function(g){c.selectedTabConfig=g},c.shared.gotoGrupos=function(){c.selectedTab=0,c.selectedTabConfig=1},c.shared.gotoRubrica=function(){c.selectedTab=0,c.selectedTabConfig=2}}),adpp.controller("DocumentsController",function(a,b,c){var g=a;g.busy=!1,g.uploadDocument=function(h){g.busy=!0;var l=new FormData(h.target);b.post("upload-file",l,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(m){"ok"==m.status&&(c.success("Documento cargado correctamente"),h.target.reset(),g.busy=!1,g.shared.updateDocuments())})}}),adpp.controller("SesEditorController",function(a,b,c){var g=a;g.updateSession=function(){if(3>g.selectedSes.name.length||5>g.selectedSes.descr.length)return void c.error("Datos de la sesi\xF3n incorrectos o incompletos");var h={name:g.selectedSes.name,descr:g.selectedSes.descr,id:g.selectedSes.id};b({url:"update-session",method:"post",data:h}).success(function(){console.log("Session updated")})},g.shared.changeState=function(){if(g.selectedSes.status>=g.sesStatusses.length)return void c.error("La sesi\xF3n est\xE1 finalizada");if("L"==g.selectedSes.type&&3<=g.selectedSes.status&&!g.selectedSes.grouped||"S"==g.selectedSes.type&&2<=g.selectedSes.status&&!g.selectedSes.grouped)return g.shared.gotoGrupos(),void c.error("Los grupos no han sido generados");if(7<=g.selectedSes.status&&!g.selectedSes.paired)return g.shared.gotoRubrica(),void c.error("Los pares para la evaluaci\xF3n de pares no han sido asignados");var h=window.confirm("\xBFEsta seguro que quiere ir al siguiente estado?");if(h){var l={sesid:g.selectedSes.id};b({url:"change-state-session",method:"post",data:l}).success(function(){g.shared.updateSesData()})}}}),adpp.controller("NewUsersController",function(a,b,c){var g=a;g.addToSession=function(){if(0==g.newMembs.length)return void c.error("No hay usuarios seleccionados para agregar");var l={users:g.newMembs.map(function(m){return m.id}),sesid:g.selectedSes.id};b({url:"add-ses-users",method:"post",data:l}).success(function(m){"ok"==m.status&&(g.getNewUsers(),g.getMembers())})},g.removeUser=function(l){if(1==g.selectedSes.status){var m={uid:l,sesid:g.selectedSes.id};b({url:"delete-ses-user",method:"post",data:m}).success(function(o){"ok"==o.status&&(g.getNewUsers(),g.getMembers())})}}}),adpp.controller("QuestionsController",function(a,b,c){var g=a;g.qsLabels=["A","B","C","D","E"],g.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1},g.newText={title:"",content:""},g.selectAnswer=function(h){g.newQuestion.answer=h},g.addQuestion=function(){if(-1==g.newQuestion.answer)return void c.error("Debe indicar la respuesta correcta a la pregunta");var h={content:g.newQuestion.content,options:g.newQuestion.alternatives.join("\n"),comment:g.newQuestion.comment,answer:g.newQuestion.answer,sesid:g.selectedSes.id,textid:g.newQuestion.textid,other:g.newQuestion.other};b({url:"add-question",method:"post",data:h}).success(function(l){"ok"==l.status&&(g.requestQuestions(),c.success("Pregunta agrgada correctamente"),g.newQuestion={content:"",alternatives:["","","","",""],comment:"",other:"",textid:null,answer:-1})})},g.addQuestionText=function(){var h={sesid:g.selectedSes.id,title:g.newText.title,content:g.newText.content};b({url:"add-question-text",method:"post",data:h}).success(function(l){"ok"==l.status&&(g.requestQuestions(),g.newText={title:"",content:""})})}}),adpp.controller("DashboardController",function(a,b,c,g,h){var l=a;l.iterationIndicator=1,l.currentTimer=null,l.shared.resetGraphs=function(){null!=l.selectedSes&&"L"==l.selectedSes.type?l.iterationIndicator=Math.max(Math.min(6,l.selectedSes.status-2),0):"S"==l.selectedSes.type&&(l.iterationIndicator=Math.max(Math.min(3,l.selectedSes.status-1),1)),l.alumState=null,l.barOpts={chart:{type:"multiBarChart",height:320,x:function x(m){return m.label},y:function y(m){return m.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},l.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}],l.updateState(),9>l.selectedSes.status&&l.reload(!0)},l.reload=function(m){m||l.updateState(),null!=l.currentTimer&&c.cancel(l.currentTimer),l.currentTimer=c(l.reload,1e3*DASHBOARD_AUTOREALOD_TIME)},l.updateState=function(){4>=l.iterationIndicator?l.updateStateIni():l.updateStateRub()},l.updateStateIni=function(){l.alumTime={};var m={sesid:l.selectedSes.id,iteration:l.iterationIndicator};"S"==l.selectedSes.type?(b({url:"get-alum-full-state-sel",method:"post",data:m}).success(function(o){for(var q in l.alumState={},l.users)"A"==l.users[q].role&&(l.alumState[q]={});o.forEach(function(q){null==l.alumState[q.uid]?(l.alumState[q.uid]={},l.alumState[q.uid][q.qid]=q.correct):l.alumState[q.uid][q.qid]=q.correct})}),b({url:"get-alum-state-sel",method:"post",data:m}).success(function(o){var q=o.map(function(t){return t.score/=l.questions.length,t});l.buildBarData(q)})):"L"==l.selectedSes.type&&(b({url:"get-alum-state-lect",method:"post",data:m}).success(function(o){l.alumState=o,l.buildBarData(o),l.getAlumDoneTime(m)}),b({url:"get-ideas-progress",method:"post",data:m}).success(function(o){l.numProgress=0,l.numUsers=Object.keys(l.users).length-1;var q=3*l.documents.length;0!=q&&(o.forEach(function(t){l.numProgress+=t.count/q}),l.numProgress*=100/l.numUsers)}))},l.getAlumDoneTime=function(m){b({url:"get-alum-done-time",method:"post",data:m}).success(function(o){l.numComplete=0,o.forEach(function(q){l.numComplete+=1;var t=l.alumState.findIndex(function(u){return u.uid==q.uid});-1==t?l.alumState.push(q):l.alumState[t].dtime=~~q.dtime})})},l.buildBarData=function(m){var o=5;l.barData[0].values=[];for(var t,q=0;q<o;q++)t=20*q+"% - "+20*(q+1)+"%",l.barData[0].values.push({label:t,value:0});m.forEach(function(q){var t=Math.min(Math.floor(o*q.score),o-1);l.barData[0].values[t].value+=1}),l.barOpts.chart.xAxis.axisLabel="Rendimiento"},l.updateStateRub=function(){5==l.iterationIndicator?l.computeDif():6==l.iterationIndicator&&l.getAllReportResult()},l.showName=function(m){return m.example?m.title+" - Texto ejemplo":m.id+" - Reporte de Alumno "+l.users[m.uid].name},l.shared.getReports=function(){var m={sesid:l.selectedSes.id};b({url:"get-report-list",method:"post",data:m}).success(function(o){l.reports=o,l.exampleReports=o.filter(function(q){return q.example})})},l.getReportResult=function(){var m={repid:l.selectedReport.id};b({url:"get-report-result",method:"post",data:m}).success(function(o){l.result=o,l.updateState()})},l.getAllReportResult=function(){var m={sesid:l.selectedSes.id};b({url:"get-report-result-all",method:"post",data:m}).success(function(o){l.resultAll=o,l.pairArr=o[0]?Array(o[0].length):[],console.log(o),l.buildRubricaBarData(o)})},l.buildRubricaBarData=function(m){var o=3;l.barData[0].values=[];for(var t,q=0;q<o;q++)t=q+1+" - "+(q+2),l.barData[0].values.push({label:t,value:0});m.forEach(function(q){var t=q.reduce(function(w,x){return w+x.val},0)/q.length,u=Math.min(Math.floor(t-1),o-1);l.barData[0].values[u].value+=1}),l.barOpts.chart.xAxis.axisLabel="Puntaje"},l.computeDif=function(){l.result&&function(){var m=l.result.findIndex(function(o){return"P"==l.users[o.uid].role});-1!=m&&function(){var o=l.result[m].val,q=[];l.result.forEach(function(t,u){u!=m&&q.push(Math.abs(o-t.val))}),l.buildRubricaDiffData(q)}()}()},l.buildRubricaDiffData=function(m){console.log("difs",m);var o=6;l.barData[0].values=[];for(var t,q=0;q<o;q++)t=0.5*q+" - "+0.5*(q+1),l.barData[0].values.push({label:t,value:0});m.forEach(function(q){var t=Math.min(Math.floor(2*q),o-1);l.barData[0].values[t].value+=1}),l.barOpts.chart.xAxis.axisLabel="Diferencia de Puntaje"},l.getReportAuthor=function(m){if(l.reports){var o=l.reports.find(function(q){return q.id==m});if(o)return l.users[o.uid]?l.users[o.uid].name:null}},l.getAvg=function(m){if(null==m||0==m.length)return"";var o=m.reduce(function(q,t){return q+t.val},0);return o/m.length},l.getInMax=function(m){if(null==m||0==m.length)return[];var o=m.reduce(function(q,t){return Math.max(q,t.length)},0);return Array(o)},l.showReport=function(m){b({url:"get-report",method:"post",data:{rid:m}}).success(function(q){g.open({templateUrl:"templ/report-details.html",controller:"ReportModalController",controllerAs:"vm",scope:l,resolve:{report:function report(){return q.author=l.users[q.uid],q}}})})},l.broadcastReport=function(m){var o={sesid:l.selectedSes.id,rid:m};b({url:"set-eval-report",method:"post",data:o}).success(function(){h.success("Reporte enviado a alumnos")})}}),adpp.controller("ReportModalController",function(a,b,c){var g=this;g.report=c,g.cancel=function(){b.dismiss("cancel")}}),adpp.controller("GroupController",function(a,b,c){var g=a;g.methods=["Aleatorio","Rendimiento Homogeneo","Rendimiento Heterogeneo","Tipo Aprendizaje Homogeneo","Tipo Aprendizaje Heterogeoneo"],g.lastI=-1,g.lastJ=-1,g.shared.verifyGroups=function(){g.groupNum=3,g.groupMet=g.methods[0],g.groups=[],g.groupNames=[],null!=g.selectedSes&&g.selectedSes.grouped&&(g.groupNum=null,g.groupMet=null,g.generateGroups(!0))},g.generateGroups=function(h){if(null==h&&(1>g.groupNum||g.groupNum>g.users.length))return void c.error("Error en los par\xE1metros de formaci\xF3n de grupos");var l={sesid:g.selectedSes.id,gnum:g.groupNum,method:g.groupMet},m="";"S"==g.selectedSes.type?m="group-proposal-sel":"L"==g.selectedSes.type&&(m="group-proposal-lect"),"Tipo Aprendizaje Homogeneo"==g.groupMet||"Tipo Aprendizaje Heterogeoneo"==g.groupMet?m="group-proposal-hab":"Aleatorio"==g.groupMet&&(m="group-proposal-rand"),""!=m&&b({url:m,method:"post",data:l}).success(function(o){g.groups=o,g.groupsProp=angular.copy(g.groups),console.log(o),g.groupNames=[]})},g.acceptGroups=function(){if(null==g.groupsProp)return void c.error("No hay propuesta de grupos para fijar");var h={sesid:g.selectedSes.id,groups:JSON.stringify(g.groupsProp.map(function(l){return l.map(function(m){return m.uid})}))};console.log(h),b({url:"set-groups",method:"post",data:h}).success(function(l){"ok"==l.status&&(console.log("Groups accepted"),g.selectedSes.grouped=!0,g.shared.verifyGroups())})},g.swapTable=function(h,l){if(console.log(h,l,g.groups),-1==g.lastI&&-1==g.lastJ)return g.lastI=h,void(g.lastJ=l);if(g.lastI!=h||g.lastJ!=l){var m=angular.copy(g.groupsProp[h][l]);g.groupsProp[h][l]=angular.copy(g.groupsProp[g.lastI][g.lastJ]),g.groupsProp[g.lastI][g.lastJ]=m}g.lastI=-1,g.lastJ=-1}}),adpp.controller("RubricaController",function(a,b){var c=a;c.criterios=[],c.newCriterio={},c.editable=!1,c.exampleReports=[],c.newExampleReport="",c.addCriterio=function(){c.criterios.push(c.newCriterio),c.newCriterio={}},c.removeCriterio=function(g){c.criterios.splice(g,1)},c.checkSum=function(){return 100==c.criterios.reduce(function(g,h){return g+h.pond},0)},c.shared.getRubrica=function(){c.criterios=[],c.newCriterio={},c.editable=!1;var g={sesid:c.selectedSes.id};b({url:"get-admin-rubrica",method:"post",data:g}).success(function(h){0==h.length?c.editable=!0:c.criterios=h})},c.saveRubrica=function(){var g={sesid:c.selectedSes.id};b({url:"send-rubrica",method:"post",data:g}).success(function(h){"ok"==h.status&&function(){var l=h.id;c.criterios.forEach(function(m){var o=angular.copy(m);o.rid=l,b({url:"send-criteria",method:"post",data:o}).success(function(q){"ok"==q.status&&console.log("Ok")})}),c.editable=!1}()})},c.shared.getExampleReports=function(){c.exampleReports=[];var g={sesid:c.selectedSes.id};b({url:"get-example-reports",method:"post",data:g}).success(function(h){c.exampleReports=h})},c.sendExampleReport=function(){var g={sesid:c.selectedSes.id,content:c.newExampleReport.text,title:c.newExampleReport.title};b({url:"send-example-report",method:"post",data:g}).success(function(){c.newExampleReport="",c.shared.getExampleReports()})},c.setActiveExampleReport=function(g){var h={sesid:c.selectedSes.id,rid:g.id};b({url:"set-active-example-report",method:"post",data:h}).success(function(l){"ok"==l.status&&(c.exampleReports.forEach(function(m){m.active=!1}),g.active=!0)})},c.goToReport=function(g){c.setActiveExampleReport(g),window.location.href="to-rubrica?sesid="+c.selectedSes.id},c.pairAssign=function(){var g={sesid:c.selectedSes.id,rnum:2};b({url:"assign-pairs",method:"post",data:g}).success(function(h){"ok"==h.status?(c.selectedSes.paired=!0,c.errPairMsg=""):c.errPairMsg=h.msg})}}),adpp.controller("DashboardRubricaController",function(a){var c=a;c.reports=[],c.result=[],c.selectedReport=null,c.shared.resetRubricaGraphs=function(){c.alumState=null,c.barOpts={chart:{type:"multiBarChart",height:320,x:function x(g){return g.label},y:function y(g){return g.value},showControls:!1,showValues:!1,duration:500,xAxis:{showMaxMin:!1},yAxis:{axisLabel:"Cantidad Alumnos"}}},c.barData=[{key:"Alumnos",color:"#ef6c00",values:[]}]},c.shared.resetRubricaGraphs()});
